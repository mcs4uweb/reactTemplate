````text
--- CODE CONTENT EXPORT ---
Generated: 20251109_0855
Source Directory: C:/Projects/vehicleAssetReact/assetmanagement/src
Line Numbers Included: No
Total Files Selected: 35

app/api/generate-description/route.ts
app/api/image-recognition/route.ts
app/askgemini/page.tsx
app/asset-manager-pro/page.tsx
app/blog/page.tsx
app/blog/tire-rotation/page.tsx
app/calender/page.tsx
app/cart/page.tsx
app/dashboard/page.tsx
app/globals.css
app/home/page.tsx
app/homedetail/[id]/page.tsx
app/landing/page.tsx
app/layout.tsx
app/loading.tsx
app/login/page.tsx
app/myorders/page.tsx
app/myordersdetails/[id]/page.tsx
app/page.tsx
app/payment/page.tsx
app/profile/page.tsx
app/settings/page.tsx
components/ProtectedRoute.tsx
components/layout/Layout.tsx
components/layout/Navigation.tsx
contexts/AuthContext.tsx
contexts/CartContext.tsx
hooks/useAuth.tx
hooks/useCart.tx
lib/duckdb.ts
lib/firebase.ts
models/Cart.ts
models/Group.ts
models/User.ts
models/Vehicle.ts

--- START OF FILES ---

********************
********************
********************
********************
********************
=== File Start: app/api/generate-description/route.ts ===
// src/app/api/generate-description/route.ts
import { NextRequest, NextResponse } from 'next/server';

const MODEL_ID = 'gemini-2.5-flash';
const GOOGLE_GENERATIVE_API_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent`;
const MAX_GENERATION_ATTEMPTS = 3;
const INITIAL_RETRY_DELAY_MS = 800;

const wait = (ms: number) =>
  new Promise<void>((resolve) => setTimeout(resolve, ms));

interface GenerateDescriptionRequestBody {
  prompt?: string;
  context?: string;
}

const extractTextFromResponse = (payload: any): string | null => {
  if (!payload) return null;

  if (typeof payload?.text === 'string' && payload.text.trim().length > 0) {
    return payload.text.trim();
  }

  const candidates: any[] = Array.isArray(payload?.candidates)
    ? payload.candidates
    : [];
  for (const candidate of candidates) {
    if (
      typeof candidate?.text === 'string' &&
      candidate.text.trim().length > 0
    ) {
      return candidate.text.trim();
    }

    const parts = candidate?.content?.parts;
    if (!Array.isArray(parts)) continue;

    const textFromParts = parts
      .map((part: any) => {
        if (typeof part?.text === 'string') {
          return part.text;
        }

        if (typeof part?.inlineData?.data === 'string') {
          try {
            const decoded = Buffer.from(
              part.inlineData.data,
              'base64'
            ).toString('utf-8');
            return decoded;
          } catch {
            return '';
          }
        }

        return '';
      })
      .join('')
      .trim();

    if (textFromParts) {
      return textFromParts;
    }
  }

  return null;
};

export async function POST(request: NextRequest) {
  try {
    const body: GenerateDescriptionRequestBody = await request.json();
    const prompt = body.prompt?.trim();

    const clientRetryHeader =
      request.headers.get('x-client-retry') ??
      request.headers.get('x-client-retries') ??
      request.nextUrl.searchParams.get('clientRetry');
    const clientManagesRetries =
      clientRetryHeader === '1' ||
      clientRetryHeader?.toLowerCase() === 'true' ||
      clientRetryHeader === 'yes';
    const maxAttempts = clientManagesRetries
      ? 1
      : MAX_GENERATION_ATTEMPTS;

    if (!prompt) {
      return NextResponse.json(
        { error: 'Prompt text is required to generate a description.' },
        { status: 400 }
      );
    }

    const apiKey = process.env.GOOGLE_GENERATIVE_AI_API_KEY;
    if (!apiKey) {
      return NextResponse.json(
        {
          error:
            'Google Generative AI API key is not configured on the server.',
        },
        { status: 500 }
      );
    }

    const instruction = [
      'You are helping a shopper understand whether a product suits their needs.',
      'Compose a concise yet vivid description that highlights key features, benefits, and ideal use cases.',
      'Avoid speculation beyond the provided details, and keep the tone informative and friendly.',
      'Compare this product with reasonable alternatives when the provided details allow it.',
      'Evaluate the information carefully and keep the description accurate.',
      'Call out price versus quality considerations whenever the prompt includes enough detail.',
    ].join(' ');

    const requestBody = {
      contents: [
        {
          role: 'user',
          parts: [
            {
              text: `${instruction}\n\nProduct details:\n${prompt}`,
            },
          ],
        },
      ],
      generationConfig: {
        temperature: 0.7,
        topK: 40,
        topP: 0.95,
        maxOutputTokens: 1024,
      },
    };

    const allowedFinishReasons = [
      'STOP',
      'FINISH_REASON_UNSPECIFIED',
      'MAX_TOKENS',
    ];
    let generatedText: string | null = null;
    let finishReason: string | undefined;
    let attemptsUsed = 0;

    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
      attemptsUsed = attempt;
      const response = await fetch(
        `${GOOGLE_GENERATIVE_API_ENDPOINT}?key=${apiKey}`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody),
          cache: 'no-store',
        }
      );

      if (!response.ok) {
        const errorPayload = await response.json().catch(() => null);
        const message =
          (errorPayload &&
            (errorPayload.error?.message || JSON.stringify(errorPayload))) ||
          'Google Generative AI request failed.';

        return NextResponse.json(
          {
            error: message,
            attempts: attemptsUsed,
            maxAttempts,
          },
          { status: response.status }
        );
      }

      const resultPayload = await response.json();

      const promptBlockReason =
        resultPayload?.promptFeedback?.blockReason ??
        resultPayload?.promptFeedback?.safetyRatings?.find?.(
          (rating: any) => rating.blocked
        )?.category;
      if (promptBlockReason) {
        return NextResponse.json(
          {
            error: `Google Generative AI blocked this prompt (${promptBlockReason}). Adjust the product description and try again.`,
            attempts: attemptsUsed,
            maxAttempts,
          },
          { status: 400 }
        );
      }

      finishReason = resultPayload?.candidates?.[0]?.finishReason;
      if (finishReason && !allowedFinishReasons.includes(finishReason)) {
        const reasonText =
          resultPayload?.candidates?.[0]?.safetyRatings?.find?.(
            (rating: any) => rating.blocked
          )?.category ?? finishReason;
        return NextResponse.json(
          {
            error: `Google Generative AI could not finish the request (${reasonText}). Please refine the prompt and try again.`,
            attempts: attemptsUsed,
            maxAttempts,
          },
          { status: 400 }
        );
      }

      generatedText = extractTextFromResponse(resultPayload);
      if (generatedText) {
        break;
      }

      if (attempt < maxAttempts) {
        const delay = INITIAL_RETRY_DELAY_MS * attempt;
        await wait(delay);
      }
    }

    if (!generatedText) {
      return NextResponse.json(
        {
          error:
            'The AI response did not include any content after multiple attempts.',
          attempts: attemptsUsed,
          maxAttempts,
        },
        { status: 502 }
      );
    }

    const responseBody: {
      result: string;
      partial?: boolean;
      attempts: number;
      maxAttempts: number;
    } = {
      result: generatedText,
      attempts: attemptsUsed,
      maxAttempts,
    };

    if (finishReason === 'MAX_TOKENS') {
      responseBody.partial = true;
    }

    return NextResponse.json(responseBody);
  } catch (error) {
    console.error('generate-description API error:', error);
    return NextResponse.json(
      { error: 'Unexpected server error while generating description.' },
      { status: 500 }
    );
  }
}
=== File End: app/api/generate-description/route.ts ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/api/image-recognition/route.ts ===
'use server';

import { NextRequest, NextResponse } from 'next/server';

const DEFAULT_OLLAMA_URL = 'http://127.0.0.1:11434';
const DEFAULT_VISION_MODEL = 'mistral:latest';

interface ImageRecognitionRequestBody {
  prompt?: string;
  imageBase64?: string;
  imageUrl?: string;
}

const fetchImageAsBase64 = async (imageUrl: string) => {
  const response = await fetch(imageUrl);
  if (!response.ok) {
    throw new Error(
      `Failed to download image (${response.status} ${response.statusText})`
    );
  }

  const arrayBuffer = await response.arrayBuffer();
  const base64 = Buffer.from(arrayBuffer).toString('base64');
  return base64;
};

const normalizeBase64 = (input: string) => {
  if (!input) {
    return null;
  }

  const trimmed = input.trim();
  if (!trimmed) {
    return null;
  }

  const commaIndex = trimmed.indexOf(',');
  if (trimmed.startsWith('data:') && commaIndex !== -1) {
    return trimmed.slice(commaIndex + 1);
  }

  return trimmed;
};

export async function POST(request: NextRequest) {
  try {
    const body: ImageRecognitionRequestBody = await request.json();
    const prompt =
      body.prompt?.trim() ||
      'Describe the contents of this asset image and identify notable details relevant to asset management.';

    let base64Image = normalizeBase64(body.imageBase64 ?? '');

    if (!base64Image && body.imageUrl) {
      base64Image = await fetchImageAsBase64(body.imageUrl);
    }

    if (!base64Image) {
      return NextResponse.json(
        { error: 'An image (base64 or accessible URL) is required.' },
        { status: 400 }
      );
    }

    const apiUrl = process.env.OLLAMA_BASE_URL?.trim() || DEFAULT_OLLAMA_URL;
    const model =
      process.env.OLLAMA_VISION_MODEL?.trim() || DEFAULT_VISION_MODEL;

    const ollamaResponse = await fetch(`${apiUrl}/api/generate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model,
        prompt,
        images: [base64Image],
        stream: false,
      }),
    });

    if (!ollamaResponse.ok) {
      let errorPayload: unknown = null;
      try {
        errorPayload = await ollamaResponse.json();
      } catch {
        // ignore JSON parse errors
      }

      return NextResponse.json(
        {
          error:
            (errorPayload as any)?.error ||
            `Ollama request failed (${ollamaResponse.status} ${ollamaResponse.statusText}).`,
          status: ollamaResponse.status,
        },
        { status: ollamaResponse.status }
      );
    }

    const payload = await ollamaResponse.json();
    const textResponse: string | null =
      typeof payload?.response === 'string'
        ? payload.response.trim()
        : Array.isArray(payload?.message?.content)
        ? payload.message.content
            .map((part: any) =>
              typeof part?.text === 'string' ? part.text : ''
            )
            .join('')
            .trim()
        : null;

    if (!textResponse) {
      return NextResponse.json(
        {
          error:
            'Ollama did not return any textual response for this image analysis.',
        },
        { status: 502 }
      );
    }

    return NextResponse.json({
      result: textResponse,
      model,
    });
  } catch (error) {
    console.error('image-recognition API error:', error);
    const apiUrl = process.env.OLLAMA_BASE_URL?.trim() || DEFAULT_OLLAMA_URL;
    const model =
      process.env.OLLAMA_VISION_MODEL?.trim() || DEFAULT_VISION_MODEL;

    const isFetchFailed =
      error instanceof Error && error.message.toLowerCase().includes('fetch');

    const message =
      error instanceof Error
        ? error.message
        : 'Unexpected server error while contacting Ollama.';

    return NextResponse.json(
      {
        error: isFetchFailed
          ? `Unable to reach Ollama at ${apiUrl}. Ensure the server is running and the ${model} model is available. (${message})`
          : message,
      },
      { status: 500 }
    );
  }
}
=== File End: app/api/image-recognition/route.ts ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/askgemini/page.tsx ===
// src/app/askgemini/page.tsx
'use client';

import React, { useState, useRef, useEffect } from 'react';

function arrayBufferToBase64(buffer: ArrayBuffer): string {
  let binary = '';
  const bytes = new Uint8Array(buffer);
  for (let i = 0; i < bytes.byteLength; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return typeof btoa === 'function' ? btoa(binary) : '';
}

export default function AskGeminiPage() {
  const [status, setStatus] = useState<string>('Click "Start Recording" to begin the audio capture.');
  const [isRecording, setIsRecording] = useState<boolean>(false);
  const [isAnalyzing, setIsAnalyzing] = useState<boolean>(false);
  const [transcription, setTranscription] = useState<string>('Your transcription will appear here after analysis.');
  const [audioUrl, setAudioUrl] = useState<string | null>(null);
  const [base64Preview, setBase64Preview] = useState<string>('');

  const mediaRecorderRef = useRef<MediaRecorder | null>(null);
  const audioChunksRef = useRef<Blob[]>([]);
  const streamRef = useRef<MediaStream | null>(null);

  // If you want to expose the key to client, set NEXT_PUBLIC_GOOGLE_GENERATIVE_AI_API_KEY in .env.local
  // Prefer proxying via an API route to avoid exposing secrets.
  const GEMINI_API_KEY = process.env.NEXT_PUBLIC_GOOGLE_GENERATIVE_AI_API_KEY || 'YOUR_API_KEY';

  const startRecording = async (): Promise<void> => {
    try {
      if (!navigator?.mediaDevices?.getUserMedia) {
        setStatus('Error: getUserMedia is not supported in this browser.');
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      streamRef.current = stream;

      const audioTrack = stream.getAudioTracks()[0];
      const deviceName = audioTrack?.label || 'Default Microphone';

      audioChunksRef.current = [];
      const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
      mediaRecorderRef.current = mediaRecorder;

      mediaRecorder.ondataavailable = (e: BlobEvent) => {
        if (e.data) audioChunksRef.current.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        stream.getTracks().forEach((track) => track.stop());

        const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
        const url = URL.createObjectURL(audioBlob);
        setAudioUrl(url);

        const reader = new FileReader();
        reader.onloadend = async () => {
          const result = reader.result;
          if (!(result instanceof ArrayBuffer)) return;
          const base64 = arrayBufferToBase64(result);
          setBase64Preview(`${base64.substring(0, 100)}... (Total length: ${base64.length})`);
          await analyzeAudio(base64, 'audio/webm');
        };
        reader.readAsArrayBuffer(audioBlob);
      };

      mediaRecorder.start();
      setIsRecording(true);
      setStatus(`üî¥ Recording started using: ${deviceName}. Say something now!`);
      setTranscription('Recording in progress...');
    } catch (err: unknown) {
      console.error('Mic access error:', err);
      const name = err && typeof err === 'object' && 'name' in err ? (err as any).name : 'UnknownError';
      setStatus(`Error: Could not access microphone. (${name})`);
      setIsRecording(false);
    }
  };

  const stopRecording = (): void => {
    if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
      mediaRecorderRef.current.stop();
      setIsRecording(false);
      setStatus('Recording finished. Preparing for analysis...');
      setIsAnalyzing(true);
      setTranscription('');
    }
  };

  const analyzeAudio = async (base64Audio: string, mimeType: string): Promise<void> => {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
    const prompt = 'Transcribe the following audio recording and summarize its content in one sentence.';

    const payload = {
      contents: [
        {
          role: 'user',
          parts: [
            { text: prompt },
            { inlineData: { mimeType, data: base64Audio } },
          ],
        },
      ],
    } as const;

    const maxRetries = 3;
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        const text: string =
          data?.candidates?.[0]?.content?.parts?.[0]?.text || 'Analysis failed to produce text.';
        setTranscription(text);
        setStatus('Analysis Complete! Check the output below.');
        setIsAnalyzing(false);
        return;
      } catch (err: any) {
        console.error(`Attempt ${attempt} failed:`, err);
        if (attempt === maxRetries) {
          setTranscription(`Error: Failed after ${maxRetries} attempts. (${err?.message || 'Unknown error'})`);
          setStatus('Error during analysis.');
          setIsAnalyzing(false);
        } else {
          await new Promise((resolve) => setTimeout(resolve, Math.pow(2, attempt) * 1000));
        }
      }
    }
  };

  useEffect(() => {
    return () => {
      if (streamRef.current) {
        streamRef.current.getTracks().forEach((track) => track.stop());
      }
      if (audioUrl) {
        URL.revokeObjectURL(audioUrl);
      }
    };
  }, [audioUrl]);

  return (
    <div className="p-4 sm:p-8 flex justify-center min-h-screen bg-gray-100">
      <div className="w-full max-w-3xl">
        <header className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-800">üé§ Ask AI</h1>
          <p className="text-gray-600 mt-2">
            Record your voice, and transcribe it. And Magic
          </p>
        </header>

        <div className="bg-white p-6 rounded-xl shadow space-y-6">
          {/* Step 1: Record */}
          <div className="space-y-4">
            <h2 className="text-xl font-semibold text-blue-600 border-b pb-2">1. Record Audio</h2>
            <div
              className={`p-3 rounded-lg text-sm ${
                status.includes('Error')
                  ? 'bg-red-200 text-red-800'
                  : status.includes('Recording')
                  ? 'bg-yellow-200'
                  : 'bg-gray-100 text-gray-700'
              }`}
            >
              {status}
            </div>
            <div className="flex flex-col sm:flex-row gap-4">
              <button
                onClick={startRecording}
                disabled={isRecording}
                className={`flex-1 font-semibold py-3 px-6 rounded-lg transition ${
                  isRecording
                    ? 'bg-red-500 text-white pulsing'
                    : 'bg-green-500 text-white hover:bg-green-600 disabled:opacity-50'
                }`}
              >
                {isRecording ? 'üî¥ Recording...' : 'Start Recording'}
              </button>
              <button
                onClick={stopRecording}
                disabled={!isRecording}
                className="flex-1 bg-red-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-red-600 disabled:opacity-50"
              >
                Stop &amp; Analyze
              </button>
            </div>
          </div>

          {/* Step 2: Output */}
          <div className="space-y-4">
            <h2 className="text-xl font-semibold text-blue-600 border-b pb-2">2. LLM Analysis Output (Transcription)</h2>
            {isAnalyzing ? (
              <div className="text-center p-8">
                <div className="w-10 h-10 border-4 border-t-4 border-t-blue-500 border-gray-200 rounded-full animate-spin mx-auto"></div>
                <p className="mt-3 text-blue-600">Analyzing audio with Gemini...</p>
              </div>
            ) : (
              <div className="bg-gray-50 p-4 rounded-lg min-h-[100px]">
                <p className="text-gray-500">{transcription}</p>
              </div>
            )}
          </div>

          {/* Step 3: Debug */}
          <div className="space-y-4">
            <h2 className="text-xl font-semibold text-blue-600 border-b pb-2">3. Playback / Debug</h2>
            {audioUrl && <audio src={audioUrl} controls className="w-full" />}
            {base64Preview && (
              <textarea
                readOnly
                value={base64Preview}
                rows={3}
                className="w-full p-2 border border-gray-300 rounded-lg text-sm bg-gray-100"
                placeholder="Base64 audio data will appear here."
              />
            )}
          </div>
        </div>
      </div>

      {/* Tailwind & Custom Styles */}
      <style jsx>{`
        body {
          font-family: 'Inter', sans-serif;
        }
        .pulsing {
          animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
          from { transform: scale(1); opacity: 1; }
          to { transform: scale(1.05); opacity: 0.7; }
        }
      `}</style>
    </div>
  );
}
=== File End: app/askgemini/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/asset-manager-pro/page.tsx ===
'use client';

import React, { useEffect, useRef, useState } from 'react';
import { useRouter } from 'next/navigation';
import Layout from '../../components/layout/Layout';
import { useAuth } from '../../contexts/AuthContext';
import { storage } from '../../lib/firebase';
import {
  getDownloadURL,
  ref as storageRef,
  uploadBytesResumable,
} from 'firebase/storage';

const AssetManagerProPage: React.FC = () => {
  const router = useRouter();
  const { currentUser, loading } = useAuth();
  const [showProActions, setShowProActions] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const fileInputRef = useRef<HTMLInputElement | null>(null);
  const [uploading, setUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState<number | null>(null);
  const [uploadError, setUploadError] = useState<string | null>(null);
  const [uploadedUrl, setUploadedUrl] = useState<string | null>(null);
  const [analysisStatus, setAnalysisStatus] = useState<
    'idle' | 'loading' | 'success' | 'error'
  >('idle');
  const [analysisResult, setAnalysisResult] = useState<string | null>(null);
  const [analysisError, setAnalysisError] = useState<string | null>(null);

  useEffect(() => {
    if (!loading && !currentUser) {
      router.replace('/login');
    }
  }, [loading, currentUser, router]);

  if (loading || !currentUser) {
    return (
      <Layout>
        <div className='flex min-h-screen items-center justify-center bg-gray-100'>
          <div className='text-center'>
            <div className='mx-auto h-12 w-12 animate-spin rounded-full border-b-2 border-blue-600' />
            <p className='mt-4 text-gray-600'>Preparing your pro workspace...</p>
          </div>
        </div>
      </Layout>
    );
  }

  const handleUploadClick = () => {
    fileInputRef.current?.click();
  };

  const readFileAsBase64 = (file: File) =>
    new Promise<string>((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const result = reader.result;
        if (typeof result !== 'string') {
          reject(new Error('Unexpected file reader result.'));
          return;
        }

        const commaIndex = result.indexOf(',');
        if (commaIndex !== -1) {
          resolve(result.slice(commaIndex + 1));
        } else {
          resolve(result);
        }
      };
      reader.onerror = () => reject(reader.error || new Error('File read failed.'));
      reader.readAsDataURL(file);
    });

  const analyzeImage = async (base64Image: string) => {
    setAnalysisStatus('loading');
    setAnalysisError(null);
    setAnalysisResult(null);

    try {
      const response = await fetch('/api/image-recognition', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          imageBase64: base64Image,
          prompt:
            'Provide a concise, bullet-friendly summary of this asset image. Call out asset type, notable physical attributes, serial numbers, labels, and anything relevant for cataloging or maintenance follow-up.',
        }),
      });

      if (!response.ok) {
        let errorText = 'Image recognition request failed.';
        try {
          const payload = await response.json();
          if (typeof payload?.error === 'string') {
            errorText = payload.error;
          }
        } catch {
          // ignore JSON parse error
        }
        throw new Error(errorText);
      }

      const payload = await response.json();
      if (typeof payload?.result === 'string' && payload.result.trim()) {
        setAnalysisResult(payload.result.trim());
        setAnalysisStatus('success');
      } else {
        throw new Error('The AI response did not include any details.');
      }
    } catch (error) {
      console.error('Image recognition failed:', error);
      setAnalysisStatus('error');
      const errorMessage =
        error instanceof Error ? error.message : null;
      const isFetchFailure =
        typeof errorMessage === 'string' &&
        errorMessage.toLowerCase().includes('fetch');
      setAnalysisError(
        isFetchFailure
          ? 'Unable to reach the AI analysis service. Confirm your Ollama server is running and accessible.'
          : errorMessage || 'Unable to analyze the image at this time.'
      );
    }
  };

  const handleFileChange = async (
    event: React.ChangeEvent<HTMLInputElement>
  ) => {
    const file = event.target.files?.[0];
    if (!file) {
      return;
    }

    if (!currentUser?.UserId) {
      setUploadError('Authentication required to upload photos.');
      event.target.value = '';
      return;
    }

    setUploading(true);
    setUploadProgress(0);
    setUploadError(null);
    setUploadedUrl(null);
    setAnalysisStatus('idle');
    setAnalysisResult(null);
    setAnalysisError(null);

    try {
      const base64Image = await readFileAsBase64(file);
      void analyzeImage(base64Image);
    } catch (error) {
      console.error('Unable to prepare file for analysis:', error);
      setAnalysisStatus('error');
      setAnalysisError(
        'We could not prepare this file for AI analysis, but the upload will continue.'
      );
    }

    const fileName = `${Date.now()}-${file.name.replace(/\s+/g, '-')}`;
    const uploadRef = storageRef(
      storage,
      `asset-uploads/${currentUser.UserId}/${fileName}`
    );
    const uploadTask = uploadBytesResumable(uploadRef, file);

    uploadTask.on(
      'state_changed',
      (snapshot) => {
        const progress =
          (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        setUploadProgress(Math.round(progress));
      },
      (error) => {
        console.error('Photo upload failed:', error);
        setUploadError('Failed to upload photo. Please try again.');
        setUploading(false);
        setUploadProgress(null);
      },
      async () => {
        try {
          const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
          setUploadedUrl(downloadURL);
        } catch (error) {
          console.error('Unable to retrieve uploaded photo URL:', error);
          setUploadError('Uploaded, but unable to fetch the download link.');
        } finally {
          setUploading(false);
          setUploadProgress(null);
          setAnalysisStatus((status) =>
            status === 'idle' ? 'success' : status
          );
        }
      }
    );

    event.target.value = '';
  };

  return (
    <Layout>
      <div className='mx-auto max-w-4xl px-4 py-10'>
        <header className='mb-8 space-y-4'>
          <div className='flex flex-col gap-4 md:flex-row md:items-center md:justify-between'>
            <h1 className='text-3xl font-bold text-gray-900'>
              Asset Manager tracker With AI
            </h1>
            <div className='flex flex-col gap-2 sm:flex-row sm:items-center'>
              <button
                type='button'
                onClick={() => setShowProActions((prev) => !prev)}
                className='rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700'
              >
                PRO User
              </button>
              <button
                type='button'
                onClick={handleUploadClick}
                disabled={uploading}
                className={`rounded-md border border-blue-600 px-4 py-2 text-sm font-semibold transition ${
                  uploading
                    ? 'cursor-not-allowed bg-blue-100 text-blue-400'
                    : 'text-blue-600 hover:bg-blue-50'
                }`}
              >
                {uploading ? 'Uploading...' : 'Upload Photo'}
              </button>
              <input
                ref={fileInputRef}
                type='file'
                accept='image/*'
                onChange={handleFileChange}
                className='hidden'
              />
            </div>
          </div>
          {(uploading || uploadError || uploadedUrl) && (
            <div className='rounded-md border border-blue-100 bg-blue-50 p-4 text-sm text-blue-700'>
              {uploading && (
                <p>
                  Uploading photo{typeof uploadProgress === 'number'
                    ? ` (${uploadProgress}%)`
                    : '...'}
                </p>
              )}
              {!uploading && uploadError && (
                <p className='text-red-600'>{uploadError}</p>
              )}
              {!uploading && uploadedUrl && (
                <p>
                  Upload complete.{' '}
                  <a
                    href={uploadedUrl}
                    target='_blank'
                    rel='noreferrer'
                    className='font-semibold text-blue-600 underline'
                  >
                    View asset photo
                  </a>
                </p>
              )}
            </div>
          )}
          {(analysisStatus !== 'idle' || analysisError || analysisResult) && (
            <div className='rounded-md border border-purple-100 bg-purple-50 p-4 text-sm text-purple-800'>
              {analysisStatus === 'loading' && (
                <p>Analyzing your asset photo with AI...</p>
              )}
              {analysisStatus === 'error' && analysisError && (
                <p className='text-red-600'>{analysisError}</p>
              )}
              {analysisStatus === 'success' && analysisResult && (
                <div>
                  <p className='font-semibold'>AI Insight</p>
                  <p className='mt-2 whitespace-pre-line text-purple-900'>
                    {analysisResult}
                  </p>
                </div>
              )}
            </div>
          )}
          {showProActions && (
            <div>
              <button
                type='button'
                onClick={() => setIsModalOpen(true)}
                className='rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-indigo-700'
              >
                Go Pro
              </button>
            </div>
          )}
        </header>

        <section className='rounded-lg border border-dashed border-gray-300 bg-white p-8 text-gray-700 shadow-sm'>
          <p>
            Manage your assets smarter with AI-assisted workflows tailored for
            professional users. Track uploads, automate insights, and keep every
            detail at your fingertips.
          </p>
        </section>
      </div>

      {isModalOpen && (
        <div className='fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 px-4'>
          <div className='w-full max-w-lg rounded-lg bg-white p-8 shadow-xl'>
            <div className='mb-6 text-center'>
              <h2 className='text-2xl font-bold text-gray-900'>
                Unlock Pro Features
              </h2>
              <p className='mt-3 text-gray-600'>
                Go Pro to leverage the full power of AI for ultimate asset
                management efficiency.
              </p>
            </div>
            <ul className='space-y-3 text-gray-700'>
              <li>
                <strong>AI Auto-Tagging</strong> from images/receipts.
              </li>
              <li>
                <strong>Proactive Maintenance</strong> schedules.
              </li>
              <li>
                <strong>Financial Depreciation</strong> narrative reports.
              </li>
            </ul>
            <div className='mt-8 flex flex-col-reverse gap-3 sm:flex-row sm:justify-end'>
              <button
                type='button'
                onClick={() => setIsModalOpen(false)}
                className='rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100'
              >
                Not Now
              </button>
              <button
                type='button'
                className='rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-blue-700'
              >
                Upgrade to Pro Now!
              </button>
            </div>
          </div>
        </div>
      )}
    </Layout>
  );
};

export default AssetManagerProPage;
=== File End: app/asset-manager-pro/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/blog/page.tsx ===
// src/app/blog/page.tsx
// Server component: fetches Motor1 RSS and renders a table

import Link from 'next/link';
import Layout from '../../components/layout/Layout';

interface ArticleMeta {
  slug: string;
  title: string;
  summary: string;
}

const articles: ArticleMeta[] = [
  {
    slug: 'tire-rotation',
    title: 'Tire Rotation: How Often Should You Rotate Your Tires?',
    summary:
      'Most vehicles: every 5,000-7,500 miles. AWD and severe driving may require more frequent rotation.',
  },
];

interface RSSItem {
  title: string;
  link: string;
}

async function fetchMotor1RSS(): Promise<RSSItem[]> {
  try {
    const res = await fetch('https://www.motor1.com/rss/news/all', {
      // Cache for an hour on the server to avoid rate limits
      next: { revalidate: 3600 },
    });
    if (!res.ok) return [];
    const xml = await res.text();

    // Simple RSS parsing for <item><title> and <link>
    const items: RSSItem[] = [];
    const parts = xml.split('<item>').slice(1); // skip header before first item
    for (const part of parts) {
      const endIdx = part.indexOf('</item>');
      const block = endIdx >= 0 ? part.substring(0, endIdx) : part;

      const titleMatch = block.match(/<title>([\s\S]*?)<\/title>/i);
      const linkMatch = block.match(/<link>([\s\S]*?)<\/link>/i);

      const rawTitle = titleMatch ? titleMatch[1] : '';
      const title = rawTitle.replace(/<!\[CDATA\[/g, '').replace(/\]\]>/g, '').trim();
      const link = linkMatch ? linkMatch[1].trim() : '';

      if (title && link) {
        items.push({ title, link });
      }
    }
    return items;
  } catch {
    return [];
  }
}

export default async function BlogIndexPage() {
  const rssItems = await fetchMotor1RSS();
  return (
    <Layout>
      <div className='min-h-screen bg-gray-100'>
        <header className='bg-white shadow'>
          <div className='mx-auto max-w-7xl px-4 py-4'>
            <div className='flex items-center justify-between'>
              <div>
                <h1 className='text-2xl font-bold text-blue-600'>Blog</h1>
                <p className='text-sm text-gray-600'>Reference articles and guides for better asset care.</p>
              </div>
              <Link
                href='/'
                className='inline-flex items-center rounded-md border border-blue-600 px-3 py-1.5 text-sm font-medium text-blue-600 hover:bg-blue-50'
              >
                Go to Home
              </Link>
            </div>
          </div>
        </header>

        <main className='mx-auto max-w-7xl px-4 py-6'>
          <section className='mb-8'>
            <h2 className='mb-3 text-xl font-semibold text-gray-900'>Latest News from Motor1</h2>
            <div className='overflow-x-auto rounded-lg border border-gray-200 bg-white shadow-sm'>
              <table className='min-w-full table-auto divide-y divide-gray-200'>
                <thead className='bg-gray-50'>
                  <tr>
                    <th scope='col' className='px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500'>
                      Title
                    </th>
                    <th scope='col' className='px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500'>
                      Link
                    </th>
                  </tr>
                </thead>
                <tbody className='divide-y divide-gray-200'>
                  {rssItems.length === 0 ? (
                    <tr>
                      <td colSpan={2} className='px-4 py-3 text-sm text-gray-600'>
                        Unable to load Motor1 RSS feed right now.
                      </td>
                    </tr>
                  ) : (
                    rssItems.slice(0, 20).map((item, idx) => (
                      <tr key={`${item.link}-${idx}`} className='hover:bg-gray-50'>
                        <td className='px-4 py-2 text-sm text-gray-900'>{item.title}</td>
                        <td className='px-4 py-2 text-sm'>
                          <a href={item.link} target='_blank' rel='noopener noreferrer' className='text-blue-600 hover:text-blue-700'>
                            Open Article
                          </a>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </section>
          <ul className='grid grid-cols-1 gap-4 md:grid-cols-2'>
            {articles.map((a) => (
              <li key={a.slug} className='rounded-lg border border-gray-200 bg-white p-4 shadow-sm'>
                <h2 className='text-lg font-semibold text-gray-900'>
                  <Link href={`/blog/${a.slug}`} className='text-blue-600 hover:text-blue-700'>
                    {a.title}
                  </Link>
                </h2>
                <p className='mt-2 text-sm text-gray-600'>{a.summary}</p>
                <div className='mt-3'>
                  <Link
                    href={`/blog/${a.slug}`}
                    className='inline-flex items-center rounded-md bg-blue-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-blue-700'
                  >
                    Read Article
                  </Link>
                </div>
              </li>
            ))}
          </ul>
        </main>
      </div>
    </Layout>
  );
}
=== File End: app/blog/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/blog/tire-rotation/page.tsx ===
// src/app/blog/tire-rotation/page.tsx
'use client';

import Link from 'next/link';
import Layout from '../../../components/layout/Layout';

export default function TireRotationArticle() {
  return (
    <Layout>
      <div className='min-h-screen bg-gray-100'>
        <header className='bg-white shadow'>
          <div className='mx-auto max-w-3xl px-4 py-4'>
            <p className='text-xs uppercase tracking-wide text-gray-400'>Blog</p>
            <h1 className='mt-1 text-2xl font-bold text-blue-600'>Tire Rotation: How Often Should You Rotate Your Tires?</h1>
            <p className='mt-1 text-sm text-gray-500'>Reference guide for when to rotate your tires</p>
          </div>
        </header>

        <main className='mx-auto max-w-3xl px-4 py-6'>
          <article className='prose prose-blue max-w-none dark:prose-invert'>
            <p>
              As a general rule, most vehicles should have their tires rotated every
              <strong> 5,000 to 7,500 miles</strong>.
            </p>

            <h2>Important Details and Exceptions</h2>
            <ul>
              <li>
                <strong>The Best Source:</strong> The most accurate recommendation for your specific
                vehicle is always in your owner&apos;s manual. Manufacturer guidelines can vary.
              </li>
              <li>
                <strong>Practical Timing:</strong> Many people find it convenient to have their tires
                rotated at the same time as their oil change, which often falls within this 5,000- to
                7,500-mile window.
              </li>
              <li>
                <strong>All-Wheel Drive (AWD) Exception:</strong> Vehicles with All-Wheel Drive often
                require more frequent rotation. The common recommendation for AWD vehicles is typically
                every <strong>3,000 to 5,000 miles</strong> to prevent uneven wear and potential strain on the drivetrain.
              </li>
              <li>
                <strong>Driving Habits:</strong> If you frequently drive at high speeds, carry heavy loads,
                or drive on rough roads, you may need to rotate your tires more often.
              </li>
            </ul>

            <p>
              Regular tire rotation is important because it helps ensure your tires wear evenly, which
              extends their lifespan, improves safety, and provides better traction and handling.
            </p>
          </article>

          <div className='mt-8 flex items-center justify-between'>
            <Link href='/blog' className='text-sm font-medium text-blue-600 hover:text-blue-700'>
              ‚Üê Back to Blog
            </Link>
            <Link href='/' className='text-sm font-medium text-blue-600 hover:text-blue-700'>
              Go to Home ‚Üí
            </Link>
          </div>

          <section className='mt-8 rounded-lg border border-gray-200 bg-white p-4 shadow-sm'>
            <div className='mb-2 flex items-center justify-between'>
              <h2 className='text-base font-semibold text-gray-900'>Discussion</h2>
              <span className='text-xs text-gray-500'>Coming soon</span>
            </div>
            <p className='text-sm text-gray-600'>We&apos;ll add user discussion for this article here.</p>
          </section>
        </main>
      </div>
    </Layout>
  );
}
=== File End: app/blog/tire-rotation/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/calender/page.tsx ===
'use client';

import React, { useEffect, useMemo, useState } from 'react';
import Layout from '../../components/layout/Layout';
import { useAuth } from '../../contexts/AuthContext';
import { useRouter } from 'next/navigation';
import {
  onValue,
  push,
  ref as dbRef,
  remove,
  set,
  update,
} from 'firebase/database';
import { db } from '../../lib/firebase';

type CalEvent = {
  id: string;
  title: string;
  start: string; // YYYY-MM-DD
  end?: string; // YYYY-MM-DD (inclusive)
  notes?: string;
};

const weekdayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

const toYmd = (d: Date): string => {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${dd}`;
};

// Normalize to noon local time to avoid DST/UTC off-by-one when comparing dates
const toNoon = (ymd: string): Date => new Date(`${ymd}T12:00:00`);

// Monday as first day (0..6)
const dayIndexMon0 = (d: Date) => {
  const js = d.getDay(); // 0=Sun..6=Sat
  return (js + 6) % 7; // 0=Mon..6=Sun
};

// Start of week (Monday)
const startOfWeekMon = (d: Date) => {
  const res = new Date(d);
  const diff = dayIndexMon0(d);
  res.setDate(d.getDate() - diff);
  res.setHours(12, 0, 0, 0);
  return res;
};

// End of week (Sunday)
const endOfWeekSun = (d: Date) => {
  const res = startOfWeekMon(d);
  res.setDate(res.getDate() + 6);
  return res;
};

// Compute grid covering the whole month (weeks start Mon, end Sun)
const monthGrid = (anchor: Date): Date[][] => {
  const first = new Date(anchor.getFullYear(), anchor.getMonth(), 1);
  const last = new Date(anchor.getFullYear(), anchor.getMonth() + 1, 0);
  const start = startOfWeekMon(first);
  const end = endOfWeekSun(last);

  const days: Date[] = [];
  const cur = new Date(start);
  while (cur <= end) {
    days.push(new Date(cur));
    cur.setDate(cur.getDate() + 1);
  }

  const weeks: Date[][] = [];
  for (let i = 0; i < days.length; i += 7) {
    weeks.push(days.slice(i, i + 7));
  }
  return weeks;
};

export default function CalendarPage() {
  const router = useRouter();
  const { currentUser, loading } = useAuth();
  const [viewDate, setViewDate] = useState<Date>(() => {
    const d = new Date();
    d.setHours(12, 0, 0, 0);
    return d;
  });
  const [events, setEvents] = useState<CalEvent[]>([]);

  // Modal state
  const [open, setOpen] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [title, setTitle] = useState('');
  const [start, setStart] = useState('');
  const [end, setEnd] = useState('');
  const [notes, setNotes] = useState('');

  useEffect(() => {
    if (!loading && !currentUser) router.replace('/login');
  }, [loading, currentUser, router]);

  useEffect(() => {
    if (!currentUser) return;
    const uid = currentUser.UserId;
    const ref = dbRef(db, `calendar/${uid}`);
    const unsub = onValue(ref, (snap) => {
      const data = snap.val() as Record<string, Omit<CalEvent, 'id'>> | null;
      if (!data) {
        setEvents([]);
        return;
      }
      const list: CalEvent[] = Object.entries(data).map(([id, e]) => ({
        id,
        title: e.title || '',
        start: e.start,
        end: e.end,
        notes: e.notes,
      }));
      // sort by start then title
      list.sort((a, b) => {
        const ad = Date.parse(a.start);
        const bd = Date.parse(b.start);
        if (ad !== bd) return ad - bd;
        return a.title.localeCompare(b.title);
      });
      setEvents(list);
    });
    return () => unsub();
  }, [currentUser]);

  const weeks = useMemo(() => monthGrid(viewDate), [viewDate]);
  const monthLabel = useMemo(() => {
    return viewDate.toLocaleString(undefined, {
      month: 'long',
      year: 'numeric',
    });
  }, [viewDate]);

  const resetForm = () => {
    setEditingId(null);
    setTitle('');
    setStart('');
    setEnd('');
    setNotes('');
  };

  const openForNew = (ymd: string) => {
    resetForm();
    setStart(ymd);
    setEnd(ymd);
    setOpen(true);
  };

  const openForEdit = (e: CalEvent) => {
    setEditingId(e.id);
    setTitle(e.title);
    setStart(e.start);
    setEnd(e.end ?? e.start);
    setNotes(e.notes || '');
    setOpen(true);
  };

  const saveEvent = async () => {
    const t = title.trim();
    const n = notes.trim();
    if (!currentUser || !t || !start || !(end || start) || !n) return;
    const payload: Omit<CalEvent, 'id'> = {
      title: t,
      start,
      end: end || start,
      notes: n,
    };
    const base = dbRef(db, `calendar/${currentUser.UserId}`);
    if (editingId) {
      await update(dbRef(db, `calendar/${currentUser.UserId}/${editingId}`), payload);
    } else {
      const newRef = push(base);
      await set(newRef, payload);
    }
    setOpen(false);
    resetForm();
  };

  const deleteEvent = async () => {
    if (!currentUser || !editingId) return;
    await remove(dbRef(db, `calendar/${currentUser.UserId}/${editingId}`));
    setOpen(false);
    resetForm();
  };

  const today = () => setViewDate(new Date());
  const prevMonth = () =>
    setViewDate((d) => new Date(d.getFullYear(), d.getMonth() - 1, 1));
  const nextMonth = () =>
    setViewDate((d) => new Date(d.getFullYear(), d.getMonth() + 1, 1));

  const isSameDay = (a: Date, b: Date) =>
    a.getFullYear() === b.getFullYear() &&
    a.getMonth() === b.getMonth() &&
    a.getDate() === b.getDate();

  // Build a quick index of event segments per week
  const weeklySegments = useMemo(() => {
    return weeks.map((week) => {
      const wStart = new Date(week[0]);
      const wEnd = new Date(week[6]);
      const segs: Array<{
        id: string;
        title: string;
        startCol: number; // 1..7
        endCol: number; // 1..7
        base: CalEvent;
      }> = [];
      for (const e of events) {
        const s = toNoon(e.start);
        const eEnd = toNoon(e.end || e.start);
        if (eEnd < wStart || s > wEnd) continue; // no overlap with this week

        const overlapStart = s < wStart ? wStart : s;
        const overlapEnd = eEnd > wEnd ? wEnd : eEnd;
        const startWithin = dayIndexMon0(overlapStart) + 1; // 1..7
        const endWithin = dayIndexMon0(overlapEnd) + 1; // 1..7

        segs.push({
          id: e.id,
          title: e.title,
          startCol: startWithin,
          endCol: endWithin,
          base: e,
        });
      }
      return segs;
    });
  }, [weeks, events]);

  return (
    <Layout>
      <div className='mx-auto max-w-6xl px-4 py-6'>
        <div className='mb-4 flex items-center justify-between'>
          <h1 className='text-2xl font-semibold text-gray-900'>{monthLabel}</h1>
          <div className='flex items-center gap-2'>
            <button
              onClick={today}
              className='rounded-md bg-gray-100 px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-200'
            >
              today
            </button>
            <div className='inline-flex overflow-hidden rounded-md border border-gray-300'>
              <button
                onClick={prevMonth}
                className='px-3 py-1.5 text-sm hover:bg-gray-50'
                aria-label='Previous month'
                title='Previous month'
              >
                ‚óÄ
              </button>
              <button
                onClick={nextMonth}
                className='border-l border-gray-300 px-3 py-1.5 text-sm hover:bg-gray-50'
                aria-label='Next month'
                title='Next month'
              >
                ‚ñ∂
              </button>
            </div>
            <button
              onClick={() => openForNew(toYmd(new Date()))}
              className='rounded-md bg-blue-600 px-3 py-1.5 text-sm font-semibold text-white hover:bg-blue-700'
            >
              Add Event
            </button>
          </div>
        </div>

        {/* Weekday header */}
        <div className='grid grid-cols-7 border-b border-gray-200 bg-white text-center text-sm font-semibold text-gray-700'>
          {weekdayLabels.map((w) => (
            <div key={w} className='px-2 py-2'>
              {w}
            </div>
          ))}
        </div>

        {/* Month grid */}
        <div className='border border-gray-200 bg-white'>
          {weeks.map((week, wi) => (
            <div key={wi} className='border-b last:border-b-0'>
              {/* Day cells */}
              <div className='grid grid-cols-7'>
                {week.map((d, di) => {
                  const inMonth = d.getMonth() === viewDate.getMonth();
                  const isToday = isSameDay(d, new Date());
                  return (
                    <button
                      key={di}
                      onClick={() => openForNew(toYmd(d))}
                      className={
                        'h-28 border-r last:border-r-0 p-2 text-left transition ' +
                        (inMonth
                          ? 'bg-white hover:bg-gray-50'
                          : 'bg-gray-50 text-gray-400 hover:bg-gray-100') +
                        (isToday ? ' outline outline-1 outline-yellow-300' : '')
                      }
                      title='Add event'
                    >
                      <div className='text-xs font-medium'>
                        {d.getDate()}
                      </div>
                    </button>
                  );
                })}
              </div>

              {/* Events for the week */}
              {weeklySegments[wi] && weeklySegments[wi].length > 0 && (
                <div className='grid grid-cols-7 gap-x-0.5 px-1 pb-2 pt-1'>
                  {weeklySegments[wi].map((seg) => (
                    <div
                      key={`${seg.id}-${seg.startCol}-${seg.endCol}`}
                      style={{ gridColumn: `${seg.startCol} / ${seg.endCol + 1}` }}
                      className='cursor-pointer truncate rounded bg-blue-500 px-2 py-1 text-xs font-medium text-white hover:bg-blue-600'
                      onClick={() => openForEdit(seg.base)}
                      title={seg.title}
                    >
                      {seg.title}
                    </div>
                  ))}
                </div>
              )}
            </div>
          ))}
        </div>

        {/* Modal */}
        {open && (
          <div className='fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4'>
            <div className='w-full max-w-lg rounded-lg bg-white p-6 shadow-xl'>
              <h2 className='mb-4 text-lg font-semibold text-gray-900'>
                {editingId ? 'Edit Event' : 'Add Event'}
              </h2>
              <form
                onSubmit={(e) => {
                  e.preventDefault();
                  // Leverage built-in required validation
                  const form = e.currentTarget as HTMLFormElement;
                  if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                  }
                  void saveEvent();
                }}
                className='space-y-3'
              >
                <div>
                  <label className='block text-sm font-medium text-gray-700'>
                    Title
                  </label>
                  <input
                    required
                    aria-required='true'
                    value={title}
                    onChange={(e) => setTitle(e.target.value)}
                    className='mt-1 w-full rounded border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none'
                    placeholder='e.g., Vacation time'
                  />
                </div>
                <div className='grid grid-cols-1 gap-3 sm:grid-cols-2'>
                  <div>
                    <label className='block text-sm font-medium text-gray-700'>
                      Start date
                    </label>
                    <input
                      required
                      aria-required='true'
                      type='date'
                      value={start}
                      onChange={(e) => setStart(e.target.value)}
                      className='mt-1 w-full rounded border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none'
                    />
                  </div>
                  <div>
                    <label className='block text-sm font-medium text-gray-700'>
                      End date
                    </label>
                    <input
                      required
                      aria-required='true'
                      type='date'
                      value={end}
                      onChange={(e) => setEnd(e.target.value)}
                      className='mt-1 w-full rounded border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none'
                    />
                  </div>
                </div>
                <div>
                  <label className='block text-sm font-medium text-gray-700'>
                    Notes
                  </label>
                  <textarea
                    required
                    aria-required='true'
                    value={notes}
                    onChange={(e) => setNotes(e.target.value)}
                    className='mt-1 w-full rounded border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none'
                    rows={3}
                    placeholder='Add details'
                  />
                </div>
                <div className='mt-6 flex items-center justify-end gap-2'>
                  {editingId && (
                    <button
                      type='button'
                      onClick={deleteEvent}
                      className='rounded-md border border-red-300 px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50'
                    >
                      Delete
                    </button>
                  )}
                  <button
                    type='button'
                    onClick={() => {
                      setOpen(false);
                      resetForm();
                    }}
                    className='rounded-md border border-gray-300 px-4 py-2 text-sm hover:bg-gray-50'
                  >
                    Cancel
                  </button>
                  <button
                    type='submit'
                    className='rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700'
                  >
                    Save
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}
      </div>
    </Layout>
  );
}
=== File End: app/calender/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/cart/page.tsx ===
// src/app/cart/page.tsx
'use client'

import Link from 'next/link'
import Layout from '../../components/layout/Layout'
import { useCart } from '../../contexts/CartContext'
import { CartItem } from '../../models/Cart'
import { useMemo } from 'react'

const currency = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
})

const clampQuantity = (value: number) => Math.max(1, value)

export default function CartPage() {
  const { cartItems, updateCart, removeFromCart, clearCart } = useCart()

  const subtotal = useMemo(
    () => cartItems.reduce((total, item) => total + (item.TotalPrice || 0), 0),
    [cartItems]
  )

  const handleQuantityChange = (item: CartItem, nextQty: number) => {
    const quantity = clampQuantity(nextQty)
    if (quantity === item.Count) return

    updateCart({
      ...item,
      Count: quantity,
      TotalPrice: parseFloat(item.UnitPrice) * quantity,
    })
  }

  return (
    <Layout>
      <div className="bg-gray-50 min-h-screen py-10">
        <div className="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
          <h1 className="text-3xl font-semibold text-gray-900">Your Cart</h1>

          {cartItems.length === 0 ? (
            <div className="mt-10 rounded-lg border border-dashed border-gray-300 bg-white p-10 text-center">
              <h2 className="text-xl font-medium text-gray-700">Your cart is empty</h2>
              <p className="mt-2 text-gray-500">
                Start adding assets to see them here.
              </p>
              <Link
                href="/home"
                className="mt-6 inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700"
              >
                Browse Assets
              </Link>
            </div>
          ) : (
            <div className="mt-8 grid gap-8 lg:grid-cols-[2fr,1fr]">
              <div className="space-y-6">
                {cartItems.map((item) => (
                  <div
                    key={item.Product_id}
                    className="flex flex-col gap-6 rounded-lg border border-gray-200 bg-white p-6 shadow-sm sm:flex-row"
                  >
                    <div className="flex-shrink-0">
                      <div className="h-24 w-24 overflow-hidden rounded-md border border-gray-200 bg-gray-100">
                        {item.Thumb ? (
                          <img
                            src={item.Thumb}
                            alt={item.Name}
                            className="h-full w-full object-cover"
                          />
                        ) : (
                          <div className="flex h-full w-full items-center justify-center text-sm text-gray-400">
                            No image
                          </div>
                        )}
                      </div>
                    </div>

                    <div className="flex flex-1 flex-col justify-between">
                      <div>
                        <div className="flex items-start justify-between gap-4">
                          <div>
                            <h2 className="text-lg font-semibold text-gray-900">
                              {item.Name}
                            </h2>
                            {item.Description && (
                              <p className="mt-1 text-sm text-gray-500">
                                {item.Description}
                              </p>
                            )}
                          </div>
                          <p className="text-lg font-medium text-gray-900">
                            {currency.format(item.TotalPrice || 0)}
                          </p>
                        </div>
                      </div>

                      <div className="mt-4 flex flex-wrap items-center justify-between gap-4">
                        <div className="flex items-center gap-2">
                          <button
                            type="button"
                            onClick={() => handleQuantityChange(item, item.Count - 1)}
                            className="inline-flex h-9 w-9 items-center justify-center rounded border border-gray-300 text-lg text-gray-600 hover:bg-gray-100"
                            aria-label={`Decrease quantity for ${item.Name}`}
                          >
                            ‚àí
                          </button>
                          <input
                            type="number"
                            min={1}
                            value={item.Count}
                            onChange={(event) => {
                              const parsed = Number(event.target.value)
                              handleQuantityChange(item, Number.isFinite(parsed) ? parsed : 1)
                            }}
                            className="h-9 w-16 rounded border border-gray-300 text-center text-sm"
                          />
                          <button
                            type="button"
                            onClick={() => handleQuantityChange(item, item.Count + 1)}
                            className="inline-flex h-9 w-9 items-center justify-center rounded border border-gray-300 text-lg text-gray-600 hover:bg-gray-100"
                            aria-label={`Increase quantity for ${item.Name}`}
                          >
                            +
                          </button>
                        </div>

                        <button
                          type="button"
                          onClick={() => removeFromCart(item.Product_id)}
                          className="text-sm font-medium text-red-500 hover:text-red-600"
                        >
                          Remove
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              <aside className="space-y-6 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
                <div>
                  <h2 className="text-xl font-semibold text-gray-900">Order Summary</h2>
                  <dl className="mt-4 space-y-3 text-sm text-gray-600">
                    <div className="flex justify-between">
                      <dt>Subtotal</dt>
                      <dd className="font-medium text-gray-900">{currency.format(subtotal)}</dd>
                    </div>
                    <div className="flex justify-between">
                      <dt>Estimated Tax</dt>
                      <dd className="text-gray-500">Calculated at checkout</dd>
                    </div>
                    <div className="flex justify-between">
                      <dt>Shipping</dt>
                      <dd className="text-gray-500">Free</dd>
                    </div>
                  </dl>
                </div>

                <div className="border-t border-gray-200 pt-4">
                  <div className="flex justify-between text-lg font-semibold text-gray-900">
                    <span>Total</span>
                    <span>{currency.format(subtotal)}</span>
                  </div>
                  <button
                    type="button"
                    className="mt-6 w-full rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700"
                  >
                    Proceed to Checkout
                  </button>
                  <button
                    type="button"
                    onClick={clearCart}
                    className="mt-3 w-full rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100"
                  >
                    Clear Cart
                  </button>
                </div>
              </aside>
            </div>
          )}
        </div>
      </div>
    </Layout>
  )
}
=== File End: app/cart/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/dashboard/page.tsx ===
// src/app/dashboard/page.tsx
'use client';

import React, { useEffect, useMemo, useState } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import {
  onValue,
  ref,
  query,
  orderByChild,
  equalTo,
  push,
  set,
  remove,
} from 'firebase/database';
import Layout from '../../components/layout/Layout';
import { useAuth } from '../../contexts/AuthContext';
import { db } from '../../lib/firebase';
import { type Vehicle, type Maintenance } from '../../models/Vehicle';
import { Bell, Trash2, HelpCircle } from 'lucide-react';

interface DashboardItem {
  assetKey: string;
  assetLabel: string;
  maintenanceType: string;
  maintenanceDesc?: string;
  dueDate?: Date;
}

interface ReminderItem {
  id: string;
  title: string;
  date?: string;
  notes?: string;
}

const DAYS = 30; // threshold window for "about to expire" and "upcoming"

export default function DashboardPage() {
  const router = useRouter();
  const { currentUser, loading } = useAuth();
  const [assets, setAssets] = useState<Vehicle[]>([]);
  const [noOdometerAssets, setNoOdometerAssets] = useState<Vehicle[]>([]);
  const [dismissed, setDismissed] = useState<Set<string>>(new Set());
  const [dismissModal, setDismissModal] = useState<{
    open: boolean;
    type: 'warranty' | 'maint' | null;
    item: DashboardItem | null;
  }>({ open: false, type: null, item: null });

  // Reminder modal state (local-only placeholder)
  const [reminderOpen, setReminderOpen] = useState(false);
  const [reminderTitle, setReminderTitle] = useState('');
  const [reminderDate, setReminderDate] = useState('');
  const [reminderNotes, setReminderNotes] = useState('');
  const [localReminders, setLocalReminders] = useState<ReminderItem[]>([]);

  useEffect(() => {
    if (!currentUser) {
      setAssets([]);
      setNoOdometerAssets([]);
      setLocalReminders([]);
      return;
    }

    const assetsRef = ref(db, `assets/${currentUser.UserId}`);
    const unsubscribe = onValue(assetsRef, (snapshot: any) => {
      const data = snapshot.val();
      if (data) {
        const list: Vehicle[] = Object.keys(data).map((key) => ({
          key,
          ...data[key],
        }));
        setAssets(list);
      } else {
        setAssets([]);
      }
    });

    // Query for assets missing odometer field directly from Firebase
    const q = query(assetsRef, orderByChild('odometer'), equalTo(null));
    const unsubscribeNoOdo = onValue(q, (snapshot: any) => {
      const data = snapshot.val();
      if (data) {
        const list: Vehicle[] = Object.keys(data).map((key) => ({
          key,
          ...data[key],
        }));
        setNoOdometerAssets(list);
      } else {
        setNoOdometerAssets([]);
      }
    });

    return () => {
      unsubscribe();
      unsubscribeNoOdo();
    };
  }, [currentUser]);

  // Load reminders for this user from Firebase
  useEffect(() => {
    if (!currentUser) return;
    const uid = currentUser.UserId;
    const remindersRef = ref(db, `reminders/${uid}`);
    const unsub = onValue(remindersRef, (snap) => {
      const data = snap.val() as Record<
        string,
        { title?: string; date?: string; notes?: string }
      > | null;
      if (!data) {
        setLocalReminders([]);
        return;
      }
      const list: ReminderItem[] = Object.entries(data)
        .map(([id, r]) => ({
          id,
          title: (r.title || '').trim(),
          date: r.date || undefined,
          notes: r.notes || undefined,
        }))
        .filter((r) => r.title);
      // Sort by date (if present), then title
      list.sort((a, b) => {
        const ad = a.date ? Date.parse(a.date) : NaN;
        const bd = b.date ? Date.parse(b.date) : NaN;
        const aHas = Number.isFinite(ad);
        const bHas = Number.isFinite(bd);
        if (aHas && bHas) return ad - bd;
        if (aHas) return -1;
        if (bHas) return 1;
        return a.title.localeCompare(b.title);
      });
      setLocalReminders(list);
    });
    return () => unsub();
  }, [currentUser]);

  useEffect(() => {
    if (!loading && !currentUser) {
      router.replace('/login');
    }
  }, [loading, currentUser, router]);

  const labelForAsset = (a: Vehicle): string => {
    const parts: string[] = [];
    if (a.year) parts.push(String(a.year));
    if (a.make) parts.push(a.make);
    if (a.model) parts.push(a.model);
    const candidate = parts.join(' ').trim();
    if (candidate) return candidate;
    if (a.vin && a.vin.trim()) return a.vin.trim();
    if (a.plate && a.plate.trim()) return a.plate.trim();
    return a.category?.trim() || 'Asset';
  };

  const now = new Date();
  const soon = new Date(now.getTime() + DAYS * 24 * 60 * 60 * 1000);

  const { warrantyExpiring, upcomingMaintenance } = useMemo(() => {
    const warrantyExpiring: DashboardItem[] = [];
    const upcomingMaintenance: DashboardItem[] = [];

    for (const a of assets) {
      const maint: Maintenance[] = a.maintenance ?? [];
      for (const m of maint) {
        const type = (m.maintenanceType || '').trim();
        const desc = (m.maintenanceDesc || '').trim() || undefined;
        const dueRaw = m.maintenanceEndDate;
        let due: Date | undefined;
        if (dueRaw) {
          const d = new Date(dueRaw as any);
          if (!Number.isNaN(d.getTime())) {
            due = d;
          }
        }

        const item: DashboardItem = {
          assetKey: a.key || '',
          assetLabel: labelForAsset(a),
          maintenanceType: type,
          maintenanceDesc: desc,
          dueDate: due,
        };

        // Warranty expiring soon (within DAYS)
        if (
          type.toLowerCase().includes('warranty') &&
          due &&
          due >= now &&
          due <= soon
        ) {
          warrantyExpiring.push(item);
        }

        // Upcoming maintenance: specifically oil change and tire rotation in the near future
        const lower = type.toLowerCase();
        const isTarget =
          lower.includes('oil') || lower.includes('tire rotation');
        if (isTarget && due && due >= now && due <= soon) {
          upcomingMaintenance.push(item);
        }
      }
    }

    const byDate = (a?: Date, b?: Date) => {
      if (!a && !b) return 0;
      if (!a) return 1;
      if (!b) return -1;
      return a.getTime() - b.getTime();
    };

    warrantyExpiring.sort((a, b) => byDate(a.dueDate, b.dueDate));
    upcomingMaintenance.sort((a, b) => byDate(a.dueDate, b.dueDate));

    return { warrantyExpiring, upcomingMaintenance };
  }, [assets]);

  const noOdometerVehicles = useMemo(() => {
    return (noOdometerAssets || []).filter(
      (a) => (a.category || '').toString().trim().toLowerCase() === 'vehicle'
    );
  }, [noOdometerAssets]);

  const staleOdometerVehicles = useMemo(() => {
    const ninetyDaysMs = 90 * 24 * 60 * 60 * 1000;
    const isVehicle = (a: Vehicle) =>
      (a.category || '').toString().trim().toLowerCase() === 'vehicle';
    const latestDateMs = (a: Vehicle): number | null => {
      const entries = Array.isArray(a.odometer) ? a.odometer : [];
      if (entries.length === 0) return null;
      let latest = Number.NEGATIVE_INFINITY;
      for (const e of entries) {
        const raw = (e as any)?.date ?? (e as any)?.reading;
        const ts = raw ? new Date(raw as any).getTime() : NaN;
        if (!Number.isNaN(ts) && ts > latest) latest = ts;
      }
      return Number.isFinite(latest) ? latest : null;
    };

    return assets.filter((a) => {
      if (!isVehicle(a)) return false;
      const ms = latestDateMs(a);
      if (ms === null) return false; // handled by noOdometerVehicles instead
      return Date.now() - ms > ninetyDaysMs;
    });
  }, [assets]);

  const missingOrStaleVehicles = useMemo(() => {
    const byKey: Record<
      string,
      { asset: Vehicle; stale: boolean; lastDate?: string }
    > = {};
    for (const a of noOdometerVehicles) {
      if (!a.key) continue;
      byKey[a.key] = { asset: a, stale: false };
    }
    for (const a of staleOdometerVehicles) {
      if (!a.key) continue;
      // compute last date string
      let lastDate: string | undefined;
      const entries = Array.isArray(a.odometer) ? a.odometer : [];
      let latest = Number.NEGATIVE_INFINITY;
      for (const e of entries) {
        const raw = (e as any)?.date ?? (e as any)?.reading;
        const ts = raw ? new Date(raw as any).getTime() : NaN;
        if (!Number.isNaN(ts) && ts > latest) {
          latest = ts;
        }
      }
      if (Number.isFinite(latest)) {
        lastDate = new Date(latest).toLocaleDateString();
      }
      byKey[a.key] = { asset: a, stale: true, lastDate };
    }
    return Object.values(byKey);
  }, [noOdometerVehicles, staleOdometerVehicles]);

  // Mock sample data when there are no real items
  const sampleWarrantyExpiring: DashboardItem[] = useMemo(
    () => [
      {
        assetKey: 'sample-1',
        assetLabel: '2018 Honda Civic',
        maintenanceType: 'Powertrain Warranty',
        maintenanceDesc: '5yr / 60k mi',
        dueDate: new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000),
      },
    ],
    []
  );

  const sampleUpcomingMaintenance: DashboardItem[] = useMemo(
    () => [
      {
        assetKey: 'sample-2',
        assetLabel: 'Dodge 3500 ram',
        maintenanceType: 'Oil Change',
        maintenanceDesc: 'Full synthetic',
        dueDate: new Date(now.getTime() + 10 * 24 * 60 * 60 * 1000),
      },
      {
        assetKey: 'sample-3',
        assetLabel: '2016 Ford F-150',
        maintenanceType: 'Tire Rotation',
        maintenanceDesc: 'Cross-pattern',
        dueDate: new Date(now.getTime() + 18 * 24 * 60 * 60 * 1000),
      },
    ],
    []
  );

  const showSampleWarranty = warrantyExpiring.length === 0;
  const showSampleMaint = upcomingMaintenance.length === 0;
  const displayWarranty = showSampleWarranty
    ? sampleWarrantyExpiring
    : warrantyExpiring;

  // Try to link the sample maintenance item labeled "Didge 3500 ram" to a real asset if present
  const preferredRamAssetKey = useMemo(() => {
    const lc = (v?: string) => (v ? v.toLowerCase() : '');
    const hay = (a: Vehicle) =>
      [a.make, a.model, a.description, a.category].map(lc).join(' ');
    // Best match: contains "didge" + "3500" + "ram"
    const best = assets.find((a) => {
      const h = hay(a);
      return h.includes('didge') && h.includes('3500') && h.includes('ram');
    });
    if (best?.key) return best.key;
    // Second best: contains "dodge" + "3500" + "ram"
    const next = assets.find((a) => {
      const h = hay(a);
      return h.includes('dodge') && h.includes('3500') && h.includes('ram');
    });
    if (next?.key) return next.key;
    // Fallback: contains "3500" and "ram"
    const fallback = assets.find((a) => {
      const h = hay(a);
      return h.includes('3500') && h.includes('ram');
    });
    return fallback?.key;
  }, [assets]);

  const displayMaint = useMemo(() => {
    if (!showSampleMaint) return upcomingMaintenance;
    if (!preferredRamAssetKey) return sampleUpcomingMaintenance;
    return sampleUpcomingMaintenance.map((it) =>
      it.assetLabel.toLowerCase().includes('didge 3500 ram')
        ? { ...it, assetKey: preferredRamAssetKey }
        : it
    );
  }, [
    showSampleMaint,
    upcomingMaintenance,
    preferredRamAssetKey,
    sampleUpcomingMaintenance,
  ]);

  // Utility: stable ID for a warning row (section + asset + type + date)
  const warningId = (section: 'warranty' | 'maint', item: DashboardItem) => {
    const dateKey = item.dueDate
      ? new Date(item.dueDate).toISOString().slice(0, 10)
      : 'na';
    const typeKey = (item.maintenanceType || '').toLowerCase();
    const key = item.assetKey || 'sample';
    return `${section}:${key}:${typeKey}:${dateKey}`;
  };

  const filteredWarranty = useMemo(
    () =>
      displayWarranty.filter((it) => !dismissed.has(warningId('warranty', it))),
    [displayWarranty, dismissed]
  );
  const filteredMaint = useMemo(
    () => displayMaint.filter((it) => !dismissed.has(warningId('maint', it))),
    [displayMaint, dismissed]
  );

  const openDismissModal = (
    type: 'warranty' | 'maint',
    item: DashboardItem
  ) => {
    setDismissModal({ open: true, type, item });
  };

  const closeDismissModal = () =>
    setDismissModal({ open: false, type: null, item: null });

  const confirmDismiss = () => {
    if (!dismissModal.open || !dismissModal.type || !dismissModal.item) return;
    const id = warningId(dismissModal.type, dismissModal.item);
    setDismissed((prev) => {
      const next = new Set(prev);
      next.add(id);
      return next;
    });
    closeDismissModal();
  };

  // Reminder helpers
  const resetReminderForm = () => {
    setReminderTitle('');
    setReminderDate('');
    setReminderNotes('');
  };
  const saveReminder = async () => {
    const title = reminderTitle.trim();
    if (!title) return;
    if (!currentUser) return;
    const uid = currentUser.UserId;
    const remindersRef = ref(db, `reminders/${uid}`);
    const newRef = push(remindersRef);
    await set(newRef, {
      title,
      date: reminderDate || null,
      notes: reminderNotes || null,
      createdAt: Date.now(),
    });
    resetReminderForm();
    setReminderOpen(false);
  };
  const deleteReminder = async (id: string) => {
    if (!currentUser) return;
    const uid = currentUser.UserId;
    await remove(ref(db, `reminders/${uid}/${id}`));
  };

  if (loading || !currentUser) {
    return (
      <Layout>
        <div className='flex min-h-screen items-center justify-center'>
          <div className='text-center'>
            <div className='mx-auto h-12 w-12 animate-spin rounded-full border-b-2 border-blue-600' />
            <p className='mt-4 text-gray-600'>Loading dashboard...</p>
          </div>
        </div>
      </Layout>
    );
  }

  return (
    <Layout>
      <div className='min-h-screen bg-gray-100'>
        <header className='bg-white shadow'>
          <div className='mx-auto max-w-7xl px-4 py-3 flex items-center justify-between'>
            <div>
              <h1 className='text-2xl font-bold text-blue-600'>Dashboard</h1>
            </div>
            <div className='flex items-center gap-2'>
              <button
                type='button'
                onClick={() => setReminderOpen(true)}
                className='inline-flex items-center gap-2 rounded-md border border-blue-600 px-3 py-1.5 text-sm font-medium text-blue-600 hover:bg-blue-50'
                aria-label='Add reminder'
                title='Add reminder'
              >
                <Bell className='h-4 w-4' />
                <span className='hidden sm:inline'>Add Reminder</span>
              </button>
            </div>
          </div>
        </header>

        <main className='mx-auto max-w-7xl px-3 py-4 grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch'>
          <section className='w-full h-full flex flex-col rounded-lg bg-white p-3 md:p-4 shadow-sm border border-solid border-green-300'>
            <div className='mb-2 flex items-center justify-between'>
              <h2 className='text-lg font-semibold text-green-800'>
                Reminders
              </h2>
            </div>
            {localReminders.length === 0 ? (
              <div className='text-sm text-gray-600'>No reminders yet.</div>
            ) : (
              <ul className='divide-y divide-gray-200'>
                {localReminders.map((r) => (
                  <li key={r.id} className='py-2'>
                    <div className='flex items-start justify-between gap-4'>
                      <div>
                        <div className='font-medium text-gray-900'>
                          {r.title}
                        </div>
                        <div className='text-sm text-gray-700'>
                          {r.date ? (
                            <span className='mr-2'>Due: {r.date}</span>
                          ) : null}
                          {r.notes ? (
                            <span className='text-gray-500'>‚Äî {r.notes}</span>
                          ) : null}
                        </div>
                      </div>
                      <div className='shrink-0'>
                        <button
                          type='button'
                          onClick={() => deleteReminder(r.id)}
                          className='inline-flex items-center rounded-md border border-red-300 px-2 py-1 text-xs font-medium text-red-600 hover:bg-red-50'
                          aria-label={`Delete reminder ${r.title}`}
                          title='Delete reminder'
                        >
                          <Trash2 className='h-4 w-4' />
                        </button>
                      </div>
                    </div>
                  </li>
                ))}
              </ul>
            )}
          </section>
          <section className='w-full h-full flex flex-col rounded-lg bg-white p-3 md:p-4 shadow-sm'>
            <div className='mb-2 flex items-center justify-between'>
              <h2 className='text-lg font-semibold text-gray-900'>
                Warranties Expiring Soon
              </h2>
              <div className='flex items-center gap-3'>
                <span className='text-xs text-gray-500'>Next {DAYS} days</span>
              </div>
            </div>
            {filteredWarranty.length === 0 ? (
              <p className='text-sm text-gray-600'>
                No warranties are expiring soon.
              </p>
            ) : (
              <ul className='divide-y divide-gray-200'>
                {filteredWarranty.map((item, idx) => (
                  <li key={`${item.assetKey}-${idx}`} className='py-2'>
                    <div className='flex items-start justify-between gap-4'>
                      <div>
                        {item.assetKey &&
                        !item.assetKey.startsWith('sample') ? (
                          <Link
                            href={`/homedetail/${item.assetKey}`}
                            className='font-medium text-blue-600 hover:text-blue-700'
                          >
                            {item.assetLabel}
                          </Link>
                        ) : (
                          <div className='font-medium text-gray-900'>
                            {item.assetLabel}{' '}
                            <span className='ml-2 rounded bg-gray-100 px-2 py-0.5 text-xs text-gray-600'>
                              Sample
                            </span>
                          </div>
                        )}
                        <div className='text-sm text-gray-700'>
                          {item.maintenanceType || 'Warranty'}{' '}
                          {item.maintenanceDesc
                            ? `‚Äì ${item.maintenanceDesc}`
                            : ''}
                        </div>
                      </div>
                      <div className='text-right'>
                        <div className='flex items-center justify-end gap-2'>
                          <div className='text-sm font-medium text-gray-900'>
                            {item.dueDate
                              ? new Date(item.dueDate).toLocaleDateString()
                              : 'No date'}
                          </div>
                          {item.assetKey &&
                          !item.assetKey.startsWith('sample') ? (
                            <Link
                              href={`/homedetail/${item.assetKey}?edit=maintenance`}
                              className='inline-flex items-center rounded-md border border-blue-400 px-2 py-1 text-xs font-medium text-blue-700 hover:bg-blue-50'
                              aria-label={`Edit maintenance for ${item.assetLabel}`}
                            >
                              Edit
                            </Link>
                          ) : (
                            <Link
                              href={'/home'}
                              className='inline-flex items-center rounded-md border border-blue-400 px-2 py-1 text-xs font-medium text-blue-700 hover:bg-blue-50'
                              aria-label={`Edit maintenance for ${item.assetLabel}`}
                            >
                              Edit
                            </Link>
                          )}
                          <button
                            type='button'
                            onClick={() => openDismissModal('warranty', item)}
                            className='inline-flex items-center rounded-md border border-red-300 px-2 py-1 text-xs font-medium text-red-600 hover:bg-red-50'
                            aria-label={`Dismiss warning for ${item.assetLabel}`}
                          >
                            Dismiss
                          </button>
                        </div>
                        {item.dueDate && (
                          <div className='text-xs text-gray-500'>
                            due in{' '}
                            {Math.ceil(
                              (item.dueDate.getTime() - now.getTime()) /
                                (1000 * 60 * 60 * 24)
                            )}{' '}
                            days
                          </div>
                        )}
                      </div>
                    </div>
                  </li>
                ))}
              </ul>
            )}
          </section>

          <section className='w-full h-full flex flex-col rounded-lg bg-white p-3 md:p-4 shadow-sm'>
            <div className='mb-2 flex items-center justify-between'>
              <h2 className='text-lg font-semibold text-gray-900'>
                Upcoming Maintenance
              </h2>
              <div className='flex items-center gap-3'>
                <span className='text-xs text-gray-500'>Next {DAYS} days</span>
              </div>
            </div>
            {filteredMaint.length === 0 ? (
              <p className='text-sm text-gray-600'>
                No upcoming maintenance due soon for oil changes or tire
                rotations.
              </p>
            ) : (
              <ul className='divide-y divide-gray-200'>
                {filteredMaint.map((item, idx) => (
                  <li key={`${item.assetKey}-${idx}`} className='py-2'>
                    <div className='flex items-start justify-between gap-4'>
                      <div>
                        {item.assetKey &&
                        !item.assetKey.startsWith('sample') ? (
                          <Link
                            href={`/homedetail/${item.assetKey}`}
                            className='font-medium text-blue-600 hover:text-blue-700'
                          >
                            {item.assetLabel}
                          </Link>
                        ) : (
                          <div className='font-medium text-gray-900'>
                            {item.assetLabel}{' '}
                            <span className='ml-2 rounded bg-gray-100 px-2 py-0.5 text-xs text-gray-600'>
                              Sample
                            </span>
                          </div>
                        )}
                        <div className='text-sm text-gray-700'>
                          {item.maintenanceType || 'Maintenance'}{' '}
                          {item.maintenanceDesc
                            ? `‚Äì ${item.maintenanceDesc}`
                            : ''}
                        </div>
                      </div>
                      <div className='text-right'>
                        <div className='flex items-center justify-end gap-2'>
                          <div className='text-sm font-medium text-gray-900'>
                            {item.dueDate
                              ? new Date(item.dueDate).toLocaleDateString()
                              : 'No date'}
                          </div>
                          {item.assetKey &&
                          !item.assetKey.startsWith('sample') ? (
                            <Link
                              href={`/homedetail/${item.assetKey}?edit=maintenance`}
                              className='inline-flex items-center rounded-md border border-blue-400 px-2 py-1 text-xs font-medium text-blue-700 hover:bg-blue-50'
                              aria-label={`Edit maintenance for ${item.assetLabel}`}
                            >
                              Edit
                            </Link>
                          ) : (
                            <Link
                              href={'/home'}
                              className='inline-flex items-center rounded-md border border-blue-400 px-2 py-1 text-xs font-medium text-blue-700 hover:bg-blue-50'
                              aria-label={`Edit maintenance for ${item.assetLabel}`}
                            >
                              Edit
                            </Link>
                          )}
                          <button
                            type='button'
                            onClick={() => openDismissModal('maint', item)}
                            className='inline-flex items-center rounded-md border border-red-300 px-2 py-1 text-xs font-medium text-red-600 hover:bg-red-50'
                            aria-label={`Dismiss warning for ${item.assetLabel}`}
                          >
                            Dismiss
                          </button>
                        </div>
                        {item.dueDate && (
                          <div className='text-xs text-gray-500'>
                            due in{' '}
                            {Math.ceil(
                              (item.dueDate.getTime() - now.getTime()) /
                                (1000 * 60 * 60 * 24)
                            )}{' '}
                            days
                          </div>
                        )}
                      </div>
                    </div>
                  </li>
                ))}
              </ul>
            )}
          </section>
          <section className='w-full h-full flex flex-col rounded-lg bg-white p-3 md:p-4 shadow-sm'>
            <div className='mb-2 flex items-center justify-between'>
              <h2 className='text-lg font-semibold text-gray-900 flex items-center gap-2'>
                Vehicles Missing or Stale Odometer Reading
                <span
                  className='relative inline-flex group'
                  tabIndex={0}
                  aria-describedby='odo-tooltip'
                >
                  <HelpCircle
                    className='h-5 w-5 text-gray-400 cursor-help group-hover:text-gray-500 group-focus:text-gray-500'
                    aria-hidden='true'
                  />
                  <span
                    id='odo-tooltip'
                    role='tooltip'
                    className='pointer-events-none absolute left-6 top-1/2 -translate-y-1/2 z-10 w-72 rounded-md bg-gray-900 px-3 py-2 text-xs text-white shadow-lg opacity-0 transition-opacity duration-150 group-hover:opacity-100 group-focus:opacity-100 group-focus-within:opacity-100'
                  >
                    By entering your odometer on frequent basis we can determine different maintenance intervals
                    <span className='absolute left-0 top-1/2 -translate-y-1/2 -ml-1.5 h-3 w-3 rotate-45 bg-gray-900'></span>
                  </span>
                </span>
              </h2>
              <div className='flex items-center gap-3'>
                <span className='text-xs text-gray-500'>
                  Filtered from database
                </span>
              </div>
            </div>
            {missingOrStaleVehicles.length === 0 ? (
              <p className='text-sm text-gray-600'>
                All vehicles have a recent odometer reading.
              </p>
            ) : (
              <ul className='divide-y divide-gray-200'>
                {missingOrStaleVehicles.map(({ asset: a, stale, lastDate }) => (
                  <li key={a.key} className='py-2'>
                    <div className='flex items-center justify-between gap-4'>
                      <Link
                        href={`/homedetail/${a.key}`}
                        className='font-medium text-blue-600 hover:text-blue-700'
                      >
                        {labelForAsset(a)}
                      </Link>
                      <div className='flex items-center gap-3'>
                        {stale ? (
                          <span className='text-xs text-red-600'>
                            Last reading older than 90 days
                            {lastDate ? ` (${lastDate})` : ''}
                          </span>
                        ) : (
                          <span className='text-xs text-gray-600'>
                            No odometer readings
                          </span>
                        )}
                        <Link
                          href={`/homedetail/${a.key}`}
                          className='inline-flex items-center rounded-md border border-blue-400 px-2 py-1 text-xs font-medium text-blue-700 hover:bg-blue-50'
                        >
                          {stale ? 'Update Reading' : 'Add Reading'}
                        </Link>
                      </div>
                    </div>
                  </li>
                ))}
              </ul>
            )}
          </section>
        </main>

        {reminderOpen && (
          <div className='fixed inset-0 z-50 flex items-center justify-center bg-gray-900/60 px-4'>
            <div className='w-full max-w-md rounded-lg bg-white p-5 shadow-xl'>
              <h2 className='text-base font-semibold text-gray-900 flex items-center gap-2'>
                <Bell className='h-4 w-4' /> Add Reminder
              </h2>
              <div className='mt-4 space-y-3'>
                <div>
                  <label className='block text-sm font-medium text-gray-700'>
                    Title
                  </label>
                  <input
                    type='text'
                    value={reminderTitle}
                    onChange={(e) => setReminderTitle(e.target.value)}
                    placeholder='e.g., Renew registration'
                    className='mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500'
                  />
                </div>
                <div>
                  <label className='block text-sm font-medium text-gray-700'>
                    Date
                  </label>
                  <input
                    type='date'
                    value={reminderDate}
                    onChange={(e) => setReminderDate(e.target.value)}
                    className='mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500'
                  />
                </div>
                <div>
                  <label className='block text-sm font-medium text-gray-700'>
                    Notes
                  </label>
                  <textarea
                    value={reminderNotes}
                    onChange={(e) => setReminderNotes(e.target.value)}
                    rows={3}
                    className='mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500'
                    placeholder='Optional details'
                  />
                </div>
              </div>
              <div className='mt-5 flex justify-end gap-3'>
                <button
                  type='button'
                  onClick={() => {
                    setReminderOpen(false);
                    resetReminderForm();
                  }}
                  className='inline-flex items-center rounded-md border border-gray-300 px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-100'
                >
                  Cancel
                </button>
                <button
                  type='button'
                  onClick={saveReminder}
                  disabled={!reminderTitle.trim()}
                  className='inline-flex items-center rounded-md bg-blue-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-blue-700 disabled:opacity-50'
                >
                  Save
                </button>
              </div>
            </div>
          </div>
        )}

        {dismissModal.open && dismissModal.item && (
          <div className='fixed inset-0 z-50 flex items-center justify-center bg-gray-900/60 px-4'>
            <div className='w-full max-w-sm rounded-lg bg-white p-5 shadow-xl'>
              <h2 className='text-base font-semibold text-gray-900'>
                Dismiss Warning
              </h2>
              <p className='mt-2 text-sm text-gray-600'>
                Are you sure you want to dismiss this warning for
                <span className='font-medium'>
                  {' '}
                  {dismissModal.item.assetLabel}
                </span>
                ?
              </p>
              <div className='mt-5 flex justify-end gap-3'>
                <button
                  type='button'
                  onClick={closeDismissModal}
                  className='inline-flex items-center rounded-md border border-gray-300 px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-100'
                >
                  Cancel
                </button>
                <button
                  type='button'
                  onClick={confirmDismiss}
                  className='inline-flex items-center rounded-md bg-red-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-red-700'
                >
                  Dismiss
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </Layout>
  );
}
=== File End: app/dashboard/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/globals.css ===
/* src/app/globals.css */
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  color-scheme: light;
}

html.dark {
  color-scheme: dark;
}

@layer base {
  body {
    @apply bg-gray-50 text-gray-900 antialiased;
  }

  html.dark body {
    @apply bg-gray-900 text-gray-100;
  }
}

/* AI description fade animation */
@keyframes ai-fade {
  0% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}

.ai-fade {
  animation: ai-fade 1s ease-in-out infinite alternate;
}
=== File End: app/globals.css ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/home/page.tsx ===
// src/app/home/page.tsx
'use client';

import React, { useState, useEffect, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '../../contexts/AuthContext';
import { useCart } from '../../contexts/CartContext';
import { Vehicle } from '../../models/Vehicle';
import { ref, onValue, push, set, update } from 'firebase/database';
import { db } from '../../lib/firebase';
import Layout from '../../components/layout/Layout';

export default function HomePage() {
  const { currentUser, loading } = useAuth();
  const { cartTotal } = useCart();
  const router = useRouter();
  const [assets, setAssets] = useState<Vehicle[]>([]);
  const [showForm, setShowForm] = useState(false);
  const [selectedAsset, setSelectedAsset] = useState('');
  const [showInsuranceForm, setShowInsuranceForm] = useState(false);
  const [showWarrantyForm, setShowWarrantyForm] = useState(false);
  const [editingOdometerFor, setEditingOdometerFor] = useState<string | null>(null);
  const [odometerDraft, setOdometerDraft] = useState<{ reading: string; date: string }>({ reading: '', date: '' });
  const [isSavingOdometer, setIsSavingOdometer] = useState(false);
  const [odometerError, setOdometerError] = useState<string | null>(null);
  const [formData, setFormData] = useState<Partial<Vehicle>>({
    make: '',
    model: '',
    year: undefined,
    vin: '',
    plate: '',
    tires: '',
    insuranceCompany: '',
    insurancePolicyNumber: '',
    insuranceExpirationDate: '',
    warranty: false,
    warrantyNumber: '',
    warrantyPhone: '',
    warrantyNotes: '',
    warrantyExpiry: '',
  });

  // Years dropdown options from current year down to 1980
  const yearOptions = useMemo(() => {
    const current = new Date().getFullYear();
    const start = 1980;
    const years: number[] = [];
    for (let y = current; y >= start; y -= 1) years.push(y);
    return years;
  }, []);

  useEffect(() => {
    if (!currentUser) {
      setAssets([]);
      return;
    }

    const assetsRef = ref(db, `assets/${currentUser.UserId}`);
    const unsubscribe = onValue(assetsRef, (snapshot: any) => {
      const data = snapshot.val();
      if (data) {
        const assetsList = Object.keys(data).map((key) => ({
          key,
          ...data[key],
        }));
        setAssets(assetsList);
      } else {
        setAssets([]);
      }
    });

    return () => unsubscribe();
  }, [currentUser]);

  useEffect(() => {
    if (!loading && !currentUser) {
      router.replace('/login');
    }
  }, [loading, currentUser, router]);

  // Group assets by category with desired order
  const groupedAssets = useMemo(() => {
    const order: Record<string, number> = { vehicle: 0, household: 1, bike: 2 };
    const groups: Record<string, Vehicle[]> = {};

    const normalizeCategory = (a: Vehicle): string => {
      const raw = (a.category || '').toLowerCase().trim();
      if (raw in order) return raw;
      // Treat common vehicle-like values/brands as vehicles
      const vehicleAliases = new Set([
        'car',
        'cars',
        'truck',
        'trucks',
        'suv',
        'van',
        'motorcycle',
        'motorbike',
        'atv',
        'utv',
        'dodge',
        'polaris',
        'polarius',
      ]);
      if (vehicleAliases.has(raw)) return 'vehicle';
      // If it has a VIN or plate, consider it a vehicle
      if ((a.vin && a.vin.trim()) || (a.plate && a.plate.trim())) return 'vehicle';
      return 'other';
    };

    for (const a of assets) {
      const key = normalizeCategory(a);
      if (!groups[key]) groups[key] = [];
      groups[key].push(a);
    }
    const categories = Object.keys(groups).sort(
      (a, b) => (order[a] ?? 99) - (order[b] ?? 99)
    );
    return categories.map((c) => ({ category: c, items: groups[c] }));
  }, [assets]);

  const categoryLabel: Record<string, string> = {
    vehicle: 'Vehicles',
    household: 'Household Items',
    bike: 'Bikes',
    other: 'Other',
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!currentUser?.UserId) {
      console.error('Unable to add asset: user is not authenticated.');
      return;
    }

    try {
      const assetsRef = ref(db, `assets/${currentUser.UserId}`);
      const newAssetRef = push(assetsRef);
      const newAsset: Vehicle = {
        ...formData,
        UserId: currentUser.UserId,
        category: selectedAsset,
        key: newAssetRef.key ?? undefined,
        warranty: Boolean((formData as any).warranty),
      };
      await set(newAssetRef, newAsset);
      setShowForm(false);
      setShowInsuranceForm(false);
      setShowWarrantyForm(false);
      setFormData({
        make: '',
        model: '',
        year: undefined,
        vin: '',
        plate: '',
        tires: '',
        insuranceCompany: '',
        insurancePolicyNumber: '',
        insuranceExpirationDate: '',
        warranty: false,
        warrantyNumber: '',
        warrantyPhone: '',
        warrantyNotes: '',
        warrantyExpiry: '',
      });
      setSelectedAsset('');
    } catch (error) {
      console.error('Error adding asset:', error);
    }
  };

  const handleInputChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>
  ) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: value,
    }));
  };

  // Helper to compute the latest odometer entry for a card
  const formatLatestOdometer = (
    a: Vehicle
  ): { number: string; date?: string; dateMs?: number } | null => {
    const entries = Array.isArray(a.odometer) ? a.odometer : [];
    if (entries.length === 0) return null;
    let latestIndex = -1;
    let latestTs = -Infinity;
    for (let i = 0; i < entries.length; i += 1) {
      const e = entries[i] as any;
      const raw = e?.date ?? e?.reading;
      const ts = raw ? new Date(raw as any).getTime() : NaN;
      const safeTs = Number.isNaN(ts) ? -Infinity : ts;
      if (safeTs > latestTs) {
        latestTs = safeTs;
        latestIndex = i;
      }
    }
    const chosen = entries[latestIndex] as any;
    if (!chosen || typeof chosen.odometer !== 'number' || !Number.isFinite(chosen.odometer)) return null;
    const number = new Intl.NumberFormat().format(chosen.odometer as number);
    let date: string | undefined;
    let dateMs: number | undefined;
    const raw = chosen?.date ?? chosen?.reading;
    if (raw) {
      const d = new Date(raw as any);
      if (!Number.isNaN(d.getTime())) {
        date = d.toLocaleDateString();
        dateMs = d.getTime();
      }
    }
    return { number, date, dateMs };
  };

  const openOdometerEditor = (asset: Vehicle) => {
    const today = new Date().toISOString().split('T')[0];
    setEditingOdometerFor(asset.key || null);
    setOdometerDraft({ reading: '', date: today });
    setOdometerError(null);
  };

  const cancelOdometerEdit = () => {
    if (isSavingOdometer) return;
    setEditingOdometerFor(null);
    setOdometerDraft({ reading: '', date: '' });
    setOdometerError(null);
  };

  const handleOdometerSave = async (asset: Vehicle) => {
    if (!currentUser?.UserId || !asset?.key) return;

    const readingTrim = odometerDraft.reading.trim();
    const dateTrim = odometerDraft.date.trim();

    if (!readingTrim) {
      setOdometerError('Please enter the odometer reading.');
      return;
    }
    const readingNum = Number(readingTrim);
    if (!Number.isFinite(readingNum)) {
      setOdometerError('Odometer reading must be a valid number.');
      return;
    }
    if (!/^\d{4}-\d{2}-\d{2}$/.test(dateTrim)) {
      setOdometerError('Please provide a valid date.');
      return;
    }
    const isoDate = `${dateTrim}T00:00:00.000Z`;

    try {
      setIsSavingOdometer(true);
      setOdometerError(null);
      const targetRef = ref(db, `assets/${currentUser.UserId}/${asset.key}`);
      const prior = Array.isArray(asset.odometer) ? asset.odometer : [];
      const next = [...prior, { odometer: readingNum, date: isoDate }];
      await update(targetRef, { odometer: next });
      setEditingOdometerFor(null);
      setOdometerDraft({ reading: '', date: '' });
    } catch (err) {
      console.error('Failed to save odometer', err);
      setOdometerError('Unable to save odometer reading. Please try again.');
    } finally {
      setIsSavingOdometer(false);
    }
  };

  if (loading || !currentUser) {
    return (
      <Layout>
        <div className='flex min-h-screen items-center justify-center'>
          <div className='text-center'>
            <div className='mx-auto h-12 w-12 animate-spin rounded-full border-b-2 border-blue-600' />
            <p className='mt-4 text-gray-600'>Loading your assets...</p>
          </div>
        </div>
      </Layout>
    );
  }

  return (
    <Layout>
      <div className='min-h-screen bg-gray-100'>
        <header className='bg-white shadow'>
          <div className='max-w-7xl mx-auto px-4 py-4 flex justify-between items-center'>
            <h1 className='text-2xl font-bold text-blue-600'>My Assets</h1>
          </div>
        </header>

        <main className='relative max-w-7xl mx-auto px-4 py-6'>
          <button
            type='button'
            onClick={() => setShowForm(true)}
            className='absolute top-6 right-6 z-10 p-4 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition-colors shadow-lg'
            aria-label='Add New Asset'
            title='Add New Asset'
          >
            <svg
              className='w-6 h-6'
              fill='none'
              stroke='currentColor'
              viewBox='0 0 24 24'
            >
              <path
                strokeLinecap='round'
                strokeLinejoin='round'
                strokeWidth={2}
                d='M12 4v16m8-8H4'
              />
            </svg>
          </button>

          {assets.length === 0 && !showForm && (
            <div className='text-center py-12'>
              <svg
                className='mx-auto h-12 w-12 text-gray-400'
                fill='none'
                stroke='currentColor'
                viewBox='0 0 24 24'
              >
                <path
                  strokeLinecap='round'
                  strokeLinejoin='round'
                  strokeWidth={2}
                  d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'
                />
              </svg>
              <h3 className='mt-2 text-sm font-medium text-gray-900'>
                No assets
              </h3>
              <p className='mt-1 text-sm text-gray-500'>
                Get started by adding your first asset.
              </p>
              <div className='mt-6'>
                <button
                  onClick={() => setShowForm(true)}
                  className='inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700'
                >
                  Add Asset
                </button>
              </div>
            </div>
          )}

          {showForm && (
            <div className='bg-white p-6 rounded-lg shadow mb-6'>
              <h3 className='text-lg font-medium mb-4'>Add New Asset</h3>
              <select
                value={selectedAsset}
                onChange={(e) => {
                  const value = e.target.value;
                  setSelectedAsset(value);
                  if (value === 'bike' || value === 'household') {
                    setFormData((prev) => ({
                      ...prev,
                      vin: '',
                    }));
                  }
                }}
                className='mb-4 w-full rounded border border-gray-300 bg-white p-2 text-black focus:border-blue-500 focus:bg-white focus:text-black focus:outline-none focus:ring-1 focus:ring-blue-500'
              >
                <option value=''>Select Asset Type</option>
                <option value='vehicle'>Vehicle</option>
                <option value='bike'>Bike</option>
                <option value='household'>Household Item</option>
              </select>

              {selectedAsset && (
              <form onSubmit={handleSubmit} className='space-y-4'>
                <div className='grid grid-cols-1 md:grid-cols-2 gap-4'>
                  <div>
                    <label className='block text-sm font-medium text-gray-700'>
                      Make
                    </label>
                    <input
                      type='text'
                      name='make'
                      value={formData.make}
                      onChange={handleInputChange}
                      required
                      className='mb-4 w-full rounded border border-gray-300 bg-white p-2 text-black focus:border-blue-500 focus:bg-white focus:text-black focus:outline-none focus:ring-1 focus:ring-blue-500'
                    />
                  </div>
                  <div>
                    <label className='block text-sm font-medium text-gray-700'>
                      Model
                    </label>
                    <input
                      type='text'
                      name='model'
                      value={formData.model}
                      onChange={handleInputChange}
                      required
                      className='mb-4 w-full rounded border border-gray-300 bg-white p-2 text-black focus:border-blue-500 focus:bg-white focus:text-black focus:outline-none focus:ring-1 focus:ring-blue-500'
                    />
                  </div>
                  <div>
                    <label className='block text-sm font-medium text-gray-700'>
                      Year
                    </label>
                    <select
                      name='year'
                      value={formData.year ?? ''}
                      onChange={(e) =>
                        setFormData((prev) => ({
                          ...prev,
                          year: e.target.value ? Number(e.target.value) : undefined,
                        }))
                      }
                      className='mb-4 w-full rounded border border-gray-300 bg-white p-2 text-black focus:border-blue-500 focus:bg-white focus:text-black focus:outline-none focus:ring-1 focus:ring-blue-500'
                    >
                      <option value=''>Select Year</option>
                      {yearOptions.map((y) => (
                        <option key={y} value={y}>
                          {y}
                        </option>
                      ))}
                    </select>
                  </div>
                  {selectedAsset !== 'bike' && selectedAsset !== 'household' && (
                   <div>
                       <label className='block text-sm font-medium text-gray-700'>
                         VIN
                       </label>
                       <input
                         type='text'
                         name='vin'
                         value={formData.vin}
                         onChange={handleInputChange}
                         required
                         className='mb-4 w-full rounded border border-gray-300 bg-white p-2 text-black focus:border-blue-500 focus:bg-white focus:text-black focus:outline-none focus:ring-1 focus:ring-blue-500'
                       />
                     </div>
                   )}
                  <div className='md:col-span-2'>
                    <div className='flex flex-wrap gap-3'>
                      {!showInsuranceForm && (
                        <button
                          type='button'
                          onClick={() => setShowInsuranceForm(true)}
                          className='inline-flex items-center rounded-md border border-blue-300 bg-blue-50 px-3 py-2 text-sm font-medium text-blue-700 hover:bg-blue-100'
                        >
                          Add Insurance
                        </button>
                      )}
                      {!showWarrantyForm && (
                        <button
                          type='button'
                          onClick={() => setShowWarrantyForm(true)}
                          className='inline-flex items-center rounded-md border border-amber-300 bg-amber-50 px-3 py-2 text-sm font-medium text-amber-700 hover:bg-amber-100'
                        >
                          Add Warranty
                        </button>
                      )}
                    </div>
                    {showInsuranceForm && (
                      <div className='mt-3 grid grid-cols-1 md:grid-cols-2 gap-4'>
                        <div>
                          <label className='block text-sm font-medium text-gray-700'>
                            Insurance Company
                          </label>
                          <input
                            type='text'
                            name='insuranceCompany'
                            value={formData.insuranceCompany ?? ''}
                            onChange={handleInputChange}
                            className='mb-4 w-full rounded border border-gray-300 bg-white p-2 text-black focus:border-blue-500 focus:bg-white focus:text-black focus:outline-none focus:ring-1 focus:ring-blue-500'
                          />
                        </div>
                        <div>
                          <label className='block text-sm font-medium text-gray-700'>
                            Insurance Policy Number
                          </label>
                          <input
                            type='text'
                            name='insurancePolicyNumber'
                            value={formData.insurancePolicyNumber ?? ''}
                            onChange={handleInputChange}
                            className='mb-4 w-full rounded border border-gray-300 bg-white p-2 text-black focus:border-blue-500 focus:bg-white focus:text-black focus:outline-none focus:ring-1 focus:ring-blue-500'
                          />
                        </div>
                        <div>
                          <label className='block text-sm font-medium text-gray-700'>
                            Insurance Expiration Date
                          </label>
                          <input
                            type='date'
                            name='insuranceExpirationDate'
                            value={(formData.insuranceExpirationDate as string) ?? ''}
                            onChange={handleInputChange}
                            className='mb-4 w-full rounded border border-gray-300 bg-white p-2 text-black focus:border-blue-500 focus:bg-white focus:text-black focus:outline-none focus:ring-1 focus:ring-blue-500'
                          />
                        </div>
                      </div>
                    )}
                    {showWarrantyForm && (
                      <div className='mt-3 grid grid-cols-1 md:grid-cols-2 gap-4'>
                        <div className='flex items-center gap-2 md:col-span-2'>
                          <input
                            id='warranty'
                            name='warranty'
                            type='checkbox'
                            checked={Boolean(formData.warranty)}
                            onChange={(e) =>
                              setFormData((prev) => ({
                                ...prev,
                                warranty: e.target.checked,
                              }))
                            }
                            className='h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500'
                          />
                          <label htmlFor='warranty' className='text-sm font-medium text-gray-700'>
                            Under Warranty
                          </label>
                        </div>
                        {formData.warranty && (
                          <>
                            <div>
                              <label className='block text-sm font-medium text-gray-700'>
                                Warranty Number
                              </label>
                              <input
                                type='text'
                                name='warrantyNumber'
                                value={formData.warrantyNumber ?? ''}
                                onChange={handleInputChange}
                                className='mb-4 w-full rounded border border-gray-300 bg-white p-2 text-black focus:border-blue-500 focus:bg-white focus:text-black focus:outline-none focus:ring-1 focus:ring-blue-500'
                              />
                            </div>
                            <div>
                              <label className='block text-sm font-medium text-gray-700'>
                                Warranty Phone Number
                              </label>
                              <input
                                type='tel'
                                name='warrantyPhone'
                                value={formData.warrantyPhone ?? ''}
                                onChange={handleInputChange}
                                className='mb-4 w-full rounded border border-gray-300 bg-white p-2 text-black focus:border-blue-500 focus:bg-white focus:text-black focus:outline-none focus:ring-1 focus:ring-blue-500'
                                placeholder='e.g. (800) 555-1234'
                              />
                            </div>
                            <div className='md:col-span-2'>
                              <label className='block text-sm font-medium text-gray-700'>
                                Warranty Notes
                              </label>
                              <textarea
                                name='warrantyNotes'
                                value={formData.warrantyNotes ?? ''}
                                onChange={handleInputChange}
                                rows={3}
                                className='mb-4 w-full rounded border border-gray-300 bg-white p-2 text-black focus:border-blue-500 focus:bg-white focus:text-black focus:outline-none focus:ring-1 focus:ring-blue-500'
                                placeholder='Any additional warranty details'
                              />
                            </div>
                            <div>
                              <label className='block text-sm font-medium text-gray-700'>
                                Warranty End Date
                              </label>
                              <input
                                type='date'
                                name='warrantyExpiry'
                                value={(formData.warrantyExpiry as string) ?? ''}
                                onChange={handleInputChange}
                                className='mb-4 w-full rounded border border-gray-300 bg-white p-2 text-black focus:border-blue-500 focus:bg-white focus:text-black focus:outline-none focus:ring-1 focus:ring-blue-500'
                              />
                            </div>
                          </>
                        )}
                      </div>
                    )}
                  </div>
                </div>
                <div className='flex space-x-4'>
                  <button
                    type='submit'
                    className='bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700'
                  >
                    Add Asset
                  </button>
                  <button
                    type='button'
                    onClick={() => { setShowForm(false); setShowInsuranceForm(false); setShowWarrantyForm(false); }}
                    className='bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400'
                  >
                    Cancel
                  </button>
                </div>
              </form>
              )}
            </div>
          )}

          {groupedAssets.map(({ category, items }) => (
            <div key={category} className='mt-8'>
              <div className='mb-2'>
                <div className='text-xs font-medium uppercase tracking-wide text-gray-500'>
                  Category
                </div>
                <div className='text-lg font-semibold text-gray-900'>
                  {categoryLabel[category] ?? category}
                </div>
              </div>
              <div className='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'>
                {items.map((asset) => (
                  <div
                    key={asset.key}
                    onClick={() =>
                      router.push(
                        `/homedetail/${asset.key}?category=${encodeURIComponent(
                          asset.category || category || ''
                        )}`
                      )
                    }
                    className='bg-white rounded-md shadow-sm cursor-pointer hover:shadow transition-shadow'
                  >
                    <div className='p-2'>
                      <div className='flex items-start justify-between'>
                        <div>
                          <h3 className='text-base font-semibold text-gray-900'>
                            {asset.make}
                          </h3>
                          <p className='text-sm text-gray-600'>
                            {asset.model} {asset.year}
                          </p>
                        </div>
                        {category === 'vehicle' && (
                          <button
                            type='button'
                            onClick={(e) => {
                              e.stopPropagation();
                              openOdometerEditor(asset);
                            }}
                            className='inline-flex items-center rounded-md border border-blue-400 px-2 py-1 text-xs font-medium text-blue-700 hover:bg-blue-50'
                            aria-label='Add odometer reading'
                            title='Add Odometer'
                          >
                            Add Odometer
                          </button>
                        )}
                      </div>
                      <div className='mt-1 text-sm text-gray-500'>
                        <p>VIN: {asset.vin || 'Not set'}</p>
                        <p>Plate: {asset.plate || 'Not set'}</p>
                        {(() => {
                          const latest = formatLatestOdometer(asset);
                          if (!latest) return null;
                          const ninety = 90 * 24 * 60 * 60 * 1000;
                          const stale = latest.dateMs !== undefined && Date.now() - latest.dateMs > ninety;
                          return (
                            <>
                              <p>
                                Odometer: {latest.number}
                                {latest.date ? ` (${latest.date})` : ''}
                              </p>
                              {category === 'vehicle' && stale && (
                                <p className='text-xs text-red-600 mt-1'>
                                  Odometer reading is older than 90 days. Please update.
                                </p>
                              )}
                            </>
                          );
                        })()}
                      </div>
                      {category === 'vehicle' && editingOdometerFor === asset.key && (
                        <form
                          onClick={(e) => e.stopPropagation()}
                          onSubmit={(e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            void handleOdometerSave(asset);
                          }}
                          className='mt-2 space-y-2 border-t border-gray-200 pt-2'
                        >
                          <div className='grid grid-cols-1 gap-2'>
                            <div>
                              <label className='block text-xs font-medium text-gray-700'>Current Odometer</label>
                              <input
                                type='number'
                                inputMode='numeric'
                                value={odometerDraft.reading}
                                onChange={(e) => setOdometerDraft((p) => ({ ...p, reading: e.target.value }))}
                                className='mt-1 w-full rounded border border-gray-300 bg-white p-2 text-sm text-gray-900'
                                placeholder='e.g. 45231'
                              />
                            </div>
                            <div>
                              <label className='block text-xs font-medium text-gray-700'>Date of Reading</label>
                              <input
                                type='date'
                                value={odometerDraft.date}
                                onChange={(e) => setOdometerDraft((p) => ({ ...p, date: e.target.value }))}
                                className='mt-1 w-full rounded border border-gray-300 bg-white p-2 text-sm text-gray-900'
                              />
                            </div>
                          </div>
                          {odometerError && (
                            <p className='text-xs text-red-600'>{odometerError}</p>
                          )}
                          <div className='flex gap-2'>
                            <button
                              type='submit'
                              disabled={isSavingOdometer}
                              className='inline-flex items-center rounded bg-blue-600 px-3 py-1 text-sm font-medium text-white hover:bg-blue-700 disabled:opacity-60'
                            >
                              {isSavingOdometer ? 'Saving...' : 'Save'}
                            </button>
                            <button
                              type='button'
                              onClick={(e) => {
                                e.stopPropagation();
                                cancelOdometerEdit();
                              }}
                              className='inline-flex items-center rounded border border-gray-300 px-3 py-1 text-sm font-medium text-gray-700 hover:bg-gray-100'
                            >
                              Cancel
                            </button>
                          </div>
                        </form>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ))}

          {assets.length > 0 && (
            <button
              onClick={() => setShowForm(true)}
              className='fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700'
            >
              <svg
                className='w-6 h-6'
                fill='none'
                stroke='currentColor'
                viewBox='0 0 24 24'
              >
                <path
                  strokeLinecap='round'
                  strokeLinejoin='round'
                  strokeWidth={2}
                  d='M12 4v16m8-8H4'
                />
              </svg>
            </button>
          )}
        </main>
      </div>
    </Layout>
  );
}
=== File End: app/home/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/homedetail/[id]/page.tsx ===
// src/app/homedetail/[id]/page.tsx
'use client';

import {
  useCallback,
  useEffect,
  useMemo,
  useState,
  type ChangeEvent,
  type FormEvent,
  type MouseEvent,
} from 'react';
import {
  flexRender,
  getCoreRowModel,
  getSortedRowModel,
  useReactTable,
  type ColumnDef,
  type SortingState,
} from '@tanstack/react-table';
import Link from 'next/link';
import { useRouter, useSearchParams } from 'next/navigation';
import { onValue, ref, remove, set, update } from 'firebase/database';
import Layout from '../../../components/layout/Layout';
import { useAuth } from '../../../contexts/AuthContext';
import { db } from '../../../lib/firebase';
import {
  Vehicle,
  type Maintenance,
  type Part,
  type Video,
} from '../../../models/Vehicle';
import { Calendar, Check, Pencil, Plus, Trash2, X, Play } from 'lucide-react';

interface PageProps {
  params: {
    id: string;
  };
}

interface MaintenanceFormEntry {
  maintenanceType: string;
  maintenanceDesc: string;
  maintenanceEndDate: string;
}

interface PartFormEntry {
  part: string;
  url: string;
  date: string;
}

interface VideoFormEntry {
  name: string;
  url: string;
}

interface GenerateDescriptionResponse {
  result?: string;
  attempts?: number;
  maxAttempts?: number;
  partial?: boolean;
  error?: string;
}

interface QuickInfoRow {
  id: string;
  event: string;
  reading: string;
  date: string;
  source: 'odometer' | 'oilChange';
  sourceIndex: number;
  rawReading: number | null;
  rawDate: string;
}

type OverviewDetailColumn = 'primary' | 'secondary';

interface OverviewDetailEntry {
  label: string;
  value: string;
  column: OverviewDetailColumn;
  alwaysShow?: boolean;
  placeholder?: string;
  displayValue?: string;
}

const MAX_AI_GENERATION_ATTEMPTS = 3;
const AI_RETRY_DELAY_MS = 800;

export default function HomeDetailPage({ params }: PageProps) {
  const { id } = params;
  const { currentUser, loading } = useAuth();
  const router = useRouter();
  const searchParams = useSearchParams();
  const [asset, setAsset] = useState<Vehicle | null>(null);
  const [isFetching, setIsFetching] = useState(true);
  const [isEditing, setIsEditing] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [errorMessage, setErrorMessage] = useState<string | null>(null);
  const [formState, setFormState] = useState({
    make: '',
    model: '',
    year: '',
    vin: '',
    plate: '',
    tires: '',
    tireSize: '',
    tirePressure: '',
    oilType: '',
    category: searchParams.get('category') ?? '',
    warranty: false,
    warrantyNumber: '',
    warrantyPhone: '',
    warrantyNotes: '',
    warrantyExpiry: '',
    insuranceCompany: '',
    insurancePolicyNumber: '',
    insuranceExpirationDate: '',
  });
  const [quickInfoError, setQuickInfoError] = useState<string | null>(null);
  const [editingQuickInfoRowId, setEditingQuickInfoRowId] = useState<
    string | null
  >(null);
  const [quickInfoRowDraft, setQuickInfoRowDraft] = useState({
    reading: '',
    date: '',
  });
  const [isSavingQuickInfoRow, setIsSavingQuickInfoRow] = useState(false);
  const [isQuickInfoAddMenuOpen, setIsQuickInfoAddMenuOpen] = useState(false);
  const [quickInfoAddType, setQuickInfoAddType] = useState<
    'odometer' | 'oilChange' | null
  >(null);
  const [quickInfoAddForm, setQuickInfoAddForm] = useState({
    reading: '',
    date: '',
  });
  const [isSavingQuickInfoAddition, setIsSavingQuickInfoAddition] =
    useState(false);
  const [isDeletingQuickInfoRow, setIsDeletingQuickInfoRow] = useState(false);
  const [isEditingMaintenance, setIsEditingMaintenance] = useState(false);
  const [isSavingMaintenance, setIsSavingMaintenance] = useState(false);
  const [maintenanceError, setMaintenanceError] = useState<string | null>(null);
  const [maintenanceFormState, setMaintenanceFormState] = useState<
    MaintenanceFormEntry[]
  >([]);
  const [isDeleting, setIsDeleting] = useState(false);
  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
  const [isEditingParts, setIsEditingParts] = useState(false);
  const [isSavingParts, setIsSavingParts] = useState(false);
  const [partsError, setPartsError] = useState<string | null>(null);
  const [isEditingNotes, setIsEditingNotes] = useState(false);
  const [isSavingNotes, setIsSavingNotes] = useState(false);
  const [notesError, setNotesError] = useState<string | null>(null);
  const [notesDraft, setNotesDraft] = useState('');
  const [isNotesExpanded, setIsNotesExpanded] = useState(false);
  const [isNotesModalOpen, setIsNotesModalOpen] = useState(false);
  const [partFormState, setPartFormState] = useState<PartFormEntry[]>([]);
  const [editingPartRowId, setEditingPartRowId] = useState<number | null>(null);
  const [editingPartDraft, setEditingPartDraft] =
    useState<PartFormEntry | null>(null);

  // Videos state
  const [videoAddUrl, setVideoAddUrl] = useState('');
  const [videoAddTitle, setVideoAddTitle] = useState('');
  const [videoAddError, setVideoAddError] = useState<string | null>(null);
  const [isAddingVideo, setIsAddingVideo] = useState(false);
  const [selectedVideoId, setSelectedVideoId] = useState<string | null>(null);
  const [editingVideoRowId, setEditingVideoRowId] = useState<number | null>(
    null
  );
  const [editingVideoDraft, setEditingVideoDraft] =
    useState<VideoFormEntry | null>(null);
  const [isUpdatingVideo, setIsUpdatingVideo] = useState(false);
  const [updateVideoError, setUpdateVideoError] = useState<string | null>(null);
  const [isPro, setIsPro] = useState(false);
  const [isUpdatingPart, setIsUpdatingPart] = useState(false);
  const [updatePartError, setUpdatePartError] = useState<string | null>(null);
  const [partSorting, setPartSorting] = useState<SortingState>([]);
  const [quickInfoSorting, setQuickInfoSorting] = useState<SortingState>([]);
  const [videoSorting, setVideoSorting] = useState<SortingState>([]);
  const [aiDescription, setAiDescription] = useState<string | null>(null);
  const [isGeneratingAiDescription, setIsGeneratingAiDescription] =
    useState(false);
  const [aiDescriptionError, setAiDescriptionError] = useState<string | null>(
    null
  );
  const [aiGenerationStats, setAiGenerationStats] = useState<{
    attempts: number;
    maxAttempts: number;
  } | null>(null);
  const [descriptionSourceOverride, setDescriptionSourceOverride] = useState<
    string | null
  >(null);
  const [activeAiPartName, setActiveAiPartName] = useState<string | null>(null);
  const [deleteModalMode, setDeleteModalMode] = useState<
    'asset' | 'part' | 'quickInfo' | 'video' | null
  >(null);
  const [pendingPartDeleteIndex, setPendingPartDeleteIndex] = useState<
    number | null
  >(null);
  const [pendingPartDeleteName, setPendingPartDeleteName] = useState<
    string | null
  >(null);
  const [pendingQuickInfoDeleteRow, setPendingQuickInfoDeleteRow] =
    useState<QuickInfoRow | null>(null);

  const [pendingVideoDeleteIndex, setPendingVideoDeleteIndex] = useState<
    number | null
  >(null);
  const [pendingVideoDeleteName, setPendingVideoDeleteName] = useState<
    string | null
  >(null);
  const [pendingVideoDeleteKey, setPendingVideoDeleteKey] = useState<
    string | null
  >(null);

  // Part notes modal state
  const [isPartNoteModalOpen, setIsPartNoteModalOpen] = useState(false);
  const [activePartNoteIndex, setActivePartNoteIndex] = useState<number | null>(
    null
  );
  const [partNoteDraft, setPartNoteDraft] = useState('');
  const [partNoteError, setPartNoteError] = useState<string | null>(null);
  const [isSavingPartNote, setIsSavingPartNote] = useState(false);

  const buildMaintenanceFormState = (
    targetAsset: Vehicle | null
  ): MaintenanceFormEntry[] => {
    if (!targetAsset?.maintenance) return [];

    return targetAsset.maintenance.map((item) => {
      const dueDate =
        item.maintenanceEndDate &&
        !Number.isNaN(new Date(item.maintenanceEndDate).getTime())
          ? new Date(item.maintenanceEndDate).toISOString().split('T')[0]
          : '';

      return {
        maintenanceType: item.maintenanceType ?? '',
        maintenanceDesc: item.maintenanceDesc ?? '',
        maintenanceEndDate: dueDate,
      };
    });
  };

  useEffect(() => {
    if (!currentUser) {
      setAsset(null);
      setIsFetching(false);
      return;
    }

    const itemRef = ref(db, `assets/${currentUser.UserId}/${id}`);
    const unsubscribe = onValue(
      itemRef,
      (snapshot) => {
        setAsset(snapshot.exists() ? snapshot.val() : null);
        setIsFetching(false);
      },
      () => {
        setAsset(null);
        setIsFetching(false);
      }
    );

    return () => unsubscribe();
  }, [currentUser, id]);

  useEffect(() => {
    if (!asset) {
      setFormState({
        make: '',
        model: '',
        year: '',
        vin: '',
        plate: '',
        tires: '',
        tireSize: '',
        tirePressure: '',
        oilType: '',
        category: searchParams.get('category') ?? '',
        warranty: false,
        warrantyNumber: '',
        warrantyPhone: '',
        warrantyNotes: '',
        warrantyExpiry: '',
        insuranceCompany: '',
        insurancePolicyNumber: '',
        insuranceExpirationDate: '',
      });
      setMaintenanceFormState([]);
      setEditingQuickInfoRowId(null);
      setQuickInfoRowDraft({ reading: '', date: '' });
      setIsSavingQuickInfoRow(false);
      setIsEditingMaintenance(searchParams.get('edit') === 'maintenance');
      setIsEditingParts(false);
      setIsEditingNotes(false);
      setIsSavingNotes(false);
      setNotesError(null);
      setNotesDraft('');
      setIsNotesExpanded(false);
      setQuickInfoError(null);
      setIsQuickInfoAddMenuOpen(false);
      setQuickInfoAddType(null);
      setQuickInfoAddForm({ reading: '', date: '' });
      setIsSavingQuickInfoAddition(false);
      setIsDeletingQuickInfoRow(false);
      setMaintenanceError(null);
      setIsDeleting(false);
      setPartFormState([]);
      setPartsError(null);
      setEditingPartRowId(null);
      setEditingPartDraft(null);
      setIsUpdatingPart(false);
      setUpdatePartError(null);
      setPartSorting([]);
      setQuickInfoSorting([]);
      setIsDeleteModalOpen(false);
      setDeleteModalMode(null);
      setPendingPartDeleteIndex(null);
      setPendingPartDeleteName(null);
      setPendingQuickInfoDeleteRow(null);
      // Reset videos state
      setVideoAddUrl('');
      setVideoAddTitle('');
      setVideoAddError(null);
      setIsAddingVideo(false);
      setSelectedVideoId(null);
      setEditingVideoRowId(null);
      setEditingVideoDraft(null);
      setIsUpdatingVideo(false);
      setUpdateVideoError(null);
      setVideoSorting([]);
      setPendingVideoDeleteIndex(null);
      setPendingVideoDeleteName(null);
      setPendingVideoDeleteKey(null);
      return;
    }

    setFormState({
      make: asset.make ?? '',
      model: asset.model ?? '',
      year: asset.year?.toString() ?? '',
      vin: asset.vin ?? '',
      plate: asset.plate ?? '',
      tires: asset.tires ?? '',
      tireSize: asset.tireSize ?? '',
      tirePressure: asset.tirePressure ?? '',
      oilType: asset.oilType ?? '',
      category: asset.category ?? searchParams.get('category') ?? '',
      warranty: Boolean(asset.warranty),
      warrantyNumber: asset.warrantyNumber ?? '',
      warrantyPhone: asset.warrantyPhone ?? '',
      warrantyNotes: asset.warrantyNotes ?? '',
      warrantyExpiry:
        asset.warrantyExpiry &&
        !Number.isNaN(new Date(asset.warrantyExpiry as any).getTime())
          ? new Date(asset.warrantyExpiry as any).toISOString().split('T')[0]
          : '',
      insuranceCompany: asset.insuranceCompany ?? '',
      insurancePolicyNumber: asset.insurancePolicyNumber ?? '',
      insuranceExpirationDate:
        asset.insuranceExpirationDate &&
        !Number.isNaN(new Date(asset.insuranceExpirationDate as any).getTime())
          ? new Date(asset.insuranceExpirationDate as any)
              .toISOString()
              .split('T')[0]
          : '',
    });
    const nextMaintenanceState = buildMaintenanceFormState(asset);
    if (
      searchParams.get('edit') === 'maintenance' &&
      nextMaintenanceState.length === 0
    ) {
      setMaintenanceFormState([
        { maintenanceType: '', maintenanceDesc: '', maintenanceEndDate: '' },
      ]);
    } else {
      setMaintenanceFormState(nextMaintenanceState);
    }
    setEditingQuickInfoRowId(null);
    setQuickInfoRowDraft({ reading: '', date: '' });
    setIsSavingQuickInfoRow(false);
    setIsEditingMaintenance(searchParams.get('edit') === 'maintenance');
    setIsEditingParts(false);
    setIsEditingNotes(false);
    setIsSavingNotes(false);
    setNotesError(null);
    setNotesDraft(asset.notes ?? '');
    setIsNotesExpanded(false);
    setQuickInfoError(null);
    setIsQuickInfoAddMenuOpen(false);
    setQuickInfoAddType(null);
    setQuickInfoAddForm({ reading: '', date: '' });
    setIsSavingQuickInfoAddition(false);
    setIsDeletingQuickInfoRow(false);
    setMaintenanceError(null);
    setIsDeleting(false);
    setPartFormState([]);
    setPartsError(null);
    setEditingPartRowId(null);
    setEditingPartDraft(null);
    setIsUpdatingPart(false);
    setUpdatePartError(null);
    setIsDeleteModalOpen(false);
    setDeleteModalMode(null);
    setPendingPartDeleteIndex(null);
    setPendingPartDeleteName(null);
    setPendingQuickInfoDeleteRow(null);
    // Initialize videos state
    setVideoAddUrl('');
    setVideoAddTitle('');
    setVideoAddError(null);
    setIsAddingVideo(false);
    setEditingVideoRowId(null);
    setEditingVideoDraft(null);
    setIsUpdatingVideo(false);
    setUpdateVideoError(null);
    setVideoSorting([]);
    setPendingVideoDeleteIndex(null);
    setPendingVideoDeleteName(null);
    setPendingVideoDeleteKey(null);
    // Do not auto-select a YouTube video by default.
    setSelectedVideoId(null);
  }, [asset]);

  // Open the Part Note modal for a specific row
  const openPartNoteModal = useCallback(
    (index: number) => {
      setPartNoteError(null);
      setActivePartNoteIndex(index);
      const existing = asset?.partNumber?.[index]?.note ?? '';
      setPartNoteDraft(typeof existing === 'string' ? existing : '');
      setIsPartNoteModalOpen(true);
    },
    [asset]
  );

  // Save the Part Note for the active row
  const handleSavePartNote = useCallback(
    async (event: FormEvent<HTMLFormElement>) => {
      event.preventDefault();
      if (!asset || !currentUser || activePartNoteIndex === null) return;
      if (isSavingPartNote) return;

      setIsSavingPartNote(true);
      setPartNoteError(null);
      try {
        const trimmed = partNoteDraft.trim();
        const noteRef = ref(
          db,
          `assets/${currentUser.UserId}/${id}/partNumber/${activePartNoteIndex}`
        );
        await update(noteRef, { note: trimmed ? trimmed : null });
        setIsPartNoteModalOpen(false);
        setActivePartNoteIndex(null);
      } catch (error) {
        console.error('Failed to save part note', error);
        setPartNoteError('Unable to save note. Please try again.');
      } finally {
        setIsSavingPartNote(false);
      }
    },
    [
      asset,
      currentUser,
      id,
      activePartNoteIndex,
      isSavingPartNote,
      partNoteDraft,
    ]
  );

  // Scroll maintenance section into view when linked with ?edit=maintenance
  useEffect(() => {
    if (searchParams.get('edit') === 'maintenance') {
      if (typeof window !== 'undefined') {
        const section = document.getElementById('maintenance-section');
        section?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
  }, [asset, searchParams]);

  // Load Pro membership from localStorage (set by subscription flow)
  useEffect(() => {
    if (typeof window === 'undefined') return;
    try {
      const saved = window.localStorage.getItem(
        'assetmanagement-settings-preferences'
      );
      if (!saved) {
        setIsPro(false);
        return;
      }
      const parsed = JSON.parse(saved);
      setIsPro(Boolean(parsed?.proPlanActive));
    } catch {
      setIsPro(false);
    }
  }, []);

  const handleRecallClick = useCallback(
    (event: MouseEvent<HTMLAnchorElement>) => {
      if (!isPro) {
        event.preventDefault();
        router.push('/asset-manager-pro');
      }
    },
    [isPro, router]
  );

  // Helpers: YouTube ID extractor
  const extractYouTubeId = (input: string): string | null => {
    const url = input?.trim();
    if (!url) return null;
    try {
      const u = new URL(url);
      const host = u.hostname.toLowerCase();
      // youtu.be/<id>
      if (host.includes('youtu.be')) {
        const parts = u.pathname.split('/').filter(Boolean);
        return parts[0] || null;
      }
      // youtube.com URLs
      if (host.includes('youtube.com')) {
        // /watch?v=<id>
        if (u.pathname.startsWith('/watch')) {
          const v = u.searchParams.get('v');
          if (v) return v;
        }
        const parts = u.pathname.split('/').filter(Boolean);
        // /embed/<id>
        const embedIndex = parts.indexOf('embed');
        if (embedIndex !== -1 && parts[embedIndex + 1]) {
          return parts[embedIndex + 1];
        }
        // /shorts/<id>
        const shortsIndex = parts.indexOf('shorts');
        if (shortsIndex !== -1 && parts[shortsIndex + 1]) {
          return parts[shortsIndex + 1];
        }
      }
      return null;
    } catch {
      return null;
    }
  };

  const handleFieldChange = (
    event: ChangeEvent<HTMLInputElement | HTMLSelectElement>
  ) => {
    const { name, value } = event.target;
    setFormState((prev) => ({ ...prev, [name]: value }));
  };

  const handleSave = async (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    if (!currentUser || !asset) return;

    setIsSaving(true);
    setErrorMessage(null);

    try {
      const targetRef = ref(db, `assets/${currentUser.UserId}/${id}`);

      // Build a shallow patch and use update() to avoid overwriting unrelated fields.
      const toIsoOrNull = (v: string): string | null => {
        if (!v) return null;
        const d = new Date(v);
        return Number.isNaN(d.getTime()) ? null : d.toISOString();
      };

      const warrantyOn = Boolean(formState.warranty);
      const patch: Record<string, unknown> = {
        make: formState.make.trim(),
        model: formState.model.trim(),
        year: formState.year ? Number(formState.year) : null,
        vin: formState.vin.trim(),
        plate: formState.plate.trim(),
        tires: formState.tires.trim(),
        tireSize: formState.tireSize.trim(),
        tirePressure: formState.tirePressure.trim(),
        oilType: formState.oilType.trim(),
        category: formState.category.trim(),
        warranty: warrantyOn,
        warrantyNumber: warrantyOn
          ? formState.warrantyNumber.trim() || null
          : null,
        warrantyPhone: warrantyOn
          ? formState.warrantyPhone.trim() || null
          : null,
        warrantyNotes: warrantyOn
          ? formState.warrantyNotes.trim() || null
          : null,
        warrantyExpiry: warrantyOn
          ? toIsoOrNull(formState.warrantyExpiry)
          : null,
        insuranceCompany: formState.insuranceCompany.trim(),
        insurancePolicyNumber: formState.insurancePolicyNumber.trim(),
        insuranceExpirationDate: toIsoOrNull(formState.insuranceExpirationDate),
      };

      await update(targetRef, patch);
      setIsEditing(false);
    } catch (error) {
      console.error('Failed to update asset', error);
      setErrorMessage('Unable to save changes. Please try again.');
    } finally {
      setIsSaving(false);
    }
  };

  const handleMaintenanceFieldChange = (
    index: number,
    field: keyof MaintenanceFormEntry,
    value: string
  ) => {
    setMaintenanceFormState((prev) => {
      const next = [...prev];
      next[index] = { ...next[index], [field]: value };
      return next;
    });
  };

  const handleAddMaintenanceEntry = () => {
    setMaintenanceFormState((prev) => [
      ...prev,
      { maintenanceType: '', maintenanceDesc: '', maintenanceEndDate: '' },
    ]);
  };

  const handleRemoveMaintenanceEntry = (index: number) => {
    setMaintenanceFormState((prev) => prev.filter((_, i) => i !== index));
  };

  const handleMaintenanceSave = async (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    if (!currentUser || !asset) return;

    const sanitizedEntries: Maintenance[] = [];
    for (const entry of maintenanceFormState) {
      const trimmedType = entry.maintenanceType.trim();
      const trimmedDesc = entry.maintenanceDesc.trim();
      const dateValue = entry.maintenanceEndDate.trim();

      let isoMaintenanceDate: string | undefined;
      if (dateValue) {
        const parsedDate = new Date(dateValue);
        if (Number.isNaN(parsedDate.getTime())) {
          setMaintenanceError(
            'Please provide valid dates for maintenance items.'
          );
          return;
        }
        isoMaintenanceDate = parsedDate.toISOString();
      }

      if (trimmedType || trimmedDesc || isoMaintenanceDate) {
        sanitizedEntries.push({
          maintenanceType: trimmedType || undefined,
          maintenanceDesc: trimmedDesc || undefined,
          maintenanceEndDate: isoMaintenanceDate,
        });
      }
    }

    setIsSavingMaintenance(true);
    setMaintenanceError(null);

    try {
      const targetRef = ref(db, `assets/${currentUser.UserId}/${id}`);
      const updatedAsset: Vehicle = {
        ...asset,
        maintenance: sanitizedEntries,
      };

      await set(targetRef, updatedAsset);
      setIsEditingMaintenance(false);
    } catch (error) {
      console.error('Failed to update maintenance entries', error);
      setMaintenanceError(
        'Unable to save maintenance changes. Please try again.'
      );
    } finally {
      setIsSavingMaintenance(false);
    }
  };

  const openDeleteModal = () => {
    if (isDeleting) return;
    setErrorMessage(null);
    setDeleteModalMode('asset');
    setIsDeleteModalOpen(true);
  };

  const handleDeleteAsset = async () => {
    if (!currentUser || !asset || isDeleting) return;
    setIsDeleting(true);
    setErrorMessage(null);

    try {
      const targetRef = ref(db, `assets/${currentUser.UserId}/${id}`);
      await remove(targetRef);
      setIsDeleteModalOpen(false);
      setDeleteModalMode(null);
      router.push('/home');
    } catch (error) {
      console.error('Failed to delete asset', error);
      setErrorMessage('Unable to delete this asset. Please try again later.');
    } finally {
      setIsDeleting(false);
    }
  };

  const handleCancelDelete = () => {
    if (deleteModalMode === 'asset' && isDeleting) {
      return;
    }
    if (deleteModalMode === 'part' && isUpdatingPart) {
      return;
    }
    if (deleteModalMode === 'quickInfo' && isDeletingQuickInfoRow) {
      return;
    }
    if (deleteModalMode === 'video' && isUpdatingVideo) {
      return;
    }
    setIsDeleteModalOpen(false);
    setDeleteModalMode(null);
    setPendingPartDeleteIndex(null);
    setPendingPartDeleteName(null);
    setPendingQuickInfoDeleteRow(null);
    setPendingVideoDeleteIndex(null);
    setPendingVideoDeleteName(null);
    setPendingVideoDeleteKey(null);
  };

  const handlePartFieldChange = (
    index: number,
    field: keyof PartFormEntry,
    value: string
  ) => {
    setPartFormState((prev) => {
      const next = [...prev];
      next[index] = { ...next[index], [field]: value };
      return next;
    });
  };

  const openPartDeleteModal = useCallback(
    (index: number) => {
      if (isUpdatingPart) return;
      setUpdatePartError(null);

      const targetPart = asset?.partNumber?.[index] ?? null;
      const partLabel =
        targetPart?.part?.trim() || targetPart?.type?.trim() || null;

      setPendingPartDeleteIndex(index);
      setPendingPartDeleteName(partLabel);
      setDeleteModalMode('part');
      setIsDeleteModalOpen(true);
    },
    [asset, isUpdatingPart]
  );

  const handleAddPartEntry = () => {
    setIsEditingParts(true);
    setPartsError(null);
    setEditingPartRowId(null);
    setEditingPartDraft(null);
    setUpdatePartError(null);
    setPartFormState((prev) => {
      const base = isEditingParts ? prev : [];
      return [...base, { part: '', url: '', date: '' }];
    });
  };

  const handleRemovePartEntry = (index: number) => {
    setPartFormState((prev) => {
      const next = prev.filter((_, i) => i !== index);
      if (next.length === 0) {
        setIsEditingParts(false);
        setPartsError(null);
      }
      return next;
    });
  };

  const handleNotesSave = async (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    if (!currentUser || !asset) return;

    setIsSavingNotes(true);
    setNotesError(null);
    try {
      const targetRef = ref(db, `assets/${currentUser.UserId}/${id}`);
      const updatedAsset: Vehicle & Record<string, unknown> = {
        ...asset,
        notes: notesDraft.trim() ? notesDraft.trim() : undefined,
      };
      const sanitizedAsset = JSON.parse(JSON.stringify(updatedAsset));
      await set(targetRef, sanitizedAsset);
      setIsEditingNotes(false);
      setIsNotesModalOpen(false);
    } catch (error) {
      console.error('Failed to save notes', error);
      setNotesError('Unable to save notes. Please try again.');
    } finally {
      setIsSavingNotes(false);
    }
  };

  const handlePartsSave = async (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    if (!currentUser || !asset) return;

    const sanitizedEntries: Part[] = [];
    for (const entry of partFormState) {
      const trimmedPart = entry.part.trim();
      const trimmedUrl = entry.url.trim();
      const dateValue = entry.date.trim();

      let isoDate: string | undefined;
      if (dateValue) {
        const parsedDate = new Date(dateValue);
        if (Number.isNaN(parsedDate.getTime())) {
          setPartsError('Please provide valid dates for parts.');
          return;
        }
        isoDate = parsedDate.toISOString();
      }

      if (trimmedPart || trimmedUrl || isoDate) {
        sanitizedEntries.push({
          part: trimmedPart || undefined,
          url: trimmedUrl || undefined,
          date: isoDate,
        });
      }
    }

    setIsSavingParts(true);
    setPartsError(null);

    if (sanitizedEntries.length === 0) {
      setIsSavingParts(false);
      setPartsError('Please add at least one part before saving.');
      return;
    }

    try {
      const targetRef = ref(db, `assets/${currentUser.UserId}/${id}`);
      const mergedParts: Part[] = [
        ...(asset.partNumber ?? []),
        ...sanitizedEntries,
      ];
      const updatedAsset: Vehicle = {
        ...asset,
        partNumber: mergedParts,
      };

      const sanitizedAsset = JSON.parse(JSON.stringify(updatedAsset));
      await set(targetRef, sanitizedAsset);
      setIsEditingParts(false);
      setPartFormState([]);
    } catch (error) {
      console.error('Failed to update parts list', error);
      setPartsError('Unable to save parts. Please try again.');
    } finally {
      setIsSavingParts(false);
    }
  };

  const startEditingPart = useCallback((index: number, part: Part) => {
    const parsedDate =
      part.date && !Number.isNaN(new Date(part.date).getTime())
        ? new Date(part.date).toISOString().split('T')[0]
        : '';

    setEditingPartRowId(index);
    setEditingPartDraft({
      part: part.part ?? '',
      url: part.url ?? '',
      date: parsedDate,
    });
    setUpdatePartError(null);
  }, []);

  const cancelEditingPart = useCallback(() => {
    setEditingPartRowId(null);
    setEditingPartDraft(null);
    setUpdatePartError(null);
  }, []);

  const handlePartDraftChange = useCallback(
    (field: keyof PartFormEntry, value: string) => {
      setEditingPartDraft((prev) =>
        prev ? { ...prev, [field]: value } : prev
      );
    },
    []
  );

  const saveEditingPart = useCallback(
    async (index: number) => {
      if (
        editingPartRowId !== index ||
        !editingPartDraft ||
        !asset ||
        !currentUser
      ) {
        return;
      }

      const trimmedPart = editingPartDraft.part.trim();
      const trimmedUrl = editingPartDraft.url.trim();
      const dateValue = editingPartDraft.date.trim();

      let isoDate: string | undefined;
      if (dateValue) {
        const parsedDate = new Date(dateValue);
        if (Number.isNaN(parsedDate.getTime())) {
          setUpdatePartError('Please provide a valid date for this part.');
          return;
        }
        isoDate = parsedDate.toISOString();
      }

      if (!trimmedPart && !trimmedUrl && !isoDate) {
        setUpdatePartError('Part details cannot be completely empty.');
        return;
      }

      setIsUpdatingPart(true);
      setUpdatePartError(null);

      try {
        const updatedParts: Part[] = [...(asset.partNumber ?? [])];
        if (!updatedParts[index]) {
          setUpdatePartError(
            'Unable to locate this part. Please refresh and try again.'
          );
          setIsUpdatingPart(false);
          return;
        }

        updatedParts[index] = {
          ...updatedParts[index],
          part: trimmedPart || undefined,
          url: trimmedUrl || undefined,
          date: isoDate,
        };

        const targetRef = ref(db, `assets/${currentUser.UserId}/${id}`);
        const updatedAsset = { ...asset, partNumber: updatedParts } as Vehicle &
          Record<string, unknown>;
        const sanitizedAsset = JSON.parse(JSON.stringify(updatedAsset));
        await set(targetRef, sanitizedAsset);

        setEditingPartRowId(null);
        setEditingPartDraft(null);
      } catch (error) {
        console.error('Failed to update part', error);
        setUpdatePartError('Unable to save this part. Please try again.');
      } finally {
        setIsUpdatingPart(false);
      }
    },
    [asset, currentUser, editingPartDraft, editingPartRowId, id]
  );

  const handleDeleteQuickInfoRow = useCallback(
    async (row: QuickInfoRow) => {
      if (!asset || !currentUser || isDeletingQuickInfoRow) {
        return;
      }

      setIsDeletingQuickInfoRow(true);
      setQuickInfoError(null);

      try {
        const odometerEntries = [...(asset.odometer ?? [])];
        const oilChangeEntries = [...(asset.oilChange ?? [])];

        if (row.source === 'odometer') {
          if (!odometerEntries[row.sourceIndex]) {
            setQuickInfoError(
              'Unable to locate this odometer record. Please refresh and try again.'
            );
            setIsDeletingQuickInfoRow(false);
            return;
          }
          odometerEntries.splice(row.sourceIndex, 1);
        } else {
          if (!oilChangeEntries[row.sourceIndex]) {
            setQuickInfoError(
              'Unable to locate this oil change record. Please refresh and try again.'
            );
            setIsDeletingQuickInfoRow(false);
            return;
          }
          oilChangeEntries.splice(row.sourceIndex, 1);
        }

        const targetRef = ref(db, `assets/${currentUser.UserId}/${id}`);
        const updatedAsset: Vehicle & Record<string, unknown> = {
          ...asset,
          odometer: odometerEntries.length > 0 ? odometerEntries : undefined,
          oilChange: oilChangeEntries.length > 0 ? oilChangeEntries : undefined,
        };

        const sanitizedAsset = JSON.parse(
          JSON.stringify(updatedAsset)
        ) as Vehicle;

        await set(targetRef, sanitizedAsset);
        setAsset(sanitizedAsset);
        if (editingQuickInfoRowId === row.id) {
          setEditingQuickInfoRowId(null);
          setQuickInfoRowDraft({ reading: '', date: '' });
        }
        setPendingQuickInfoDeleteRow(null);
        setDeleteModalMode(null);
        setIsDeleteModalOpen(false);
      } catch (error) {
        console.error('Failed to delete quick info entry', error);
        setQuickInfoError('Unable to delete this entry. Please try again.');
      } finally {
        setIsDeletingQuickInfoRow(false);
      }
    },
    [
      asset,
      currentUser,
      id,
      isDeletingQuickInfoRow,
      editingQuickInfoRowId,
      setAsset,
      setEditingQuickInfoRowId,
      setQuickInfoRowDraft,
      setQuickInfoError,
    ]
  );

  const openQuickInfoAddForm = useCallback((type: 'odometer' | 'oilChange') => {
    setQuickInfoError(null);
    setQuickInfoAddForm({ reading: '', date: '' });
    setQuickInfoAddType(type);
    setIsQuickInfoAddMenuOpen(false);
    setEditingQuickInfoRowId(null);
    setQuickInfoRowDraft({ reading: '', date: '' });
  }, []);

  const openQuickInfoDeleteModal = useCallback(
    (row: QuickInfoRow) => {
      if (isDeletingQuickInfoRow) return;
      setQuickInfoError(null);
      setQuickInfoAddType(null);
      setQuickInfoAddForm({ reading: '', date: '' });
      setIsQuickInfoAddMenuOpen(false);
      if (editingQuickInfoRowId === row.id) {
        setEditingQuickInfoRowId(null);
        setQuickInfoRowDraft({ reading: '', date: '' });
      }
      setPendingQuickInfoDeleteRow(row);
      setDeleteModalMode('quickInfo');
      setIsDeleteModalOpen(true);
    },
    [editingQuickInfoRowId, isDeletingQuickInfoRow]
  );

  const handleQuickInfoAddFieldChange = useCallback(
    (field: 'reading' | 'date', value: string) => {
      setQuickInfoAddForm((prev) => ({ ...prev, [field]: value }));
    },
    []
  );

  const handleQuickInfoAddCancel = useCallback(() => {
    if (isSavingQuickInfoAddition) return;
    setQuickInfoAddType(null);
    setQuickInfoAddForm({ reading: '', date: '' });
    setQuickInfoError(null);
    setIsQuickInfoAddMenuOpen(false);
  }, [isSavingQuickInfoAddition]);

  const handleQuickInfoAddSubmit = useCallback(
    async (event: FormEvent<HTMLFormElement>) => {
      event.preventDefault();
      if (!asset || !currentUser || !quickInfoAddType) {
        return;
      }

      const trimmedReading = quickInfoAddForm.reading.trim();
      const trimmedDate = quickInfoAddForm.date.trim();

      if (!trimmedDate) {
        setQuickInfoError('Please provide a date for this entry.');
        return;
      }

      if (!/^\d{4}-\d{2}-\d{2}$/.test(trimmedDate)) {
        setQuickInfoError('Please provide a valid date.');
        return;
      }
      const parsedTimestamp = Date.parse(`${trimmedDate}T00:00:00Z`);
      if (Number.isNaN(parsedTimestamp)) {
        setQuickInfoError('Please provide a valid date.');
        return;
      }
      const isoDate = `${trimmedDate}T00:00:00.000Z`;

      let numericReading: number | undefined;
      if (trimmedReading) {
        const numeric = Number(trimmedReading);
        if (Number.isNaN(numeric)) {
          setQuickInfoError('Odometer reading must be a valid number.');
          return;
        }
        numericReading = numeric;
      }

      if (quickInfoAddType === 'odometer' && numericReading === undefined) {
        setQuickInfoError('Odometer reading is required for this entry.');
        return;
      }

      setIsSavingQuickInfoAddition(true);
      setQuickInfoError(null);

      try {
        const odometerEntries = [...(asset.odometer ?? [])];
        const oilChangeEntries = [...(asset.oilChange ?? [])];

        if (quickInfoAddType === 'odometer') {
          odometerEntries.push({
            odometer: numericReading,
            date: isoDate,
          });
        } else {
          oilChangeEntries.push({
            date: isoDate,
            odometer: numericReading,
          });
        }

        const targetRef = ref(db, `assets/${currentUser.UserId}/${id}`);
        const updatedAsset: Vehicle & Record<string, unknown> = {
          ...asset,
          odometer: odometerEntries.length > 0 ? odometerEntries : undefined,
          oilChange: oilChangeEntries.length > 0 ? oilChangeEntries : undefined,
        };

        const sanitizedAsset = JSON.parse(
          JSON.stringify(updatedAsset)
        ) as Vehicle;

        await set(targetRef, sanitizedAsset);
        setAsset(sanitizedAsset);
        setQuickInfoAddType(null);
        setQuickInfoAddForm({ reading: '', date: '' });
      } catch (error) {
        console.error('Failed to add quick info entry', error);
        setQuickInfoError('Unable to add this entry. Please try again.');
      } finally {
        setIsSavingQuickInfoAddition(false);
      }
    },
    [
      asset,
      currentUser,
      id,
      quickInfoAddForm.date,
      quickInfoAddForm.reading,
      quickInfoAddType,
    ]
  );

  const startEditingQuickInfoRow = useCallback(
    (row: QuickInfoRow) => {
      if (isSavingQuickInfoRow || isDeletingQuickInfoRow) {
        return;
      }
      setQuickInfoError(null);
      setEditingQuickInfoRowId(row.id);
      setQuickInfoRowDraft({
        reading: row.rawReading !== null ? String(row.rawReading) : '',
        date: row.rawDate,
      });
      setQuickInfoAddType(null);
      setQuickInfoAddForm({ reading: '', date: '' });
      setIsQuickInfoAddMenuOpen(false);
    },
    [isDeletingQuickInfoRow, isSavingQuickInfoRow]
  );

  const cancelEditingQuickInfoRow = useCallback(() => {
    if (isSavingQuickInfoRow) return;
    setEditingQuickInfoRowId(null);
    setQuickInfoRowDraft({ reading: '', date: '' });
    setQuickInfoError(null);
  }, [isSavingQuickInfoRow]);

  const handleQuickInfoRowDraftChange = useCallback(
    (field: 'reading' | 'date', value: string) => {
      setQuickInfoRowDraft((prev) => ({ ...prev, [field]: value }));
    },
    []
  );

  const saveQuickInfoRow = useCallback(
    async (row: QuickInfoRow) => {
      if (
        !asset ||
        !currentUser ||
        editingQuickInfoRowId !== row.id ||
        isSavingQuickInfoRow
      ) {
        return;
      }

      const trimmedReading = quickInfoRowDraft.reading.trim();
      const trimmedDate = quickInfoRowDraft.date.trim();

      if (!trimmedDate) {
        setQuickInfoError('Please provide a date for this entry.');
        return;
      }
      if (!/^\d{4}-\d{2}-\d{2}$/.test(trimmedDate)) {
        setQuickInfoError('Please provide a valid date.');
        return;
      }
      const parsedTimestamp = Date.parse(`${trimmedDate}T00:00:00Z`);
      if (Number.isNaN(parsedTimestamp)) {
        setQuickInfoError('Please provide a valid date.');
        return;
      }
      const isoDate = `${trimmedDate}T00:00:00.000Z`;

      let numericReading: number | undefined;
      if (trimmedReading) {
        const numeric = Number(trimmedReading);
        if (Number.isNaN(numeric)) {
          setQuickInfoError('Odometer reading must be a valid number.');
          return;
        }
        numericReading = numeric;
      }

      if (row.source === 'odometer' && numericReading === undefined) {
        setQuickInfoError('Odometer reading is required for this entry.');
        return;
      }

      setIsSavingQuickInfoRow(true);
      setQuickInfoError(null);

      try {
        const odometerEntries = [...(asset.odometer ?? [])];
        const oilChangeEntries = [...(asset.oilChange ?? [])];

        if (row.source === 'odometer') {
          if (!odometerEntries[row.sourceIndex]) {
            setQuickInfoError(
              'Unable to locate this odometer record. Please refresh and try again.'
            );
            return;
          }
          const nextEntry: Record<string, unknown> = {
            ...odometerEntries[row.sourceIndex],
          };
          nextEntry.odometer = numericReading;
          nextEntry.date = isoDate;
          odometerEntries[row.sourceIndex] = nextEntry;
        } else {
          if (!oilChangeEntries[row.sourceIndex]) {
            setQuickInfoError(
              'Unable to locate this oil change record. Please refresh and try again.'
            );
            return;
          }
          const nextEntry: Record<string, unknown> = {
            ...oilChangeEntries[row.sourceIndex],
          };
          nextEntry.date = isoDate;
          if (numericReading !== undefined) {
            nextEntry.odometer = numericReading;
          } else {
            delete nextEntry.odometer;
          }
          oilChangeEntries[row.sourceIndex] = nextEntry;
        }

        const targetRef = ref(db, `assets/${currentUser.UserId}/${id}`);
        const updatedAsset: Vehicle & Record<string, unknown> = {
          ...asset,
          odometer: odometerEntries.length > 0 ? odometerEntries : undefined,
          oilChange: oilChangeEntries.length > 0 ? oilChangeEntries : undefined,
        };

        const sanitizedAsset = JSON.parse(
          JSON.stringify(updatedAsset)
        ) as Vehicle;

        await set(targetRef, sanitizedAsset);
        setAsset(sanitizedAsset);
        setEditingQuickInfoRowId(null);
        setQuickInfoRowDraft({ reading: '', date: '' });
      } catch (error) {
        console.error('Failed to update quick info entry', error);
        setQuickInfoError('Unable to save this entry. Please try again.');
      } finally {
        setIsSavingQuickInfoRow(false);
      }
    },
    [
      asset,
      currentUser,
      editingQuickInfoRowId,
      id,
      isSavingQuickInfoRow,
      quickInfoRowDraft.date,
      quickInfoRowDraft.reading,
    ]
  );

  const numberFormatter = useMemo(() => new Intl.NumberFormat(), []);

  const quickInfoVehicleLabel = useMemo(() => {
    if (!asset) return 'Vehicle';

    const parts = [asset.year, asset.make, asset.model]
      .filter(
        (value) =>
          value !== undefined &&
          value !== null &&
          String(value).trim().length > 0
      )
      .map((value) => String(value).trim());

    if (parts.length > 0) {
      return parts.join(' ');
    }

    if (asset.vin && asset.vin.trim().length > 0) {
      return asset.vin.trim();
    }

    return asset.category?.trim() || 'Vehicle';
  }, [asset]);

  const headerModelYear = useMemo(() => {
    if (!asset) return '';

    const parts = [asset.model, asset.year]
      .filter(
        (value) =>
          value !== undefined &&
          value !== null &&
          String(value).trim().length > 0
      )
      .map((value) => String(value).trim());

    return parts.join(' / ');
  }, [asset]);

  const quickInfoRows = useMemo<QuickInfoRow[]>(() => {
    if (!asset) return [];

    const formatReading = (value: unknown): string => {
      if (typeof value === 'number' && Number.isFinite(value)) {
        return numberFormatter.format(value);
      }

      if (
        typeof value === 'string' &&
        value.trim().length > 0 &&
        !Number.isNaN(Number(value))
      ) {
        return numberFormatter.format(Number(value));
      }

      return 'N/A';
    };

    const toInputDate = (input: unknown): string => {
      if (input === null || input === undefined || input === '') {
        return '';
      }

      if (typeof input === 'string') {
        const match = input.match(/^(\d{4}-\d{2}-\d{2})(?:T.*)?$/);
        if (match) {
          return match[1];
        }
      }

      const parsed =
        input instanceof Date ? input : new Date(input as string | number);

      if (Number.isNaN(parsed.getTime())) {
        return '';
      }

      return parsed.toISOString().split('T')[0] ?? '';
    };

    const formatWithUtc = (date: Date) =>
      new Intl.DateTimeFormat(undefined, {
        year: 'numeric',
        month: 'numeric',
        day: 'numeric',
        timeZone: 'UTC',
      }).format(date);

    const formatDate = (input: unknown): string => {
      const inputDate = toInputDate(input);
      if (!inputDate) {
        return 'N/A';
      }
      const [year, month, day] = inputDate.split('-').map(Number);
      if (Number.isNaN(year) || Number.isNaN(month) || Number.isNaN(day)) {
        return 'N/A';
      }
      return formatWithUtc(new Date(Date.UTC(year, month - 1, day)));
    };

    const resolveNumeric = (value: unknown): number | null => {
      if (typeof value === 'number' && Number.isFinite(value)) {
        return value;
      }
      if (
        typeof value === 'string' &&
        value.trim().length > 0 &&
        !Number.isNaN(Number(value))
      ) {
        return Number(value);
      }
      return null;
    };

    const rows: QuickInfoRow[] = [];

    (asset.odometer ?? []).forEach((entry, index) => {
      const rawReading = resolveNumeric(entry.odometer);
      const rawDate = toInputDate(entry.date ?? entry.reading);

      rows.push({
        id: `odometer-${index}`,
        event: entry.type?.trim() || 'Odometer Reading',
        reading: formatReading(entry.odometer),
        date: formatDate(entry.date ?? entry.reading),
        source: 'odometer',
        sourceIndex: index,
        rawReading,
        rawDate,
      });
    });

    (asset.oilChange ?? []).forEach((entry, index) => {
      const rawReading = resolveNumeric(entry.odometer);
      const rawDate = toInputDate(entry.date);

      rows.push({
        id: `oil-change-${index}`,
        event: 'Oil Change',
        reading: formatReading(entry.odometer),
        date: formatDate(entry.date),
        source: 'oilChange',
        sourceIndex: index,
        rawReading,
        rawDate,
      });
    });

    return rows;
  }, [asset, numberFormatter]);

  const quickInfoColumns = useMemo<ColumnDef<QuickInfoRow>[]>(() => {
    const sortingIndicator = (direction: 'asc' | 'desc' | false) => {
      if (direction === 'asc') return '^';
      if (direction === 'desc') return 'v';
      return '';
    };

    const formatNextActionDate = (inputRawDate: string): string => {
      if (!inputRawDate) return 'N/A';
      const parts = inputRawDate.split('-');
      if (parts.length !== 3) return 'N/A';
      const [yStr, mStr, dStr] = parts;
      const y = Number(yStr);
      const m = Number(mStr);
      const d = Number(dStr);
      if (Number.isNaN(y) || Number.isNaN(m) || Number.isNaN(d)) {
        return 'N/A';
      }
      const next = new Date(Date.UTC(y, m - 1 + 8, d));
      return new Intl.DateTimeFormat(undefined, {
        year: 'numeric',
        month: 'numeric',
        day: 'numeric',
        timeZone: 'UTC',
      }).format(next);
    };

    const isNextActionDateOverdue = (inputRawDate: string): boolean => {
      if (!inputRawDate) return false;
      const parts = inputRawDate.split('-');
      if (parts.length !== 3) return false;
      const [yStr, mStr, dStr] = parts;
      const y = Number(yStr);
      const m = Number(mStr);
      const d = Number(dStr);
      if (Number.isNaN(y) || Number.isNaN(m) || Number.isNaN(d)) return false;
      const nextTs = Date.UTC(y, m - 1 + 8, d);
      if (!Number.isFinite(nextTs)) return false;
      const now = new Date();
      const todayTs = Date.UTC(
        now.getUTCFullYear(),
        now.getUTCMonth(),
        now.getUTCDate()
      );
      return todayTs > nextTs;
    };

    // Determine the latest raw date per source to avoid flagging older rows
    const latestRawBySource: Record<
      'odometer' | 'oilChange',
      string | undefined
    > = {
      odometer: undefined,
      oilChange: undefined,
    };
    for (const r of quickInfoRows) {
      const raw = r.rawDate;
      if (!raw) continue;
      const prev = latestRawBySource[r.source];
      if (!prev || raw > prev) {
        latestRawBySource[r.source] = raw;
      }
    }

    return [
      {
        accessorKey: 'event',
        header: ({ column }) => (
          <button
            type='button'
            onClick={column.getToggleSortingHandler()}
            className='flex items-center gap-1 text-xs font-semibold uppercase tracking-wide text-gray-600'
          >
            Event
            <span className='text-gray-400'>
              {sortingIndicator(column.getIsSorted())}
            </span>
          </button>
        ),
        cell: ({ row }) => (
          <span className='text-sm font-medium text-gray-900'>
            {row.original.event}
          </span>
        ),
      },
      {
        accessorKey: 'reading',
        header: ({ column }) => (
          <button
            type='button'
            onClick={column.getToggleSortingHandler()}
            className='flex items-center gap-1 text-xs font-semibold uppercase tracking-wide text-gray-600'
          >
            Reading
            <span className='text-gray-400'>
              {sortingIndicator(column.getIsSorted())}
            </span>
          </button>
        ),
        cell: ({ row }) => {
          const isEditingRow = editingQuickInfoRowId === row.original.id;
          if (isEditingRow) {
            return (
              <input
                type='number'
                step='any'
                value={quickInfoRowDraft.reading}
                onChange={(event) =>
                  handleQuickInfoRowDraftChange('reading', event.target.value)
                }
                className='w-full rounded-md border border-gray-300 bg-white px-2 py-1 text-sm text-gray-900'
                placeholder='Enter reading'
              />
            );
          }
          return (
            <span className='text-sm text-gray-700'>
              {row.original.reading}
            </span>
          );
        },
      },
      {
        accessorKey: 'date',
        header: ({ column }) => (
          <button
            type='button'
            onClick={column.getToggleSortingHandler()}
            className='flex items-center gap-1 text-xs font-semibold uppercase tracking-wide text-gray-600'
          >
            Date
            <span className='text-gray-400'>
              {sortingIndicator(column.getIsSorted())}
            </span>
          </button>
        ),
        cell: ({ row }) => {
          const isEditingRow = editingQuickInfoRowId === row.original.id;
          if (isEditingRow) {
            return (
              <div className='relative'>
                <Calendar
                  className='absolute left-2 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400'
                  onMouseDown={(e) => {
                    e.preventDefault();
                    const input = e.currentTarget.parentElement?.querySelector(
                      "input[type='date']"
                    ) as HTMLInputElement | null;
                    if (input) {
                      try {
                        (input as any).showPicker?.();
                      } catch {}
                      input.focus();
                      input.click();
                    }
                  }}
                />
                <input
                  type='date'
                  value={quickInfoRowDraft.date}
                  onChange={(event) =>
                    handleQuickInfoRowDraftChange('date', event.target.value)
                  }
                  onClick={(e) => {
                    try {
                      (e.currentTarget as any).showPicker?.();
                    } catch {}
                  }}
                  className='w-full rounded-md border border-gray-300 bg-white pl-8 pr-2 py-1 text-sm text-gray-900'
                />
              </div>
            );
          }
          return (
            <span className='text-sm text-gray-700'>{row.original.date}</span>
          );
        },
      },
      {
        id: 'nextActionDate',
        enableSorting: false,
        header: () => (
          <span className='text-xs font-semibold uppercase tracking-wide text-gray-600'>
            Action Date
          </span>
        ),
        cell: ({ row }) => {
          const isEditingRow = editingQuickInfoRowId === row.original.id;
          const baseRaw = isEditingRow
            ? quickInfoRowDraft.date
            : row.original.rawDate;
          const display = formatNextActionDate(baseRaw);
          const overdue = isNextActionDateOverdue(baseRaw);
          const isLatestForSource =
            !!baseRaw && baseRaw === latestRawBySource[row.original.source];
          const shouldWarn = overdue && display !== 'N/A' && isLatestForSource;
          if (shouldWarn) {
            return (
              <span className='inline-flex items-center rounded-full border border-red-200 bg-red-50 px-2 py-0.5 text-xs font-semibold text-red-700'>
                {display}
              </span>
            );
          }
          return <span className='text-sm text-gray-700'>{display}</span>;
        },
      },
      {
        id: 'note',
        enableSorting: false,
        header: () => (
          <span className='text-xs font-semibold uppercase tracking-wide text-gray-600'>
            Note
          </span>
        ),
        cell: () => (
          <div className='flex justify-center'>
            <button
              type='button'
              onClick={() => {
                setNotesError(null);
                setNotesDraft(asset?.notes ?? '');
                setIsNotesModalOpen(true);
              }}
              className='inline-flex items-center rounded-full border border-gray-300 bg-gray-50 px-2 py-0.5 text-[11px] font-semibold text-gray-700'
              aria-label='Open notes'
            >
              Note
            </button>
          </div>
        ),
      },
      {
        id: 'actions',
        header: () => (
          <div className='text-center text-xs font-semibold uppercase tracking-wide text-gray-600'>
            Action
          </div>
        ),
        cell: ({ row }) => {
          const isEditingRow = editingQuickInfoRowId === row.original.id;
          return (
            <div className='flex items-center justify-center gap-2'>
              {!isEditingRow && (
                <button
                  type='button'
                  onClick={() => {
                    setQuickInfoError(null);
                    startEditingQuickInfoRow(row.original);
                  }}
                  className='rounded-full border border-gray-300 p-1 text-gray-600 transition hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50'
                  aria-label='Edit quick info entry'
                  disabled={isSavingQuickInfoRow || isDeletingQuickInfoRow}
                >
                  <Pencil className='h-4 w-4' />
                </button>
              )}
              {isEditingRow && (
                <button
                  type='button'
                  onClick={() => {
                    setQuickInfoError(null);
                    cancelEditingQuickInfoRow();
                  }}
                  className='rounded-full border border-gray-300 p-1 text-gray-600 transition hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50'
                  aria-label='Cancel quick info edit'
                  disabled={isSavingQuickInfoRow}
                >
                  <X className='h-4 w-4' />
                </button>
              )}
              {isEditingRow && (
                <button
                  type='button'
                  onClick={() => {
                    setQuickInfoError(null);
                    void saveQuickInfoRow(row.original);
                  }}
                  className='rounded-full border border-green-400 bg-green-50 p-1 text-green-700 transition hover:bg-green-100 disabled:cursor-not-allowed disabled:opacity-50'
                  aria-label='Save quick info entry'
                  disabled={isSavingQuickInfoRow || isDeletingQuickInfoRow}
                >
                  <Check className='h-4 w-4' />
                </button>
              )}
              <button
                type='button'
                onClick={() => {
                  setQuickInfoError(null);
                  openQuickInfoDeleteModal(row.original);
                }}
                className='rounded-full border border-red-400 bg-red-50 p-1 text-red-600 transition hover:bg-red-100 disabled:cursor-not-allowed disabled:opacity-50'
                aria-label='Delete quick info entry'
                disabled={isDeletingQuickInfoRow || isSavingQuickInfoRow}
              >
                <Trash2 className='h-4 w-4' />
              </button>
            </div>
          );
        },
      },
    ];
  }, [
    cancelEditingQuickInfoRow,
    editingQuickInfoRowId,
    handleQuickInfoRowDraftChange,
    isDeletingQuickInfoRow,
    isSavingQuickInfoRow,
    openQuickInfoDeleteModal,
    quickInfoRowDraft.date,
    quickInfoRowDraft.reading,
    saveQuickInfoRow,
    startEditingQuickInfoRow,
    quickInfoRows,
  ]);

  const detailEntries = useMemo(() => {
    if (!asset) {
      return {
        primary: [] as OverviewDetailEntry[],
        secondary: [] as OverviewDetailEntry[],
      };
    }

    const normalizeValue = (value: unknown): string => {
      if (value === undefined || value === null) {
        return '';
      }
      return String(value).trim();
    };

    const isHousehold =
      (asset.category ?? '').toString().toLowerCase().trim() === 'household';
    const entries: OverviewDetailEntry[] = [];

    if (!isHousehold) {
      entries.push(
        {
          label: 'Tire Size',
          value: normalizeValue(asset.tireSize),
          column: 'primary',
          placeholder: 'Not set',
          alwaysShow: true,
        },
        {
          label: 'Tire Pressure',
          value: normalizeValue(asset.tirePressure),
          column: 'primary',
          placeholder: 'Not set',
          alwaysShow: true,
        },
        {
          label: 'Oil Type',
          value: normalizeValue(asset.oilType),
          column: 'primary',
          placeholder: 'Not set',
          alwaysShow: true,
        }
      );
    } else {
      const warrantyValue =
        typeof asset.warranty === 'boolean'
          ? asset.warranty
            ? 'Yes'
            : 'No'
          : '';
      let warrantyExpiry = '';
      if (asset.warrantyExpiry) {
        const d = new Date(asset.warrantyExpiry as any);
        if (!Number.isNaN(d.getTime())) {
          warrantyExpiry = d.toLocaleDateString();
        }
      }
      entries.push({
        label: 'Under Warranty',
        value: warrantyValue,
        column: 'primary',
        placeholder: 'Not set',
        alwaysShow: true,
      });
      if (asset.warranty) {
        if (asset.warrantyPhone) {
          entries.push({
            label: 'Warranty Phone',
            value: normalizeValue(asset.warrantyPhone),
            column: 'primary',
            placeholder: 'Not set',
          });
        }
        entries.push({
          label: 'Warranty Expiry',
          value: warrantyExpiry,
          column: 'primary',
          placeholder: 'Not set',
        });
        if (asset.warrantyNotes) {
          entries.push({
            label: 'Warranty Notes',
            value: normalizeValue(asset.warrantyNotes),
            column: 'primary',
            placeholder: 'Not set',
          });
        }
      }
    }

    entries.push(
      {
        label: 'VIN',
        value: normalizeValue(asset.vin),
        column: 'secondary',
      },
      {
        label: 'Plate',
        value: normalizeValue(asset.plate),
        column: 'secondary',
      }
    );

    const filtered = entries
      .filter((entry) => entry.alwaysShow || entry.value.length > 0)
      .map<OverviewDetailEntry>((entry) => ({
        ...entry,
        displayValue:
          entry.value.length > 0 ? entry.value : entry.placeholder ?? 'Not set',
      }));

    return {
      primary: filtered.filter((entry) => entry.column === 'primary'),
      secondary: filtered.filter((entry) => entry.column === 'secondary'),
    };
  }, [asset]);

  const hasDetailEntries =
    detailEntries.primary.length > 0 || detailEntries.secondary.length > 0;
  const hasSecondaryDetailEntries = detailEntries.secondary.length > 0;

  const descriptionSource = useMemo(() => {
    const override = descriptionSourceOverride?.trim();
    if (override) {
      return override;
    }
    if (!asset) return '';

    if (typeof asset.description === 'string') {
      const trimmed = asset.description.trim();
      if (trimmed.length > 0) {
        return trimmed;
      }
    }

    const summaryParts = [asset.year, asset.make, asset.model]
      .filter((value) => value !== undefined && value !== null && value !== '')
      .map((value) => String(value).trim())
      .filter((value) => value.length > 0);

    const summary = summaryParts.join(' ').trim();

    const details: string[] = [];

    if (summary) {
      details.push(`Asset: ${summary}`);
    }

    if (asset.category) {
      details.push(`Category: ${asset.category}`);
    }

    if (asset.tires) {
      details.push(`Tires: ${asset.tires}`);
    }

    return details.join('\n').trim();
  }, [asset, descriptionSourceOverride]);

  const hasDescriptionPrompt = descriptionSource.length > 0;

  useEffect(() => {
    setAiDescription(null);
    setAiDescriptionError(null);
    setAiGenerationStats(null);
  }, [id, descriptionSource]);

  useEffect(() => {
    setDescriptionSourceOverride(null);
    setActiveAiPartName(null);
  }, [id]);

  const generateAiDescription = useCallback(
    async (prompt: string, emptyPromptError?: string) => {
      const trimmedPrompt = prompt.trim();
      if (!trimmedPrompt) {
        setAiDescriptionError(
          emptyPromptError ??
            'Add some asset details or a short description first.'
        );
        return;
      }
      if (isGeneratingAiDescription) {
        return;
      }

      setIsGeneratingAiDescription(true);
      setAiDescriptionError(null);
      setAiDescription(null);
      setAiGenerationStats(null);

      let lastError: string | null = null;

      try {
        for (
          let attempt = 1;
          attempt <= MAX_AI_GENERATION_ATTEMPTS;
          attempt++
        ) {
          setAiGenerationStats({
            attempts: attempt,
            maxAttempts: MAX_AI_GENERATION_ATTEMPTS,
          });

          try {
            const response = await fetch('/api/generate-description', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Client-Retry': '1',
              },
              body: JSON.stringify({ prompt: trimmedPrompt }),
            });

            const payload = (await response
              .json()
              .catch(() => null)) as GenerateDescriptionResponse | null;

            if (!response.ok || !payload) {
              lastError =
                payload && typeof payload.error === 'string'
                  ? payload.error
                  : 'Unable to generate a detailed description right now.';
            } else {
              const text =
                typeof payload.result === 'string' ? payload.result.trim() : '';

              if (text) {
                setAiDescription(text);

                if (payload.partial) {
                  setAiDescriptionError(
                    'The AI response may be incomplete. Try refining the prompt.'
                  );
                } else {
                  setAiDescriptionError(null);
                }

                return;
              }

              lastError =
                payload && typeof payload.error === 'string'
                  ? payload.error
                  : 'The AI response did not include any content.';
            }
          } catch (error) {
            console.error('Failed to generate AI description', error);
            lastError =
              'We could not reach Google Generative AI. Please try again later.';
          }

          if (attempt < MAX_AI_GENERATION_ATTEMPTS) {
            await new Promise<void>((resolve) =>
              setTimeout(resolve, AI_RETRY_DELAY_MS * attempt)
            );
          }
        }

        setAiDescriptionError(
          lastError ?? 'Unable to generate a detailed description right now.'
        );
      } finally {
        setIsGeneratingAiDescription(false);
      }
    },
    [isGeneratingAiDescription]
  );

  const handleGenerateDetailedDescription = useCallback(() => {
    void generateAiDescription(
      descriptionSource,
      'Add some asset details or a short description first.'
    );
  }, [descriptionSource, generateAiDescription]);

  const handleAskAiAboutPart = useCallback(
    (part: Part) => {
      const partName = part.part?.trim() ?? '';
      const partType = part.type?.trim() ?? '';
      const partDescription =
        typeof part.description === 'string' ? part.description.trim() : '';

      const promptSegments: string[] = [];

      if (partDescription) {
        promptSegments.push(partDescription);
      }

      if (partName) {
        promptSegments.push(`Part Name: ${partName}`);
      }

      if (partType) {
        promptSegments.push(`Part Type: ${partType}`);
      }

      const prompt = promptSegments.join('\n').trim();

      if (prompt) {
        setDescriptionSourceOverride(prompt);
        setActiveAiPartName(partName || partType || null);
        void generateAiDescription(
          prompt,
          'Add some details about this part before asking AI.'
        );
      } else {
        setDescriptionSourceOverride(null);
        setActiveAiPartName(null);
        setAiDescription(null);
        setAiDescriptionError('No details are available for this part yet.');
      }
    },
    [generateAiDescription]
  );

  const handleDeletePart = useCallback(async () => {
    if (
      !asset ||
      !currentUser ||
      isUpdatingPart ||
      pendingPartDeleteIndex === null
    ) {
      return;
    }

    const sourceParts = asset.partNumber ?? [];

    if (!sourceParts[pendingPartDeleteIndex]) {
      setUpdatePartError(
        'Unable to locate this part. Please refresh and try again.'
      );
      setIsDeleteModalOpen(false);
      setDeleteModalMode(null);
      setPendingPartDeleteIndex(null);
      setPendingPartDeleteName(null);
      return;
    }

    setIsUpdatingPart(true);
    setUpdatePartError(null);

    try {
      const updatedParts = sourceParts.filter(
        (_, partIndex) => partIndex !== pendingPartDeleteIndex
      );
      const targetRef = ref(db, `assets/${currentUser.UserId}/${id}`);

      await set(targetRef, {
        ...asset,
        partNumber: updatedParts.length > 0 ? updatedParts : undefined,
      });

      if (editingPartRowId === pendingPartDeleteIndex) {
        setEditingPartRowId(null);
        setEditingPartDraft(null);
      }

      setIsDeleteModalOpen(false);
      setDeleteModalMode(null);
      setPendingPartDeleteIndex(null);
      setPendingPartDeleteName(null);
    } catch (error) {
      console.error('Failed to delete part', error);
      setUpdatePartError('Unable to delete this part. Please try again.');
    } finally {
      setIsUpdatingPart(false);
    }
  }, [
    asset,
    currentUser,
    editingPartRowId,
    id,
    isUpdatingPart,
    pendingPartDeleteIndex,
  ]);

  // Videos: edit/save/delete handlers
  const startEditingVideo = useCallback((index: number, video: Video) => {
    setEditingVideoRowId(index);
    setEditingVideoDraft({ name: video.name ?? '', url: video.url ?? '' });
    setUpdateVideoError(null);
  }, []);

  const cancelEditingVideo = useCallback(() => {
    setEditingVideoRowId(null);
    setEditingVideoDraft(null);
    setUpdateVideoError(null);
  }, []);

  const saveEditingVideo = useCallback(
    async (index: number) => {
      if (
        editingVideoRowId !== index ||
        !editingVideoDraft ||
        !asset ||
        !currentUser
      ) {
        return;
      }

      const trimmedName = editingVideoDraft.name.trim();
      const trimmedUrl = editingVideoDraft.url.trim();
      const ytId = extractYouTubeId(trimmedUrl);
      if (!ytId) {
        setUpdateVideoError('Please provide a valid YouTube URL.');
        return;
      }

      setIsUpdatingVideo(true);
      setUpdateVideoError(null);

      try {
        const updatedVideos: Video[] = [...(asset.videos ?? [])];
        if (!updatedVideos[index]) {
          setUpdateVideoError(
            'Unable to locate this video. Please refresh and try again.'
          );
          setIsUpdatingVideo(false);
          return;
        }

        updatedVideos[index] = {
          ...updatedVideos[index],
          name: trimmedName || undefined,
          url: trimmedUrl,
        };

        const targetRef = ref(db, `assets/${currentUser.UserId}/${id}`);
        const updatedAsset = { ...asset, videos: updatedVideos } as Vehicle &
          Record<string, unknown>;
        const sanitizedAsset = JSON.parse(JSON.stringify(updatedAsset));
        await set(targetRef, sanitizedAsset);

        setEditingVideoRowId(null);
        setEditingVideoDraft(null);
      } catch (error) {
        console.error('Failed to update video', error);
        setUpdateVideoError('Unable to save this video. Please try again.');
      } finally {
        setIsUpdatingVideo(false);
      }
    },
    [asset, currentUser, editingVideoDraft, editingVideoRowId, id]
  );

  const openVideoDeleteModal = useCallback(
    (index: number) => {
      if (isUpdatingVideo) return;
      setUpdateVideoError(null);

      const target = asset?.videos?.[index] ?? null;
      const titleLabel = target?.name?.trim() || null;

      setPendingVideoDeleteIndex(index);
      setPendingVideoDeleteName(titleLabel);
      if (target) {
        const key = `${(target.url ?? '').trim()}|${(
          target.name ?? ''
        ).trim()}`;
        setPendingVideoDeleteKey(key);
      } else {
        setPendingVideoDeleteKey(null);
      }
      setDeleteModalMode('video');
      setIsDeleteModalOpen(true);
    },
    [asset, isUpdatingVideo]
  );

  const handleDeleteVideo = useCallback(async () => {
    if (
      !asset ||
      !currentUser ||
      isUpdatingVideo ||
      pendingVideoDeleteIndex === null
    ) {
      return;
    }

    const sourceVideos = asset.videos ?? [];
    let deleteIndex = pendingVideoDeleteIndex;
    if (
      (deleteIndex === null || !sourceVideos[deleteIndex]) &&
      pendingVideoDeleteKey
    ) {
      deleteIndex = sourceVideos.findIndex(
        (v) =>
          `${(v.url ?? '').trim()}|${(v.name ?? '').trim()}` ===
          pendingVideoDeleteKey
      );
    }
    if (deleteIndex === null || deleteIndex < 0 || !sourceVideos[deleteIndex]) {
      setUpdateVideoError(
        'Unable to locate this video. Please refresh and try again.'
      );
      setIsDeleteModalOpen(false);
      setDeleteModalMode(null);
      setPendingVideoDeleteIndex(null);
      setPendingVideoDeleteName(null);
      setPendingVideoDeleteKey(null);
      return;
    }

    setIsUpdatingVideo(true);
    setUpdateVideoError(null);

    try {
      const updatedVideos = sourceVideos.filter(
        (_, vIndex) => vIndex !== deleteIndex
      );
      const targetRef = ref(db, `assets/${currentUser.UserId}/${id}`);
      const updatedAsset = {
        ...asset,
        videos: updatedVideos.length > 0 ? updatedVideos : undefined,
      } as Vehicle & Record<string, unknown>;
      const sanitized = JSON.parse(JSON.stringify(updatedAsset));
      await set(targetRef, sanitized);

      if (editingVideoRowId === deleteIndex) {
        setEditingVideoRowId(null);
        setEditingVideoDraft(null);
      }

      setIsDeleteModalOpen(false);
      setDeleteModalMode(null);
      setPendingVideoDeleteIndex(null);
      setPendingVideoDeleteName(null);
      setPendingVideoDeleteKey(null);
    } catch (error) {
      console.error('Failed to delete video', error);
      setUpdateVideoError('Unable to delete this video. Please try again.');
    } finally {
      setIsUpdatingVideo(false);
    }
  }, [
    asset,
    currentUser,
    editingVideoRowId,
    id,
    isUpdatingVideo,
    pendingVideoDeleteIndex,
    pendingVideoDeleteKey,
  ]);

  const handleResetDescriptionOverride = useCallback(() => {
    setDescriptionSourceOverride(null);
    setActiveAiPartName(null);
    setAiGenerationStats(null);
  }, []);

  const partColumns = useMemo<ColumnDef<Part>[]>(() => {
    const sortingIndicator = (direction: 'asc' | 'desc' | false) => {
      if (direction === 'asc') return '^';
      if (direction === 'desc') return 'v';
      return '';
    };

    return [
      {
        accessorKey: 'part',
        header: ({ column }) => (
          <button
            type='button'
            onClick={column.getToggleSortingHandler()}
            className='flex items-center gap-1 text-xs font-semibold uppercase tracking-wide text-gray-600'
          >
            Part
            <span className='text-gray-400'>
              {sortingIndicator(column.getIsSorted())}
            </span>
          </button>
        ),
        cell: ({ row }) => {
          const isEditing = editingPartRowId === row.index && editingPartDraft;
          if (isEditing) {
            return (
              <input
                value={editingPartDraft.part}
                onChange={(event) =>
                  handlePartDraftChange('part', event.target.value)
                }
                className='w-full rounded-md border border-gray-300 bg-white px-2 py-1 text-sm text-gray-900'
              />
            );
          }

          const { part, url } = row.original;
          const partName = part?.trim();
          if (!partName) {
            return '-';
          }

          const href =
            url?.trim() ||
            `https://www.amazon.com/s?k=${encodeURIComponent(partName)}`;

          return (
            <a
              href={href}
              target='_blank'
              rel='noopener noreferrer'
              className='text-sm font-medium text-blue-600 hover:text-blue-700'
            >
              {partName}
            </a>
          );
        },
      },
      // Type column removed
      {
        accessorKey: 'date',
        header: ({ column }) => (
          <button
            type='button'
            onClick={column.getToggleSortingHandler()}
            className='flex items-center gap-1 text-xs font-semibold uppercase tracking-wide text-gray-600'
          >
            Last Updated
            <span className='text-gray-400'>
              {sortingIndicator(column.getIsSorted())}
            </span>
          </button>
        ),
        cell: ({ row }) => {
          const isEditing = editingPartRowId === row.index && editingPartDraft;
          if (isEditing) {
            return (
              <div className='relative'>
                <Calendar
                  className='absolute left-2 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400'
                  onMouseDown={(e) => {
                    e.preventDefault();
                    const input = e.currentTarget.parentElement?.querySelector(
                      "input[type='date']"
                    ) as HTMLInputElement | null;
                    if (input) {
                      try {
                        (input as any).showPicker?.();
                      } catch {}
                      input.focus();
                      input.click();
                    }
                  }}
                />
                <input
                  type='date'
                  value={editingPartDraft.date}
                  onChange={(event) =>
                    handlePartDraftChange('date', event.target.value)
                  }
                  onClick={(e) => {
                    try {
                      (e.currentTarget as any).showPicker?.();
                    } catch {}
                  }}
                  className='w-full rounded-md border border-gray-300 bg-white pl-8 pr-2 py-1 text-sm text-gray-900'
                />
              </div>
            );
          }

          const rawDate = row.original.date;
          if (!rawDate) return '‚Äî';
          const parsedDate = new Date(rawDate);
          return Number.isNaN(parsedDate.getTime())
            ? '‚Äî'
            : parsedDate.toLocaleDateString();
        },
      },
      {
        accessorKey: 'url',
        header: ({ column }) => (
          <button
            type='button'
            onClick={column.getToggleSortingHandler()}
            className='mx-auto flex items-center justify-center gap-1 text-xs font-semibold uppercase tracking-wide text-gray-600'
          >
            ASK AI
            <span className='text-gray-400'>
              {sortingIndicator(column.getIsSorted())}
            </span>
          </button>
        ),
        cell: ({ row }) => {
          const isEditing = editingPartRowId === row.index && editingPartDraft;
          if (isEditing) {
            return (
              <div className='flex justify-center'>
                <input
                  value={editingPartDraft.url}
                  onChange={(event) =>
                    handlePartDraftChange('url', event.target.value)
                  }
                  className='w-full rounded-md border border-gray-300 bg-white px-2 py-1 text-sm text-gray-900'
                  placeholder='https://'
                />
              </div>
            );
          }

          const { part, description } = row.original;
          const hasAskAiDetails = Boolean(
            (part && part.trim()) ||
              (typeof description === 'string' && description.trim())
          );

          if (!hasAskAiDetails) {
            return (
              <div className='flex justify-center'>
                <span className='text-gray-400'>-</span>
              </div>
            );
          }

          return (
            <div className='flex justify-center'>
              <button
                type='button'
                onClick={() => handleAskAiAboutPart(row.original)}
                className='text-sm font-medium text-blue-600 hover:text-blue-700 focus:outline-none'
              >
                About this Product
              </button>
            </div>
          );
        },
      },
      {
        id: 'note',
        enableSorting: false,
        header: () => (
          <div className='text-center text-xs font-semibold uppercase tracking-wide text-gray-600'>
            Note
          </div>
        ),
        cell: ({ row }) => {
          const p = row.original as Part;
          const hasNote =
            typeof p.note === 'string' && p.note.trim().length > 0;
          const badgeClass = hasNote
            ? 'inline-flex items-center rounded-full border border-blue-300 bg-blue-50 px-2 py-0.5 text-[11px] font-semibold text-blue-700'
            : 'inline-flex items-center rounded-full border border-gray-300 bg-gray-50 px-2 py-0.5 text-[11px] font-semibold text-gray-700';
          return (
            <div className='flex justify-center'>
              <button
                type='button'
                onClick={() => openPartNoteModal(row.index)}
                className={badgeClass}
                aria-label='Add or edit note'
              >
                Note
              </button>
            </div>
          );
        },
      },
      {
        id: 'actions',
        header: () => (
          <div className='text-center text-xs font-semibold uppercase tracking-wide text-gray-600'>
            Action
          </div>
        ),
        cell: ({ row }) => {
          const isEditing = editingPartRowId === row.index && editingPartDraft;
          return (
            <div className='flex items-center justify-center gap-2'>
              {!isEditing && (
                <button
                  type='button'
                  onClick={() => startEditingPart(row.index, row.original)}
                  className='rounded-full border border-gray-300 p-1 text-gray-600 transition hover:bg-gray-100'
                  aria-label='Edit part'
                  disabled={isUpdatingPart}
                >
                  <Pencil className='h-4 w-4' />
                </button>
              )}
              {isEditing && (
                <button
                  type='button'
                  onClick={cancelEditingPart}
                  className='rounded-full border border-gray-300 p-1 text-gray-600 transition hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50'
                  aria-label='Cancel edit'
                  disabled={isUpdatingPart}
                >
                  <X className='h-4 w-4' />
                </button>
              )}
              {isEditing && (
                <button
                  type='button'
                  onClick={() => saveEditingPart(row.index)}
                  className='rounded-full border border-green-400 bg-green-50 p-1 text-green-700 transition hover:bg-green-100 disabled:cursor-not-allowed disabled:opacity-50'
                  aria-label='Save part'
                  disabled={isUpdatingPart}
                >
                  <Check className='h-4 w-4' />
                </button>
              )}
              <button
                type='button'
                onClick={() => openPartDeleteModal(row.index)}
                className='rounded-full border border-red-400 bg-red-50 p-1 text-red-600 transition hover:bg-red-100 disabled:cursor-not-allowed disabled:opacity-50'
                aria-label='Delete part'
                disabled={isUpdatingPart}
              >
                <Trash2 className='h-4 w-4' />
              </button>
            </div>
          );
        },
      },
    ];
  }, [
    editingPartDraft,
    editingPartRowId,
    isUpdatingPart,
    handlePartDraftChange,
    cancelEditingPart,
    startEditingPart,
    saveEditingPart,
    handleAskAiAboutPart,
    openPartDeleteModal,
    openPartNoteModal,
  ]);

  const partData = useMemo<Part[]>(() => asset?.partNumber ?? [], [asset]);

  const quickInfoTable = useReactTable<QuickInfoRow>({
    data: quickInfoRows,
    columns: quickInfoColumns,
    state: {
      sorting: quickInfoSorting,
    },
    onSortingChange: setQuickInfoSorting,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
  });

  const partTable = useReactTable<Part>({
    data: partData,
    columns: partColumns,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    state: {
      sorting: partSorting,
    },
    onSortingChange: setPartSorting,
  });

  // Videos table
  const videoColumns = useMemo<ColumnDef<Video>[]>(() => {
    const sortingIndicator = (direction: 'asc' | 'desc' | false) => {
      if (direction === 'asc') return '^';
      if (direction === 'desc') return 'v';
      return '';
    };

    return [
      {
        accessorKey: 'name',
        header: ({ column }) => (
          <button
            type='button'
            onClick={column.getToggleSortingHandler()}
            className='flex items-center gap-1 text-xs font-semibold uppercase tracking-wide text-gray-600'
          >
            Title
            <span className='text-gray-400'>
              {sortingIndicator(column.getIsSorted())}
            </span>
          </button>
        ),
        cell: ({ row }) => {
          const isEditing =
            editingVideoRowId === row.index && editingVideoDraft;
          if (isEditing) {
            return (
              <input
                value={editingVideoDraft.name}
                onChange={(event) =>
                  setEditingVideoDraft((prev) =>
                    prev ? { ...prev, name: event.target.value } : prev
                  )
                }
                className='w-full rounded-md border border-gray-300 bg-white px-2 py-1 text-sm text-gray-900'
                placeholder='Video title (optional)'
              />
            );
          }
          const name = row.original.name?.trim() || 'Untitled';
          const url = row.original.url?.trim();
          if (url) {
            return (
              <a
                href={url}
                target='_blank'
                rel='noopener noreferrer'
                className='text-sm font-medium text-blue-600 hover:text-blue-700'
              >
                {name}
              </a>
            );
          }
          return <span className='text-sm text-gray-900'>{name}</span>;
        },
      },
      {
        accessorKey: 'url',
        header: ({ column }) => (
          <button
            type='button'
            onClick={column.getToggleSortingHandler()}
            className='flex items-center gap-1 text-xs font-semibold uppercase tracking-wide text-gray-600'
          >
            URL
            <span className='text-gray-400'>
              {sortingIndicator(column.getIsSorted())}
            </span>
          </button>
        ),
        cell: ({ row }) => {
          const isEditing =
            editingVideoRowId === row.index && editingVideoDraft;
          if (isEditing) {
            return (
              <input
                value={editingVideoDraft.url}
                onChange={(event) =>
                  setEditingVideoDraft((prev) =>
                    prev ? { ...prev, url: event.target.value } : prev
                  )
                }
                className='w-full rounded-md border border-gray-300 bg-white px-2 py-1 text-sm text-gray-900'
                placeholder='https://www.youtube.com/watch?v=...'
              />
            );
          }
          const href = row.original.url?.trim();
          if (!href) return <span className='text-gray-400'>-</span>;
          return (
            <a
              href={href}
              target='_blank'
              rel='noopener noreferrer'
              className='text-sm text-blue-600 hover:text-blue-700'
            >
              {href}
            </a>
          );
        },
      },
      {
        id: 'play',
        enableSorting: false,
        header: () => (
          <div className='text-center text-xs font-semibold uppercase tracking-wide text-gray-600'>
            Play
          </div>
        ),
        cell: ({ row }) => {
          const ytId = extractYouTubeId(row.original.url ?? '');
          return (
            <div className='flex items-center justify-center'>
              <button
                type='button'
                onClick={() => setSelectedVideoId(ytId)}
                disabled={!ytId}
                className='rounded-full border border-gray-300 p-1 text-gray-600 transition hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50'
                aria-label='Play video'
                title={ytId ? 'Play' : 'Invalid URL'}
              >
                <Play className='h-4 w-4' />
              </button>
            </div>
          );
        },
      },
      {
        id: 'actions',
        header: () => (
          <div className='text-center text-xs font-semibold uppercase tracking-wide text-gray-600'>
            Action
          </div>
        ),
        cell: ({ row }) => {
          const isEditing =
            editingVideoRowId === row.index && editingVideoDraft;
          return (
            <div className='flex items-center justify-center gap-2'>
              {!isEditing && (
                <button
                  type='button'
                  onClick={() => startEditingVideo(row.index, row.original)}
                  className='rounded-full border border-gray-300 p-1 text-gray-600 transition hover:bg-gray-100'
                  aria-label='Edit video'
                  disabled={isUpdatingVideo}
                >
                  <Pencil className='h-4 w-4' />
                </button>
              )}
              {isEditing && (
                <button
                  type='button'
                  onClick={cancelEditingVideo}
                  className='rounded-full border border-gray-300 p-1 text-gray-600 transition hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50'
                  aria-label='Cancel edit'
                  disabled={isUpdatingVideo}
                >
                  <X className='h-4 w-4' />
                </button>
              )}
              {isEditing && (
                <button
                  type='button'
                  onClick={() => saveEditingVideo(row.index)}
                  className='rounded-full border border-green-400 bg-green-50 p-1 text-green-700 transition hover:bg-green-100 disabled:cursor-not-allowed disabled:opacity-50'
                  aria-label='Save video'
                  disabled={isUpdatingVideo}
                >
                  <Check className='h-4 w-4' />
                </button>
              )}
              <button
                type='button'
                onClick={() => openVideoDeleteModal(row.index)}
                className='rounded-full border border-red-400 bg-red-50 p-1 text-red-600 transition hover:bg-red-100 disabled:cursor-not-allowed disabled:opacity-50'
                aria-label='Delete video'
                disabled={isUpdatingVideo}
              >
                <Trash2 className='h-4 w-4' />
              </button>
            </div>
          );
        },
      },
    ];
  }, [
    editingVideoDraft,
    editingVideoRowId,
    isUpdatingVideo,
    startEditingVideo,
    cancelEditingVideo,
    saveEditingVideo,
    openVideoDeleteModal,
  ]);

  const videoData = useMemo<Video[]>(() => asset?.videos ?? [], [asset]);

  const videoTable = useReactTable<Video>({
    data: videoData,
    columns: videoColumns,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    state: {
      sorting: videoSorting,
    },
    onSortingChange: setVideoSorting,
  });

  const isDeleteModalPart = deleteModalMode === 'part';
  const isDeleteModalQuickInfo = deleteModalMode === 'quickInfo';
  const isDeleteModalVideo = deleteModalMode === 'video';
  const quickInfoEntryLabel = pendingQuickInfoDeleteRow
    ? `${pendingQuickInfoDeleteRow.event}${
        pendingQuickInfoDeleteRow.date &&
        pendingQuickInfoDeleteRow.date !== 'N/A'
          ? ` (${pendingQuickInfoDeleteRow.date})`
          : ''
      }`
    : 'this entry';
  const deleteModalTitle = isDeleteModalPart
    ? 'Delete part?'
    : isDeleteModalQuickInfo
    ? 'Delete entry?'
    : isDeleteModalVideo
    ? 'Delete video?'
    : 'Delete asset?';
  const deleteModalMessage = isDeleteModalPart
    ? `Are you sure you want to delete ${
        pendingPartDeleteName ? `"${pendingPartDeleteName}"` : 'this part'
      }? This action cannot be undone.`
    : isDeleteModalQuickInfo
    ? `Are you sure you want to delete ${quickInfoEntryLabel}? This action cannot be undone.`
    : isDeleteModalVideo
    ? `Are you sure you want to delete ${
        pendingVideoDeleteName ? `"${pendingVideoDeleteName}"` : 'this video'
      }? This action cannot be undone.`
    : 'Are you sure you want to delete this asset? This action cannot be undone.';
  const deleteModalInFlight = isDeleteModalPart
    ? isUpdatingPart
    : isDeleteModalQuickInfo
    ? isDeletingQuickInfoRow
    : isDeleteModalVideo
    ? isUpdatingVideo
    : isDeleting;
  const deleteModalConfirmLabel = isDeleteModalPart
    ? isUpdatingPart
      ? 'Deleting...'
      : 'Delete Part'
    : isDeleteModalQuickInfo
    ? isDeletingQuickInfoRow
      ? 'Deleting...'
      : 'Delete Entry'
    : isDeleteModalVideo
    ? isUpdatingVideo
      ? 'Deleting...'
      : 'Delete Video'
    : isDeleting
    ? 'Deleting...'
    : 'Delete Asset';
  const handleDeleteConfirm = () => {
    if (isDeleteModalPart) {
      void handleDeletePart();
      return;
    }
    if (isDeleteModalQuickInfo) {
      if (pendingQuickInfoDeleteRow) {
        void handleDeleteQuickInfoRow(pendingQuickInfoDeleteRow);
      }
      return;
    }
    if (isDeleteModalVideo) {
      void handleDeleteVideo();
      return;
    }
    void handleDeleteAsset();
  };

  if (loading || isFetching) {
    return (
      <Layout>
        <div className='flex min-h-screen items-center justify-center'>
          <div className='text-center'>
            <div className='mx-auto h-12 w-12 animate-spin rounded-full border-b-2 border-blue-600' />
            <p className='mt-4 text-gray-600'>Loading asset details...</p>
          </div>
        </div>
      </Layout>
    );
  }

  if (!currentUser) {
    return (
      <Layout>
        <div className='mx-auto flex min-h-screen max-w-3xl flex-col items-center justify-center px-4 text-center'>
          <h1 className='text-2xl font-semibold text-gray-900'>
            You&apos;re signed out
          </h1>
          <p className='mt-3 text-gray-600'>
            Sign back in to view the details of this asset.
          </p>
          <Link
            href='/login'
            className='mt-6 inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700'
          >
            Go to Login
          </Link>
        </div>
      </Layout>
    );
  }

  return (
    <>
      <Layout>
        <div className='bg-gray-50 min-h-screen py-10'>
          <div className='mx-auto max-w-6xl px-4 sm:px-6 lg:px-8'>
            <div className='mb-6 flex items-center justify-between'>
              <div>
                <h1 className='mt-2 text-3xl font-semibold text-gray-900'>
                  {asset?.make || 'Asset Detail'}
                </h1>
                {headerModelYear && (
                  <p className='mt-1 text-sm text-gray-600'>
                    {headerModelYear}
                  </p>
                )}
              </div>
              <div className='flex items-center gap-3'>
                <Link
                  href='/home'
                  className='inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700'
                >
                  Back to My Assets
                </Link>
                <button
                  type='button'
                  onClick={openDeleteModal}
                  disabled={isDeleting}
                  className='inline-flex items-center rounded-md border border-red-400 bg-red-100 px-4 py-2 text-sm font-medium text-red-700 transition hover:bg-red-200 disabled:cursor-not-allowed disabled:opacity-50'
                >
                  {isDeleting ? 'Deleting...' : 'Delete Asset'}
                </button>
              </div>
            </div>

            {asset ? (
              <div className='space-y-6'>
                <section className='w-full rounded-lg border border-gray-200 bg-white p-6 shadow-sm'>
                  <div className='flex items-center justify-between'>
                    <h2 className='text-xl font-semibold text-gray-900'>
                      Overview
                    </h2>
                    <div className='flex flex-col items-end gap-2'>
                      {!isEditing && (
                        <button
                          type='button'
                          onClick={() => setIsEditing(true)}
                          className='rounded-md border border-green-400 bg-green-100 px-3 py-1 text-sm font-medium text-green-700 transition hover:bg-green-200'
                        >
                          Edit Asset
                        </button>
                      )}
                      {asset?.vin && asset.vin.trim().length > 0 && (
                        <a
                          href={`https://www.nhtsa.gov/recalls?vymm=${encodeURIComponent(
                            asset.vin.trim()
                          )}`}
                          target='_blank'
                          rel='noopener noreferrer'
                          onClick={handleRecallClick}
                          className='inline-flex items-center rounded-md border border-blue-400 bg-blue-50 px-3 py-1 text-sm font-medium text-blue-700 transition hover:bg-blue-100'
                        >
                          <span>Check for recall</span>
                          <span className='ml-2 inline-flex items-center rounded-full border border-yellow-300 bg-yellow-100 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-yellow-800'>
                            Pro
                          </span>
                        </a>
                      )}
                      <button
                        type='button'
                        onClick={() => {
                          setNotesError(null);
                          setNotesDraft(asset?.notes ?? '');
                          setIsNotesModalOpen(true);
                        }}
                        className='inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-1 text-sm font-medium text-gray-700 transition hover:bg-gray-100'
                      >
                        Notes
                      </button>
                    </div>
                  </div>

                  {isEditing ? (
                    <form onSubmit={handleSave} className='mt-6 space-y-4'>
                      <div className='grid gap-4 sm:grid-cols-2'>
                        <div>
                          <label
                            htmlFor='make'
                            className='block text-sm font-medium text-gray-700'
                          >
                            Make
                          </label>
                          <input
                            id='make'
                            name='make'
                            value={formState.make}
                            onChange={handleFieldChange}
                            className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                            placeholder='e.g. Toyota'
                          />
                        </div>
                        <div>
                          <label
                            htmlFor='model'
                            className='block text-sm font-medium text-gray-700'
                          >
                            Model
                          </label>
                          <input
                            id='model'
                            name='model'
                            value={formState.model}
                            onChange={handleFieldChange}
                            className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                            placeholder='e.g. RAV4'
                          />
                        </div>
                        <div>
                          <label
                            htmlFor='year'
                            className='block text-sm font-medium text-gray-700'
                          >
                            Year
                          </label>
                          <input
                            id='year'
                            name='year'
                            type='number'
                            inputMode='numeric'
                            min='1900'
                            max='2099'
                            value={formState.year}
                            onChange={handleFieldChange}
                            className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                            placeholder='e.g. 2018'
                          />
                        </div>
                        <div>
                          <label
                            htmlFor='vin'
                            className='block text-sm font-medium text-gray-700'
                          >
                            VIN
                          </label>
                          <input
                            id='vin'
                            name='vin'
                            value={formState.vin}
                            onChange={handleFieldChange}
                            className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                          />
                        </div>
                        <div>
                          <label
                            htmlFor='plate'
                            className='block text-sm font-medium text-gray-700'
                          >
                            Plate
                          </label>
                          <input
                            id='plate'
                            name='plate'
                            value={formState.plate}
                            onChange={handleFieldChange}
                            className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                          />
                        </div>
                        {formState.category.trim().toLowerCase() !==
                        'household' ? (
                          <>
                            <div>
                              <label
                                htmlFor='tireSize'
                                className='block text-sm font-medium text-gray-700'
                              >
                                Tire Size
                              </label>
                              <input
                                id='tireSize'
                                name='tireSize'
                                value={formState.tireSize}
                                onChange={handleFieldChange}
                                className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                                placeholder='e.g. 225/65R17'
                              />
                            </div>
                            <div>
                              <label
                                htmlFor='tirePressure'
                                className='block text-sm font-medium text-gray-700'
                              >
                                Tire Pressure
                              </label>
                              <input
                                id='tirePressure'
                                name='tirePressure'
                                value={formState.tirePressure}
                                onChange={handleFieldChange}
                                className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                                placeholder='e.g. 35 PSI'
                              />
                            </div>
                            <div>
                              <label
                                htmlFor='oilType'
                                className='block text-sm font-medium text-gray-700'
                              >
                                Oil Type
                              </label>
                              <input
                                id='oilType'
                                name='oilType'
                                value={formState.oilType}
                                onChange={handleFieldChange}
                                className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                                placeholder='e.g. 5W-30 Synthetic'
                              />
                            </div>
                          </>
                        ) : (
                          <>
                            <div className='flex items-center gap-2'>
                              <input
                                id='warranty'
                                name='warranty'
                                type='checkbox'
                                checked={formState.warranty}
                                onChange={(e) =>
                                  setFormState((prev) => ({
                                    ...prev,
                                    warranty: e.target.checked,
                                  }))
                                }
                                className='h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500'
                              />
                              <label
                                htmlFor='warranty'
                                className='text-sm font-medium text-gray-700'
                              >
                                Under Warranty
                              </label>
                            </div>
                            {formState.warranty && (
                              <div>
                                <label
                                  htmlFor='warrantyNumber'
                                  className='block text-sm font-medium text-gray-700'
                                >
                                  Warranty Number
                                </label>
                                <input
                                  id='warrantyNumber'
                                  name='warrantyNumber'
                                  value={formState.warrantyNumber}
                                  onChange={handleFieldChange}
                                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                                  placeholder='e.g. ABC-1234567'
                                />
                              </div>
                            )}
                            {formState.warranty && (
                              <div>
                                <label
                                  htmlFor='warrantyPhone'
                                  className='block text-sm font-medium text-gray-700'
                                >
                                  Warranty Phone
                                </label>
                                <input
                                  id='warrantyPhone'
                                  name='warrantyPhone'
                                  type='tel'
                                  value={formState.warrantyPhone}
                                  onChange={handleFieldChange}
                                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                                  placeholder='e.g. (800) 555-1234'
                                />
                              </div>
                            )}
                            {formState.warranty && (
                              <div>
                                <label
                                  htmlFor='warrantyExpiry'
                                  className='block text-sm font-medium text-gray-700'
                                >
                                  Warranty Expiry
                                </label>
                                <input
                                  id='warrantyExpiry'
                                  name='warrantyExpiry'
                                  type='date'
                                  value={formState.warrantyExpiry}
                                  onChange={(e) =>
                                    setFormState((prev) => ({
                                      ...prev,
                                      warrantyExpiry: e.target.value,
                                    }))
                                  }
                                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                                />
                              </div>
                            )}
                            {formState.warranty && (
                              <div className='sm:col-span-2'>
                                <label
                                  htmlFor='warrantyNotes'
                                  className='block text-sm font-medium text-gray-700'
                                >
                                  Warranty Notes
                                </label>
                                <textarea
                                  id='warrantyNotes'
                                  name='warrantyNotes'
                                  rows={3}
                                  value={formState.warrantyNotes}
                                  onChange={handleFieldChange}
                                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                                  placeholder='Any additional warranty details'
                                />
                              </div>
                            )}
                          </>
                        )}
                        {formState.category.trim().toLowerCase() !==
                          'household' && (
                          <>
                            <div className='flex items-center gap-2'>
                              <input
                                id='warranty'
                                name='warranty'
                                type='checkbox'
                                checked={formState.warranty}
                                onChange={(e) =>
                                  setFormState((prev) => ({
                                    ...prev,
                                    warranty: e.target.checked,
                                  }))
                                }
                                className='h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500'
                              />
                              <label
                                htmlFor='warranty'
                                className='text-sm font-medium text-gray-700'
                              >
                                Under Warranty
                              </label>
                            </div>
                            {formState.warranty && (
                              <div>
                                <label
                                  htmlFor='warrantyNumber'
                                  className='block text-sm font-medium text-gray-700'
                                >
                                  Warranty Number
                                </label>
                                <input
                                  id='warrantyNumber'
                                  name='warrantyNumber'
                                  value={formState.warrantyNumber}
                                  onChange={handleFieldChange}
                                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                                  placeholder='e.g. ABC-1234567'
                                />
                              </div>
                            )}
                            {formState.warranty && (
                              <div>
                                <label
                                  htmlFor='warrantyPhone'
                                  className='block text-sm font-medium text-gray-700'
                                >
                                  Warranty Phone
                                </label>
                                <input
                                  id='warrantyPhone'
                                  name='warrantyPhone'
                                  type='tel'
                                  value={formState.warrantyPhone}
                                  onChange={handleFieldChange}
                                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                                  placeholder='e.g. (800) 555-1234'
                                />
                              </div>
                            )}
                            {formState.warranty && (
                              <div>
                                <label
                                  htmlFor='warrantyExpiry'
                                  className='block text-sm font-medium text-gray-700'
                                >
                                  Warranty Expiry
                                </label>
                                <input
                                  id='warrantyExpiry'
                                  name='warrantyExpiry'
                                  type='date'
                                  value={formState.warrantyExpiry}
                                  onChange={(e) =>
                                    setFormState((prev) => ({
                                      ...prev,
                                      warrantyExpiry: e.target.value,
                                    }))
                                  }
                                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                                />
                              </div>
                            )}
                            {formState.warranty && (
                              <div className='sm:col-span-2'>
                                <label
                                  htmlFor='warrantyNotes'
                                  className='block text-sm font-medium text-gray-700'
                                >
                                  Warranty Notes
                                </label>
                                <textarea
                                  id='warrantyNotes'
                                  name='warrantyNotes'
                                  rows={3}
                                  value={formState.warrantyNotes}
                                  onChange={handleFieldChange}
                                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                                  placeholder='Any additional warranty details'
                                />
                              </div>
                            )}
                          </>
                        )}
                        <div>
                          <label
                            htmlFor='insuranceCompany'
                            className='block text-sm font-medium text-gray-700'
                          >
                            Insurance Company
                          </label>
                          <input
                            id='insuranceCompany'
                            name='insuranceCompany'
                            value={formState.insuranceCompany}
                            onChange={handleFieldChange}
                            className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                            placeholder='e.g. State Farm'
                          />
                        </div>
                        <div>
                          <label
                            htmlFor='insurancePolicyNumber'
                            className='block text-sm font-medium text-gray-700'
                          >
                            Insurance Policy Number
                          </label>
                          <input
                            id='insurancePolicyNumber'
                            name='insurancePolicyNumber'
                            value={formState.insurancePolicyNumber}
                            onChange={handleFieldChange}
                            className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                            placeholder='e.g. ABC-1234567'
                          />
                        </div>
                        <div>
                          <label
                            htmlFor='insuranceExpirationDate'
                            className='block text-sm font-medium text-gray-700'
                          >
                            Insurance Expiration Date
                          </label>
                          <input
                            id='insuranceExpirationDate'
                            name='insuranceExpirationDate'
                            type='date'
                            value={formState.insuranceExpirationDate}
                            onChange={handleFieldChange}
                            className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                          />
                        </div>
                      </div>

                      {errorMessage && (
                        <p className='text-sm text-red-500'>{errorMessage}</p>
                      )}

                      <div className='flex flex-wrap gap-3'>
                        <button
                          type='submit'
                          disabled={isSaving}
                          className='inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-60'
                        >
                          {isSaving ? 'Saving...' : 'Save Changes'}
                        </button>
                        <button
                          type='button'
                          onClick={() => {
                            setIsEditing(false);
                            setErrorMessage(null);
                            setFormState({
                              make: asset.make ?? '',
                              model: asset.model ?? '',
                              year: asset.year?.toString() ?? '',
                              vin: asset.vin ?? '',
                              plate: asset.plate ?? '',
                              tires: asset.tires ?? '',
                              tireSize: asset.tireSize ?? '',
                              tirePressure: asset.tirePressure ?? '',
                              oilType: asset.oilType ?? '',
                              category: asset.category ?? '',
                              warrantyNumber: asset.warrantyNumber ?? '',
                              warrantyPhone: asset.warrantyPhone ?? '',
                              warrantyNotes: asset.warrantyNotes ?? '',
                              insuranceCompany: asset.insuranceCompany ?? '',
                              insurancePolicyNumber:
                                asset.insurancePolicyNumber ?? '',
                              insuranceExpirationDate:
                                asset.insuranceExpirationDate &&
                                !Number.isNaN(
                                  new Date(
                                    asset.insuranceExpirationDate as any
                                  ).getTime()
                                )
                                  ? new Date(
                                      asset.insuranceExpirationDate as any
                                    )
                                      .toISOString()
                                      .split('T')[0]
                                  : '',
                              warranty: Boolean(asset.warranty),
                              warrantyExpiry:
                                asset.warrantyExpiry &&
                                !Number.isNaN(
                                  new Date(
                                    asset.warrantyExpiry as any
                                  ).getTime()
                                )
                                  ? new Date(asset.warrantyExpiry as any)
                                      .toISOString()
                                      .split('T')[0]
                                  : '',
                            });
                          }}
                          className='inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100'
                        >
                          Cancel
                        </button>
                      </div>
                    </form>
                  ) : (
                    <div className='mt-3 space-y-3'>
                      {hasDetailEntries ? (
                        <dl
                          className={`grid gap-3${
                            hasSecondaryDetailEntries ? ' sm:grid-cols-2' : ''
                          }`}
                        >
                          {detailEntries.primary.length > 0 && (
                            <div className='space-y-2'>
                              {detailEntries.primary.map((entry) => (
                                <div
                                  key={entry.label}
                                  className='grid gap-1 sm:grid-cols-[140px,1fr]'
                                >
                                  <dt className='text-sm leading-none font-medium text-gray-500'>
                                    {entry.label}
                                  </dt>
                                  <dd className='text-sm leading-none text-gray-900'>
                                    {entry.displayValue ?? entry.value}
                                  </dd>
                                </div>
                              ))}
                            </div>
                          )}
                          {hasSecondaryDetailEntries && (
                            <div className='space-y-2'>
                              {detailEntries.secondary.map((entry) => (
                                <div
                                  key={entry.label}
                                  className='grid gap-1 sm:grid-cols-[140px,1fr]'
                                >
                                  <dt className='text-sm leading-none font-medium text-gray-500'>
                                    {entry.label}
                                  </dt>
                                  <dd className='text-sm leading-none text-gray-900'>
                                    {entry.displayValue ?? entry.value}
                                  </dd>
                                </div>
                              ))}
                            </div>
                          )}
                        </dl>
                      ) : (
                        <p className='text-sm text-gray-500'>
                          This asset doesn&apos;t have additional details yet.
                        </p>
                      )}
                      {asset?.warranty ? (
                        <div className='rounded-md border border-blue-200 bg-blue-50/60 p-4 text-sm text-gray-700'>
                          <div className='flex items-center justify-between'>
                            <h3 className='text-sm font-semibold text-blue-800'>
                              Warranty
                            </h3>
                            <span className='text-xs font-medium text-blue-800'>
                              {asset.warrantyExpiry &&
                              !Number.isNaN(
                                new Date(asset.warrantyExpiry as any).getTime()
                              )
                                ? `Expires ${new Date(
                                    asset.warrantyExpiry as any
                                  ).toLocaleDateString()}`
                                : 'Active'}
                            </span>
                          </div>
                          <dl className='mt-2 space-y-1'>
                            {asset.warrantyNumber ? (
                              <div className='grid gap-1 sm:grid-cols-[140px,1fr]'>
                                <dt className='text-xs font-medium text-gray-500'>
                                  Number
                                </dt>
                                <dd className='text-sm text-gray-900'>
                                  {String(asset.warrantyNumber).trim()}
                                </dd>
                              </div>
                            ) : null}
                            {asset.warrantyPhone ? (
                              <div className='grid gap-1 sm:grid-cols-[140px,1fr]'>
                                <dt className='text-xs font-medium text-gray-500'>
                                  Phone
                                </dt>
                                <dd className='text-sm text-gray-900'>
                                  {String(asset.warrantyPhone).trim()}
                                </dd>
                              </div>
                            ) : null}
                            {asset.warrantyNotes ? (
                              <div className='grid gap-1 sm:grid-cols-[140px,1fr]'>
                                <dt className='text-xs font-medium text-gray-500'>
                                  Notes
                                </dt>
                                <dd className='text-sm text-gray-900'>
                                  {String(asset.warrantyNotes).trim()}
                                </dd>
                              </div>
                            ) : null}
                          </dl>
                        </div>
                      ) : null}
                    </div>
                  )}
                </section>

                <div className='mb-4 rounded-md border-2 border-dotted border-red-400 p-4'>
                  <h3 className='text-sm font-semibold text-red-700'>
                    Notifier
                  </h3>
                </div>

                <section className='rounded-lg border border-gray-200 bg-white p-4 shadow-sm'>
                  <div className='flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between'>
                    <div>
                      <h2 className='text-xl font-semibold text-gray-900'>
                        Quick Info
                      </h2>
                      <h3 className='text-sm font-semibold text-gray-600'>
                        {quickInfoVehicleLabel}
                      </h3>
                    </div>
                    <div className='flex items-center gap-2'>
                      <button
                        type='button'
                        onClick={() => {
                          setQuickInfoError(null);
                          setIsQuickInfoAddMenuOpen((prev) => !prev);
                          setQuickInfoAddType(null);
                          cancelEditingQuickInfoRow();
                        }}
                        className='inline-flex items-center justify-center rounded-full border border-green-400 bg-green-50 p-2 text-green-700 transition hover:bg-green-100 disabled:cursor-not-allowed disabled:opacity-50'
                        aria-label='Add quick info entry'
                        disabled={
                          isSavingQuickInfoRow || isDeletingQuickInfoRow
                        }
                      >
                        <Plus className='h-4 w-4' />
                      </button>
                    </div>
                  </div>
                  {isQuickInfoAddMenuOpen && (
                    <div className='mt-3 flex flex-wrap gap-2 text-xs sm:text-sm'>
                      <button
                        type='button'
                        onClick={() => openQuickInfoAddForm('odometer')}
                        className='rounded-md border border-gray-300 px-3 py-1 font-medium text-gray-700 transition hover:bg-gray-100'
                      >
                        Add Odometer Reading
                      </button>
                      <button
                        type='button'
                        onClick={() => openQuickInfoAddForm('oilChange')}
                        className='rounded-md border border-gray-300 px-3 py-1 font-medium text-gray-700 transition hover:bg-gray-100'
                      >
                        Add Oil Change
                      </button>
                    </div>
                  )}
                  {quickInfoAddType && (
                    <form
                      onSubmit={handleQuickInfoAddSubmit}
                      className='mt-4 space-y-4 rounded-md border border-dashed border-blue-300 bg-blue-50/60 p-4 text-sm text-gray-700'
                    >
                      <div className='flex items-center justify-between'>
                        <h3 className='text-sm font-semibold text-blue-700'>
                          {quickInfoAddType === 'odometer'
                            ? 'Add Odometer Reading'
                            : 'Add Oil Change'}
                        </h3>
                        <button
                          type='button'
                          onClick={handleQuickInfoAddCancel}
                          disabled={isSavingQuickInfoAddition}
                          className='text-xs font-medium text-blue-600 transition hover:text-blue-700 disabled:cursor-not-allowed disabled:opacity-50'
                        >
                          Cancel
                        </button>
                      </div>
                      {quickInfoError && (
                        <p className='text-sm text-red-600'>{quickInfoError}</p>
                      )}
                      <div className='grid gap-3 sm:grid-cols-2'>
                        <div>
                          <label
                            htmlFor='quickInfoAddReading'
                            className='block text-xs font-medium uppercase tracking-wide text-gray-700'
                          >
                            {quickInfoAddType === 'odometer'
                              ? 'Odometer Reading'
                              : 'Odometer (optional)'}
                          </label>
                          <input
                            id='quickInfoAddReading'
                            type='number'
                            value={quickInfoAddForm.reading}
                            onChange={(event) =>
                              handleQuickInfoAddFieldChange(
                                'reading',
                                event.target.value
                              )
                            }
                            className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                            placeholder={
                              quickInfoAddType === 'odometer'
                                ? 'Enter mileage'
                                : 'Mileage at oil change'
                            }
                          />
                        </div>
                        <div>
                          <label
                            htmlFor='quickInfoAddDate'
                            className='block text-xs font-medium uppercase tracking-wide text-gray-700'
                          >
                            Date
                          </label>
                          <div className='relative mt-1'>
                            <Calendar
                              className='absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400'
                              onMouseDown={(e) => {
                                e.preventDefault();
                                const input =
                                  e.currentTarget.parentElement?.querySelector(
                                    "input[type='date']"
                                  ) as HTMLInputElement | null;
                                if (input) {
                                  try {
                                    (input as any).showPicker?.();
                                  } catch {}
                                  input.focus();
                                  input.click();
                                }
                              }}
                            />
                            <input
                              id='quickInfoAddDate'
                              type='date'
                              value={quickInfoAddForm.date}
                              onChange={(event) =>
                                handleQuickInfoAddFieldChange(
                                  'date',
                                  event.target.value
                                )
                              }
                              onClick={(e) => {
                                try {
                                  (e.currentTarget as any).showPicker?.();
                                } catch {}
                              }}
                              className='w-full rounded-md border border-gray-300 bg-white pl-9 pr-3 py-2 text-sm text-gray-900'
                            />
                          </div>
                        </div>
                      </div>
                      <div className='flex items-center gap-3 pt-2'>
                        <button
                          type='submit'
                          disabled={isSavingQuickInfoAddition}
                          className='inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-50'
                        >
                          {isSavingQuickInfoAddition
                            ? 'Adding...'
                            : 'Add Entry'}
                        </button>
                      </div>
                    </form>
                  )}
                  {!quickInfoAddType && quickInfoError && (
                    <p className='mt-4 text-sm text-red-600'>
                      {quickInfoError}
                    </p>
                  )}
                  <div
                    className={`mt-4 space-y-4 text-sm text-gray-700${
                      quickInfoAddType ? ' border-t border-gray-200 pt-4' : ''
                    }`}
                  >
                    {quickInfoRows.length > 0 ? (
                      <div className='overflow-x-auto rounded-lg border border-gray-200'>
                        <table className='min-w-full divide-y divide-gray-200 text-left'>
                          <thead className='bg-gray-50'>
                            {quickInfoTable
                              .getHeaderGroups()
                              .map((headerGroup) => (
                                <tr key={headerGroup.id}>
                                  {headerGroup.headers.map((header) => (
                                    <th
                                      key={header.id}
                                      scope='col'
                                      className='px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500'
                                    >
                                      {header.isPlaceholder
                                        ? null
                                        : flexRender(
                                            header.column.columnDef.header,
                                            header.getContext()
                                          )}
                                    </th>
                                  ))}
                                </tr>
                              ))}
                          </thead>
                          <tbody className='divide-y divide-gray-200 bg-white'>
                            {quickInfoTable.getRowModel().rows.map((row) => (
                              <tr key={row.id} className='hover:bg-gray-50'>
                                {row.getVisibleCells().map((cell) => (
                                  <td
                                    key={cell.id}
                                    className='px-4 py-2 text-gray-700'
                                  >
                                    {flexRender(
                                      cell.column.columnDef.cell,
                                      cell.getContext()
                                    )}
                                  </td>
                                ))}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    ) : (
                      <p className='text-sm text-gray-500'>
                        No odometer or oil change records yet.
                      </p>
                    )}
                  </div>
                </section>

                <section
                  id='maintenance-section'
                  className='rounded-lg border border-gray-200 bg-white p-6 shadow-sm'
                >
                  <div className='flex items-center justify-between'>
                    <h2 className='text-xl font-semibold text-gray-900'>
                      Maintenance
                    </h2>
                    {!isEditingMaintenance && (
                      <button
                        type='button'
                        onClick={() => {
                          setIsEditingMaintenance(true);
                          setMaintenanceError(null);
                          if (maintenanceFormState.length === 0) {
                            setMaintenanceFormState([
                              {
                                maintenanceType: '',
                                maintenanceDesc: '',
                                maintenanceEndDate: '',
                              },
                            ]);
                          }
                        }}
                        className='rounded-md border border-green-400 bg-green-100 px-3 py-1 text-sm font-medium text-green-700 transition hover:bg-green-200'
                      >
                        Edit
                      </button>
                    )}
                  </div>
                  {isEditingMaintenance ? (
                    <form
                      onSubmit={handleMaintenanceSave}
                      className='mt-4 space-y-4'
                    >
                      {maintenanceError && (
                        <p className='text-sm text-red-600'>
                          {maintenanceError}
                        </p>
                      )}
                      {maintenanceFormState.length > 0 ? (
                        maintenanceFormState.map((entry, index) => (
                          <div
                            key={index}
                            className='space-y-3 rounded-md border border-gray-200 p-4 text-sm text-gray-700'
                          >
                            <div>
                              <label
                                htmlFor={`maintenanceType-${index}`}
                                className='block text-sm font-medium text-gray-700'
                              >
                                Maintenance Type
                              </label>
                              <input
                                id={`maintenanceType-${index}`}
                                value={entry.maintenanceType}
                                onChange={(event) =>
                                  handleMaintenanceFieldChange(
                                    index,
                                    'maintenanceType',
                                    event.target.value
                                  )
                                }
                                className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                              />
                            </div>
                            <div>
                              <label
                                htmlFor={`maintenanceDesc-${index}`}
                                className='block text-sm font-medium text-gray-700'
                              >
                                Description
                              </label>
                              <textarea
                                id={`maintenanceDesc-${index}`}
                                value={entry.maintenanceDesc}
                                onChange={(event) =>
                                  handleMaintenanceFieldChange(
                                    index,
                                    'maintenanceDesc',
                                    event.target.value
                                  )
                                }
                                className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                                rows={3}
                              />
                            </div>
                            <div>
                              <label
                                htmlFor={`maintenanceDue-${index}`}
                                className='block text-sm font-medium text-gray-700'
                              >
                                Due Date
                              </label>
                              <div className='relative mt-1'>
                                <Calendar
                                  className='absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400'
                                  onMouseDown={(e) => {
                                    e.preventDefault();
                                    const input =
                                      e.currentTarget.parentElement?.querySelector(
                                        "input[type='date']"
                                      ) as HTMLInputElement | null;
                                    if (input) {
                                      try {
                                        (input as any).showPicker?.();
                                      } catch {}
                                      input.focus();
                                      input.click();
                                    }
                                  }}
                                />
                                <input
                                  id={`maintenanceDue-${index}`}
                                  type='date'
                                  value={entry.maintenanceEndDate}
                                  onChange={(event) =>
                                    handleMaintenanceFieldChange(
                                      index,
                                      'maintenanceEndDate',
                                      event.target.value
                                    )
                                  }
                                  onClick={(e) => {
                                    try {
                                      (e.currentTarget as any).showPicker?.();
                                    } catch {}
                                  }}
                                  className='w-full rounded-md border border-gray-300 bg-white pl-9 pr-3 py-2 text-sm text-gray-900'
                                />
                              </div>
                            </div>
                            <div className='flex justify-end'>
                              <button
                                type='button'
                                onClick={() =>
                                  handleRemoveMaintenanceEntry(index)
                                }
                                className='text-sm font-medium text-red-600 hover:text-red-700'
                                disabled={isSavingMaintenance}
                              >
                                Remove
                              </button>
                            </div>
                          </div>
                        ))
                      ) : (
                        <p className='text-sm text-gray-500'>
                          No maintenance records yet. Add one below.
                        </p>
                      )}
                      <div className='flex flex-wrap items-center justify-between gap-3'>
                        <button
                          type='button'
                          onClick={handleAddMaintenanceEntry}
                          className='inline-flex items-center rounded-md border border-dashed border-gray-300 px-3 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100'
                          disabled={isSavingMaintenance}
                        >
                          Add Maintenance Item
                        </button>
                      </div>
                      <div className='flex items-center gap-3'>
                        <button
                          type='submit'
                          disabled={isSavingMaintenance}
                          className='inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-50'
                        >
                          {isSavingMaintenance ? 'Saving...' : 'Save Changes'}
                        </button>
                        <button
                          type='button'
                          onClick={() => {
                            setIsEditingMaintenance(false);
                            setMaintenanceError(null);
                            setMaintenanceFormState(
                              buildMaintenanceFormState(asset)
                            );
                          }}
                          className='inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100'
                          disabled={isSavingMaintenance}
                        >
                          Cancel
                        </button>
                      </div>
                    </form>
                  ) : asset.maintenance && asset.maintenance.length > 0 ? (
                    <ul className='mt-4 space-y-3'>
                      {asset.maintenance.map((item, index) => {
                        const parsedDueDate = item.maintenanceEndDate
                          ? new Date(item.maintenanceEndDate)
                          : null;
                        const dueDateLabel =
                          parsedDueDate &&
                          !Number.isNaN(parsedDueDate.getTime())
                            ? parsedDueDate.toLocaleDateString()
                            : 'N/A';

                        return (
                          <li
                            key={index}
                            className='rounded-md border border-gray-200 p-4 text-sm text-gray-700'
                          >
                            <p className='font-medium text-gray-900'>
                              {item.maintenanceType || 'Maintenance Item'}
                            </p>
                            {item.maintenanceDesc && (
                              <p className='mt-1 text-gray-600'>
                                {item.maintenanceDesc}
                              </p>
                            )}
                            <p className='mt-2 text-xs uppercase tracking-wide text-gray-400'>
                              Due: {dueDateLabel}
                            </p>
                          </li>
                        );
                      })}
                    </ul>
                  ) : (
                    <p className='mt-2 text-sm text-gray-500'>
                      No maintenance records have been added for this asset yet.
                    </p>
                  )}
                </section>

                <section className='rounded-lg border border-gray-200 bg-white p-6 shadow-sm'>
                  <div className='flex items-center justify-between'>
                    <h2 className='text-xl font-semibold text-gray-900'>
                      Videos
                    </h2>
                  </div>
                  <div className='mt-4'>
                    {selectedVideoId ? (
                      <div
                        className='relative w-full overflow-hidden rounded-md border border-gray-200 bg-black'
                        style={{ paddingTop: '56.25%' }}
                      >
                        <iframe
                          className='absolute left-0 top-0 h-full w-full'
                          src={`https://www.youtube.com/embed/${selectedVideoId}`}
                          title='YouTube video player'
                          allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share'
                          allowFullScreen
                        />
                      </div>
                    ) : (
                      <p className='text-sm text-gray-500'>
                        Paste a YouTube URL and add it, or use the table below
                        to select a video to play.
                      </p>
                    )}
                  </div>
                  <form
                    onSubmit={async (e) => {
                      e.preventDefault();
                      if (!asset || !currentUser) return;
                      const trimmedUrl = videoAddUrl.trim();
                      const ytId = extractYouTubeId(trimmedUrl);
                      if (!trimmedUrl || !ytId) {
                        setVideoAddError('Please enter a valid YouTube URL.');
                        return;
                      }
                      setIsAddingVideo(true);
                      setVideoAddError(null);
                      try {
                        const newEntry: Video = {
                          name: videoAddTitle.trim() || undefined,
                          url: trimmedUrl,
                        };
                        const nextVideos: Video[] = [
                          ...(asset.videos ?? []),
                          newEntry,
                        ];
                        const targetRef = ref(
                          db,
                          `assets/${currentUser.UserId}/${id}`
                        );
                        const updatedAsset = {
                          ...asset,
                          videos: nextVideos,
                        } as Vehicle & Record<string, unknown>;
                        const sanitized = JSON.parse(
                          JSON.stringify(updatedAsset)
                        );
                        await set(targetRef, sanitized);
                        setVideoAddUrl('');
                        setVideoAddTitle('');
                        // Do not auto-play newly added video; wait for user click.
                      } catch (error) {
                        console.error('Failed to add video', error);
                        setVideoAddError(
                          'Unable to add video. Please try again.'
                        );
                      } finally {
                        setIsAddingVideo(false);
                      }
                    }}
                    className='mt-4 space-y-3'
                  >
                    {videoAddError && (
                      <p className='text-sm text-red-600'>{videoAddError}</p>
                    )}
                    <div className='grid gap-3 sm:grid-cols-3'>
                      <div className='sm:col-span-2'>
                        <label
                          htmlFor='video-url'
                          className='block text-sm font-medium text-gray-700'
                        >
                          YouTube URL
                        </label>
                        <input
                          id='video-url'
                          value={videoAddUrl}
                          onChange={(e) => setVideoAddUrl(e.target.value)}
                          placeholder='https://www.youtube.com/watch?v=...'
                          className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                        />
                      </div>
                      <div>
                        <label
                          htmlFor='video-title'
                          className='block text-sm font-medium text-gray-700'
                        >
                          Title (optional)
                        </label>
                        <input
                          id='video-title'
                          value={videoAddTitle}
                          onChange={(e) => setVideoAddTitle(e.target.value)}
                          className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                        />
                      </div>
                    </div>
                    <div className='flex items-center gap-3'>
                      <button
                        type='submit'
                        disabled={isAddingVideo}
                        className='inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-50'
                      >
                        {isAddingVideo ? 'Adding...' : 'Add Video'}
                      </button>
                      <button
                        type='button'
                        onClick={() => {
                          setVideoAddUrl('');
                          setVideoAddTitle('');
                          setVideoAddError(null);
                        }}
                        disabled={isAddingVideo}
                        className='inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50'
                      >
                        Clear
                      </button>
                    </div>
                  </form>
                  <div className='mt-4'>
                    {!editingVideoRowId && updateVideoError && (
                      <p className='mb-2 text-sm text-red-600'>
                        {updateVideoError}
                      </p>
                    )}
                    {videoData.length > 0 ? (
                      <div className='overflow-x-auto rounded-lg border border-gray-200'>
                        <table className='min-w-full divide-y divide-gray-200 text-left'>
                          <thead className='bg-gray-50'>
                            {videoTable.getHeaderGroups().map((headerGroup) => (
                              <tr key={headerGroup.id}>
                                {headerGroup.headers.map((header) => (
                                  <th
                                    key={header.id}
                                    scope='col'
                                    className='px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500'
                                  >
                                    {header.isPlaceholder
                                      ? null
                                      : flexRender(
                                          header.column.columnDef.header,
                                          header.getContext()
                                        )}
                                  </th>
                                ))}
                              </tr>
                            ))}
                          </thead>
                          <tbody className='divide-y divide-gray-200 bg-white'>
                            {videoTable.getRowModel().rows.map((row) => (
                              <tr key={row.id} className='hover:bg-gray-50'>
                                {row.getVisibleCells().map((cell) => (
                                  <td
                                    key={cell.id}
                                    className='px-4 py-2 text-gray-700'
                                  >
                                    {flexRender(
                                      cell.column.columnDef.cell,
                                      cell.getContext()
                                    )}
                                  </td>
                                ))}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    ) : (
                      <p className='text-sm text-gray-500'>
                        No videos added yet.
                      </p>
                    )}
                  </div>
                </section>

                <section className='rounded-lg border border-gray-200 bg-white p-6 shadow-sm'>
                  <div className='flex flex-wrap items-center justify-between gap-3'>
                    <h2 className='text-xl font-semibold text-gray-900'>
                      AI Description
                    </h2>
                  </div>
                  <div className='mt-4 space-y-3'>
                    <div
                      className={`flex items-center text-sm text-gray-600 overflow-hidden transition-all duration-500 ${
                        isGeneratingAiDescription
                          ? 'opacity-100 max-h-8'
                          : 'opacity-0 max-h-0'
                      }`}
                    >
                      <span className='mr-2 inline-block h-4 w-4 animate-spin rounded-full border-2 border-blue-600 border-t-transparent' />
                      <span className='ai-fade'>
                        Generating AI description...
                      </span>
                    </div>
                    {hasDescriptionPrompt ? (
                      descriptionSourceOverride ? (
                        <div className='space-y-1 text-sm text-gray-600'>
                          {activeAiPartName && (
                            <p className='font-medium text-gray-900'>
                              {activeAiPartName}
                            </p>
                          )}
                          <p className='whitespace-pre-line'>
                            {descriptionSource}
                          </p>
                        </div>
                      ) : asset?.description ? (
                        <p className='text-sm text-gray-600 whitespace-pre-line'>
                          {asset.description}
                        </p>
                      ) : (
                        <p className='text-sm text-gray-500'>
                          We&apos;ll use the overview details above to ask AI
                          for more context.
                        </p>
                      )
                    ) : (
                      <p className='text-sm text-gray-500'>
                        Add basic information about this asset to enable AI
                        suggestions.
                      </p>
                    )}
                    {aiDescriptionError && (
                      <p className='text-sm text-red-600'>
                        {aiDescriptionError}
                      </p>
                    )}
                    {aiGenerationStats && (
                      <p className='text-xs text-gray-500'>
                        AI attempts used: {aiGenerationStats.attempts} of{' '}
                        {aiGenerationStats.maxAttempts}
                      </p>
                    )}
                    {aiDescription && (
                      <div className='rounded-md border border-blue-200 bg-blue-50 p-3 text-sm text-blue-900 whitespace-pre-line'>
                        {aiDescription}
                      </div>
                    )}
                  </div>
                </section>

                <section className='rounded-lg border border-gray-200 bg-white p-6 shadow-sm'>
                  <div className='flex items-center justify-between'>
                    <h2 className='text-xl font-semibold text-gray-900'>
                      General Notes
                    </h2>
                    {!isEditingNotes && (
                      <button
                        type='button'
                        onClick={() => {
                          setIsEditingNotes(true);
                          setNotesError(null);
                          setNotesDraft(asset?.notes ?? '');
                        }}
                        className='rounded-md border border-green-400 bg-green-100 px-3 py-1 text-sm font-medium text-green-700 transition hover:bg-green-200'
                      >
                        Edit
                      </button>
                    )}
                  </div>

                  {isEditingNotes ? (
                    <form onSubmit={handleNotesSave} className='mt-4 space-y-3'>
                      {notesError && (
                        <p className='text-sm text-red-600'>{notesError}</p>
                      )}
                      <div>
                        <label
                          htmlFor='general-notes'
                          className='block text-sm font-medium text-gray-700'
                        >
                          Notes
                        </label>
                        <textarea
                          id='general-notes'
                          value={notesDraft}
                          onChange={(e) => setNotesDraft(e.target.value)}
                          rows={5}
                          className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                        />
                      </div>
                      <div className='flex items-center gap-3'>
                        <button
                          type='submit'
                          disabled={isSavingNotes}
                          className='inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-50'
                        >
                          {isSavingNotes ? 'Saving...' : 'Save Notes'}
                        </button>
                        <button
                          type='button'
                          onClick={() => {
                            setIsEditingNotes(false);
                            setNotesError(null);
                            setNotesDraft(asset?.notes ?? '');
                          }}
                          className='inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100'
                        >
                          Cancel
                        </button>
                      </div>
                    </form>
                  ) : asset?.notes && asset.notes.trim().length > 0 ? (
                    (() => {
                      const full = asset.notes as string;
                      const MAX_PREVIEW = 280;
                      const shouldTruncate = full.length > MAX_PREVIEW;
                      const preview = shouldTruncate
                        ? full.slice(0, MAX_PREVIEW).trimEnd() + '‚Ä¶'
                        : full;
                      return (
                        <p className='mt-2 whitespace-pre-line text-sm text-gray-700'>
                          {isNotesExpanded
                            ? preview && shouldTruncate
                              ? // When expanded and truncated exists, show full content
                                full
                              : full
                            : preview}
                          {shouldTruncate && (
                            <>
                              {' '}
                              {isNotesExpanded ? (
                                <button
                                  type='button'
                                  onClick={() => setIsNotesExpanded(false)}
                                  className='text-blue-600 underline hover:text-blue-700'
                                  aria-label='Show less notes'
                                  title='Show less'
                                >
                                  Show less
                                </button>
                              ) : (
                                <button
                                  type='button'
                                  onClick={() => setIsNotesExpanded(true)}
                                  className='text-blue-600 underline hover:text-blue-700'
                                  aria-label='Show more notes'
                                  title='Show more'
                                >
                                  Show more
                                </button>
                              )}
                            </>
                          )}
                        </p>
                      );
                    })()
                  ) : (
                    <p className='mt-2 text-sm text-gray-500'>
                      No notes yet. Add any general details, reminders, or
                      context here.
                    </p>
                  )}
                </section>

                <section className='rounded-lg border border-gray-200 bg-white p-6 shadow-sm'>
                  <div className='flex items-center justify-between'>
                    <h2 className='text-xl font-semibold text-gray-900'>
                      List of Parts/Links
                    </h2>
                    <button
                      type='button'
                      onClick={handleAddPartEntry}
                      disabled={
                        isSavingParts ||
                        isUpdatingPart ||
                        editingPartRowId !== null
                      }
                      className='inline-flex items-center justify-center rounded-full border border-green-400 bg-green-50 p-2 text-green-700 transition hover:bg-green-100 disabled:cursor-not-allowed disabled:opacity-50'
                      aria-label='Add part'
                    >
                      <Plus className='h-4 w-4' />
                    </button>
                  </div>
                  {!isEditingParts && updatePartError && (
                    <p className='mt-2 text-sm text-red-600'>
                      {updatePartError}
                    </p>
                  )}
                  {isEditingParts ? (
                    <form onSubmit={handlePartsSave} className='mt-4 space-y-4'>
                      {partsError && (
                        <p className='text-sm text-red-600'>{partsError}</p>
                      )}
                      {partFormState.length > 0 ? (
                        partFormState.map((entry, index) => (
                          <div
                            key={index}
                            className='space-y-3 rounded-md border border-gray-200 p-4 text-sm text-gray-700'
                          >
                            <div>
                              <label
                                htmlFor={`part-name-${index}`}
                                className='block text-sm font-medium text-gray-700'
                              >
                                Part Name
                              </label>
                              <input
                                id={`part-name-${index}`}
                                value={entry.part}
                                onChange={(event) =>
                                  handlePartFieldChange(
                                    index,
                                    'part',
                                    event.target.value
                                  )
                                }
                                className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                              />
                            </div>

                            <div>
                              <label
                                htmlFor={`part-url-${index}`}
                                className='block text-sm font-medium text-gray-700'
                              >
                                Vendor URL
                              </label>
                              <input
                                id={`part-url-${index}`}
                                value={entry.url}
                                onChange={(event) =>
                                  handlePartFieldChange(
                                    index,
                                    'url',
                                    event.target.value
                                  )
                                }
                                className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                                placeholder='https://'
                              />
                            </div>
                            <div>
                              <label
                                htmlFor={`part-date-${index}`}
                                className='block text-sm font-medium text-gray-700'
                              >
                                Date Needed
                              </label>
                              <div className='relative mt-1'>
                                <Calendar
                                  className='absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400'
                                  onMouseDown={(e) => {
                                    e.preventDefault();
                                    const input =
                                      e.currentTarget.parentElement?.querySelector(
                                        "input[type='date']"
                                      ) as HTMLInputElement | null;
                                    if (input) {
                                      try {
                                        (input as any).showPicker?.();
                                      } catch {}
                                      input.focus();
                                      input.click();
                                    }
                                  }}
                                />
                                <input
                                  id={`part-date-${index}`}
                                  type='date'
                                  value={entry.date}
                                  onChange={(event) =>
                                    handlePartFieldChange(
                                      index,
                                      'date',
                                      event.target.value
                                    )
                                  }
                                  onClick={(e) => {
                                    try {
                                      (e.currentTarget as any).showPicker?.();
                                    } catch {}
                                  }}
                                  className='w-full rounded-md border border-gray-300 bg-white pl-9 pr-3 py-2 text-sm text-gray-900'
                                />
                              </div>
                            </div>
                            <div className='flex justify-end'>
                              <button
                                type='button'
                                onClick={() => handleRemovePartEntry(index)}
                                className='text-sm font-medium text-red-600 hover:text-red-700'
                                disabled={isSavingParts}
                              >
                                Remove
                              </button>
                            </div>
                          </div>
                        ))
                      ) : (
                        <p className='text-sm text-gray-500'>
                          No parts yet. Use the plus button to add one.
                        </p>
                      )}
                      <div className='flex items-center gap-3'>
                        <button
                          type='submit'
                          disabled={isSavingParts}
                          className='inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-50'
                        >
                          {isSavingParts ? 'Saving...' : 'Save Parts'}
                        </button>
                        <button
                          type='button'
                          onClick={() => {
                            setIsEditingParts(false);
                            setPartsError(null);
                            setPartFormState([]);
                          }}
                          className='inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100'
                          disabled={isSavingParts}
                        >
                          Cancel
                        </button>
                      </div>
                    </form>
                  ) : partData.length > 0 ? (
                    <div className='mt-4 overflow-x-auto'>
                      <table className='min-w-full divide-y divide-gray-200 text-sm'>
                        <thead className='bg-gray-50'>
                          {partTable.getHeaderGroups().map((headerGroup) => (
                            <tr key={headerGroup.id}>
                              {headerGroup.headers.map((header) => (
                                <th
                                  key={header.id}
                                  scope='col'
                                  className='px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500'
                                >
                                  {header.isPlaceholder
                                    ? null
                                    : flexRender(
                                        header.column.columnDef.header,
                                        header.getContext()
                                      )}
                                </th>
                              ))}
                            </tr>
                          ))}
                        </thead>
                        <tbody className='divide-y divide-gray-200'>
                          {partTable.getRowModel().rows.map((row) => (
                            <tr key={row.id} className='hover:bg-gray-50'>
                              {row.getVisibleCells().map((cell) => (
                                <td
                                  key={cell.id}
                                  className='px-4 py-3 text-gray-700'
                                >
                                  {flexRender(
                                    cell.column.columnDef.cell,
                                    cell.getContext()
                                  )}
                                </td>
                              ))}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  ) : (
                    <p className='mt-2 text-sm text-gray-500'>
                      No parts are currently tracked for this asset.
                    </p>
                  )}
                </section>
              </div>
            ) : (
              <div className='rounded-lg border border-gray-200 bg-white p-10 text-center shadow-sm'>
                <h2 className='text-xl font-semibold text-gray-900'>
                  Asset not found
                </h2>
                <p className='mt-2 text-sm text-gray-500'>
                  We couldn&apos;t locate details for this asset. It may have
                  been removed.
                </p>
                <Link
                  href='/home'
                  className='mt-6 inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700'
                >
                  Return to My Assets
                </Link>
              </div>
            )}
          </div>
        </div>
      </Layout>
      {isNotesModalOpen && (
        <div
          className='fixed inset-0 z-50 flex items-center justify-center bg-gray-900/60 px-4'
          role='dialog'
          aria-modal='true'
          aria-labelledby='notes-modal-title'
        >
          <div className='w-full max-w-3xl rounded-lg bg-white p-8 shadow-xl md:max-h-[85vh] overflow-auto'>
            <div className='mb-4'>
              <h2
                id='notes-modal-title'
                className='text-lg font-semibold text-gray-900'
              >
                Asset Notes
              </h2>
              <p className='mt-1 text-sm text-gray-600'>
                View and edit notes linked to this asset.
              </p>
            </div>
            <form onSubmit={handleNotesSave} className='space-y-3'>
              {notesError && (
                <p className='text-sm text-red-600'>{notesError}</p>
              )}
              <div>
                <label
                  htmlFor='notes-modal-textarea'
                  className='block text-sm font-medium text-gray-700'
                >
                  Notes
                </label>
                <textarea
                  id='notes-modal-textarea'
                  value={notesDraft}
                  onChange={(e) => setNotesDraft(e.target.value)}
                  rows={12}
                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 min-h-[300px]'
                />
              </div>
              <div className='mt-2 flex justify-end gap-3'>
                <button
                  type='button'
                  onClick={() => {
                    setIsNotesModalOpen(false);
                    setNotesError(null);
                    setNotesDraft(asset?.notes ?? '');
                  }}
                  disabled={isSavingNotes}
                  className='inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50'
                >
                  Cancel
                </button>
                <button
                  type='submit'
                  disabled={isSavingNotes}
                  className='inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-50'
                >
                  {isSavingNotes ? 'Saving...' : 'Save Notes'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
      {isPartNoteModalOpen && (
        <div
          className='fixed inset-0 z-50 flex items-center justify-center bg-gray-900/60 px-4'
          role='dialog'
          aria-modal='true'
          aria-labelledby='part-note-modal-title'
        >
          <div className='w-full max-w-xl rounded-lg bg-white p-6 shadow-xl'>
            <h2
              id='part-note-modal-title'
              className='text-lg font-semibold text-gray-900'
            >
              Part Note
            </h2>
            <p className='mt-1 text-sm text-gray-600'>
              {(() => {
                try {
                  const p = asset?.partNumber?.[activePartNoteIndex ?? -1];
                  const label = (p?.part || p?.type || '').toString().trim();
                  return label ? `For: ${label}` : '';
                } catch {
                  return '';
                }
              })()}
            </p>
            <form onSubmit={handleSavePartNote} className='mt-4 space-y-3'>
              {partNoteError && (
                <p className='text-sm text-red-600'>{partNoteError}</p>
              )}
              <div>
                <label
                  htmlFor='part-note-textarea'
                  className='block text-sm font-medium text-gray-700'
                >
                  Note
                </label>
                <textarea
                  id='part-note-textarea'
                  value={partNoteDraft}
                  onChange={(e) => setPartNoteDraft(e.target.value)}
                  rows={8}
                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900'
                  placeholder='Add a note about this part'
                />
              </div>
              <div className='mt-2 flex justify-end gap-3'>
                <button
                  type='button'
                  onClick={() => {
                    setIsPartNoteModalOpen(false);
                    setPartNoteError(null);
                    setPartNoteDraft(
                      asset?.partNumber?.[activePartNoteIndex ?? -1]?.note ?? ''
                    );
                  }}
                  disabled={isSavingPartNote}
                  className='inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50'
                >
                  Cancel
                </button>
                <button
                  type='submit'
                  disabled={isSavingPartNote}
                  className='inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-50'
                >
                  {isSavingPartNote ? 'Saving...' : 'Save Note'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
      {isDeleteModalOpen && (
        <div
          className='fixed inset-0 z-50 flex items-center justify-center bg-gray-900/60 px-4'
          role='dialog'
          aria-modal='true'
          aria-labelledby='delete-modal-title'
        >
          <div className='w-full max-w-md rounded-lg bg-white p-6 shadow-xl'>
            <h2
              id='delete-modal-title'
              className='text-lg font-semibold text-gray-900'
            >
              {deleteModalTitle}
            </h2>
            <p className='mt-2 text-sm text-gray-600'>{deleteModalMessage}</p>
            <div className='mt-6 flex justify-end gap-3'>
              <button
                type='button'
                onClick={handleCancelDelete}
                disabled={deleteModalInFlight}
                className='inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50'
              >
                Cancel
              </button>
              <button
                type='button'
                onClick={handleDeleteConfirm}
                disabled={deleteModalInFlight}
                className='inline-flex items-center rounded-md bg-red-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-red-700 disabled:cursor-not-allowed disabled:opacity-50'
              >
                {deleteModalConfirmLabel}
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}
=== File End: app/homedetail/[id]/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/landing/page.tsx ===

=== File End: app/landing/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/layout.tsx ===
// src/app/layout.tsx
import './globals.css'
import '../../temp-tailwind.css'
import { AuthProvider } from '../contexts/AuthContext'
import { CartProvider } from '../contexts/CartContext'

export const metadata = {
  title: 'Vehicle Assets Manager',
  description: 'Manage your vehicles and assets',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body className="bg-gray-50 text-gray-900 antialiased">
        <AuthProvider>
          <CartProvider>
            {children}
          </CartProvider>
        </AuthProvider>
      </body>
    </html>
  )
}
=== File End: app/layout.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/loading.tsx ===
export default function Loading() {
  return (
    <div className="flex h-screen items-center justify-center">
      <span className="text-sm font-semibold">Loading...</span>
    </div>
  );
}
=== File End: app/loading.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/login/page.tsx ===
// src/app/login/page.tsx
'use client';

import React, { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useAuth } from '../../contexts/AuthContext';

export default function LoginPage() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [isRegisterMode, setIsRegisterMode] = useState(
    () => searchParams.get('mode') === 'register'
  );

  const { login, signup, googleSignIn, currentUser } = useAuth();

  useEffect(() => {
    if (currentUser) {
      router.push('/home');
    }
  }, [currentUser, router]);

  useEffect(() => {
    const isRegisterQuery = searchParams.get('mode') === 'register';
    setIsRegisterMode((prev) =>
      prev === isRegisterQuery ? prev : isRegisterQuery
    );
  }, [searchParams]);

  useEffect(() => {
    setError('');
  }, [isRegisterMode]);

  const handleModeSwitch = (mode: 'login' | 'register') => {
    setIsRegisterMode(mode === 'register');
    if (mode === 'register') {
      router.replace('/login?mode=register');
    } else {
      router.replace('/login');
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      if (isRegisterMode) {
        await signup(email, password);
      } else {
        await login(email, password);
      }
      router.push('/home');
    } catch (error: any) {
      const message = isRegisterMode
        ? 'Failed to register: ' + error.message
        : 'Failed to log in: ' + error.message;
      setError(message);
    } finally {
      setLoading(false);
    }
  };

  const handleGoogleSignIn = async () => {
    try {
      await googleSignIn();
      router.push('/home');
    } catch (error: any) {
      setError('Failed to sign in with Google: ' + error.message);
    }
  };

  return (
    <div className='min-h-screen flex items-center justify-center bg-gray-100 py-12 px-4 sm:px-6 lg:px-8'>
      <div className='max-w-md w-full space-y-8'>
        <div>
          <h2 className='mt-6 text-center text-3xl font-extrabold text-gray-900'>
            Assets Management Tracker
          </h2>
        </div>
        <form className='mt-8 space-y-6' onSubmit={handleSubmit}>
          {error && (
            <div className='bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded'>
              {error}
            </div>
          )}

          <div>
            <label htmlFor='email' className='sr-only'>
              Email address
            </label>
            <input
              id='email'
              name='email'
              type='email'
              required
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className='relative block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-black placeholder-gray-500 focus:border-blue-500 focus:bg-white focus:outline-none focus:ring-blue-500 dark:bg-white dark:text-black dark:focus:bg-white'
            />
          </div>

          <div>
            <label htmlFor='password' className='sr-only'>
              Password
            </label>
            <input
              id='password'
              name='password'
              type='password'
              required
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className='relative block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-black placeholder-gray-500 focus:border-blue-500 focus:bg-white focus:outline-none focus:ring-blue-500 dark:bg-white dark:text-black dark:focus:bg-white'
              placeholder='Password'
            />
          </div>

          <div>
            <button
              type='submit'
              disabled={loading}
              className='group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500'
            >
              {loading
                ? isRegisterMode
                  ? 'Creating account...'
                  : 'Signing in...'
                : isRegisterMode
                ? 'Create account'
                : 'Sign in'}
            </button>
          </div>
        </form>

        <div className='text-center text-sm text-gray-600'>
          {isRegisterMode ? (
            <p>
              Already have an account?{' '}
              <button
                type='button'
                onClick={() => handleModeSwitch('login')}
                className='font-medium text-blue-600 hover:text-blue-500'
              >
                Sign in
              </button>
            </p>
          ) : (
            <p>
              Need an account?{' '}
              <button
                type='button'
                onClick={() => handleModeSwitch('register')}
                className='font-medium text-blue-600 hover:text-blue-500'
              >
                Register now
              </button>
            </p>
          )}
        </div>

        <div className='mt-6'>
          <button
            onClick={handleGoogleSignIn}
            className='w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50'
          >
            <svg className='w-5 h-5 mr-2' viewBox='0 0 24 24'>
              <path
                fill='#4285F4'
                d='M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z'
              />
              <path
                fill='#34A853'
                d='M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z'
              />
              <path
                fill='#FBBC05'
                d='M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z'
              />
              <path
                fill='#EA4335'
                d='M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z'
              />
            </svg>
            Sign in with Google
          </button>
        </div>
      </div>
    </div>
  );
}
=== File End: app/login/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/myorders/page.tsx ===

=== File End: app/myorders/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/myordersdetails/[id]/page.tsx ===

=== File End: app/myordersdetails/[id]/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/page.tsx ===
// src/app/page.tsx
'use client';

import Link from 'next/link';
import { useAuth } from '../contexts/AuthContext';

const features = [
  {
    title: 'Track Every Asset',
    description:
      'Keep tabs on vehicles, bikes, and household equipment with structured records and maintenance logs.',
  },
  {
    title: 'Smart Reminders',
    description:
      'Set due dates for services or orders so nothing slips through the cracks.',
  },
  {
    title: 'Collaborate With Ease',
    description:
      'Share consistent information across your household or team using a single source of truth.',
  },
];

export default function LandingPage() {
  const { currentUser, loading } = useAuth();

  if (loading) {
    return (
      <div className='flex min-h-screen items-center justify-center bg-gradient-to-br from-blue-50 via-white to-blue-100'>
        <div className='text-center'>
          <div className='mx-auto h-20 w-20 animate-spin rounded-full border-b-4 border-blue-600' />
          <p className='mt-4 text-sm text-gray-600'>
            Preparing your experience...
          </p>
        </div>
      </div>
    );
  }

  return (
    <main className='min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-100'>
      <section className='mx-auto flex max-w-5xl flex-col gap-12 px-6 pb-16 pt-24 text-gray-900 md:flex-row md:items-center md:justify-between'>
        <div className='max-w-xl space-y-6'>
          <span className='inline-flex items-center rounded-full bg-blue-100 px-3 py-1 text-xs font-semibold uppercase tracking-wider text-blue-700'>
            template
          </span>
          <h1 className='text-4xl font-bold tracking-tight text-gray-900 sm:text-5xl'>
            Organize every asset and stay ahead of maintenance
          </h1>
          <p className='text-lg text-gray-600'>
            A single hub to log vehicles, record upkeep, and plan upcoming part
            orders. Designed for owners who want clarity without the spreadsheet
            hassle.
          </p>
          <div className='flex flex-wrap gap-4'>
            <Link
              href={currentUser ? '/dashboard' : '/login'}
              className='inline-flex items-center justify-center rounded-md bg-blue-600 px-6 py-3 text-sm font-semibold text-white shadow-md transition hover:bg-blue-700'
            >
              {currentUser ? 'Go to your dashboard' : 'Sign in to get started'}
            </Link>
            <Link
              href='#features'
              className='inline-flex items-center justify-center rounded-md border border-blue-600 px-6 py-3 text-sm font-semibold text-blue-600 transition hover:bg-blue-50'
            >
              Explore the platform
            </Link>
            <Link
              href='/blog'
              className='inline-flex items-center justify-center rounded-md border border-blue-600 px-6 py-3 text-sm font-semibold text-blue-600 transition hover:bg-blue-50'
            >
              Read the blog
            </Link>
          </div>
        </div>
        <div className='relative mx-auto max-w-md overflow-hidden rounded-2xl bg-white p-6 shadow-xl'>
          <div className='absolute -top-6 -right-6 h-24 w-24 rounded-full bg-blue-100 blur-2xl' />
          <div className='absolute -bottom-6 -left-6 h-32 w-32 rounded-full bg-blue-200 blur-3xl' />
          <div className='relative space-y-4'>
            <h2 className='text-lg font-semibold text-gray-800'>At a glance</h2>
            <ul className='space-y-3 text-sm text-gray-600'>
              <li className='flex items-start gap-3'>
                <span className='mt-1 inline-flex h-2.5 w-2.5 flex-none rounded-full bg-blue-500' />
                <div>
                  <p className='font-medium text-gray-800'>Fleet overview</p>
                  <p>See make, model, year, and condition at a glance.</p>
                </div>
              </li>
              <li className='flex items-start gap-3'>
                <span className='mt-1 inline-flex h-2.5 w-2.5 flex-none rounded-full bg-green-500' />
                <div>
                  <p className='font-medium text-gray-800'>
                    Maintenance history
                  </p>
                  <p>Log services, track due dates, and capture receipts.</p>
                </div>
              </li>
              <li className='flex items-start gap-3'>
                <span className='mt-1 inline-flex h-2.5 w-2.5 flex-none rounded-full bg-indigo-500' />
                <div>
                  <p className='font-medium text-gray-800'>Parts to order</p>
                  <p>Plan ahead with links, expected prices, and reminders.</p>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </section>
      <section className='bg-gray-50 py-12'>
        <div className='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8'>
          <h2 className='text-3xl font-bold text-center mb-8 text-black'>
            How It Works
          </h2>
          <div className='grid grid-cols-1 md:grid-cols-3 gap-8'>
            <div className='text-center'>
              <div className='w-12 h-12 bg-blue-100 rounded-full mx-auto mb-4 flex items-center justify-center'>
                <span className='text-blue-600 font-bold'>1</span>
              </div>
              <h3 className='text-lg font-semibold mb-2 text-black'>
                Add Your Assets
              </h3>
              <p className='text-gray-600'>
                Input items with easy forms‚Äîupload photos and assign locations
                for home or business use.
              </p>
            </div>
            <div className='text-center'>
              <div className='w-12 h-12 bg-blue-100 rounded-full mx-auto mb-4 flex items-center justify-center'>
                <span className='text-blue-600 font-bold'>2</span>
              </div>
              <h3 className='text-lg font-semibold mb-2 text-black'>
                Track & Manage
              </h3>
              <p className='text-gray-600'>
                Monitor status, depreciation, and maintenance schedules with
                real-time updates.
              </p>
            </div>
            <div className='text-center'>
              <div className='w-12 h-12 bg-blue-100 rounded-full mx-auto mb-4 flex items-center justify-center'>
                <span className='text-blue-600 font-bold'>3</span>
              </div>
              <h3 className='text-lg font-semibold mb-2 text-black'>
                Upgrade for Pro
              </h3>
              <p className='text-gray-600'>
                Unlock AI tools, unlimited assets, and detailed reports with a
                Pro subscription.
              </p>
            </div>
          </div>
        </div>
      </section>
      <section id='features' className='bg-white py-16'>
        <div className='mx-auto max-w-5xl px-6'>
          <h2 className='text-center text-2xl font-semibold text-gray-900 sm:text-3xl'>
            Why owners choose Vehicle Assets Manager
          </h2>
          <div className='mt-10 grid gap-8 md:grid-cols-3'>
            {features.map((feature) => (
              <div
                key={feature.title}
                className='rounded-lg border border-gray-200 bg-white p-6 shadow-sm transition hover:shadow-md'
              >
                <h3 className='text-lg font-semibold text-gray-900'>
                  {feature.title}
                </h3>
                <p className='mt-3 text-sm text-gray-600'>
                  {feature.description}
                </p>
              </div>
            ))}
          </div>
        </div>
      </section>
      {/* Paywall/Pricing Section */}
      <section className='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12'>
        <h2 className='text-3xl font-bold text-center mb-8 text-black'>
          Pricing Plans
        </h2>
        <div className='grid grid-cols-1 md:grid-cols-2 gap-8'>
          <div className='bg-white p-6 rounded-lg shadow-md'>
            <h3 className='text-xl font-semibold mb-2 text-black'>Free Tier</h3>
            <p className='text-gray-600 mb-4'>Perfect for personal use.</p>
            <p className='text-2xl font-bold mb-4 text-black'>$0/month</p>
            <ul className='text-gray-600 mb-4 space-y-2'>
              <li>Up to 20 assets</li>
              <li>Basic tracking & forms</li>
              <li>Photo uploads</li>
            </ul>
            <Link
              href='/login?mode=register'
              className='w-full flex justify-center bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition'
            >
              Start Free
            </Link>
          </div>
          <div className='bg-white p-6 rounded-lg shadow-md'>
            <h3 className='text-xl font-semibold mb-2 text-black'>Go Pro: Unlock Unlimited Power</h3>
    
            <p className='text-2xl font-bold mb-4 text-black'>$2.99/month</p>
            <ul className='text-gray-600 mb-4 space-y-2'>
              <li>Unlimited assets</li>
              <li>AI insights</li>
              <li>Advanced reports & exports</li>
              <li>Priority support</li>
            </ul>
            <button className='w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition'>
              Upgrade to Pro
            </button>
          </div>
        </div>
        <p className='text-center text-gray-600 mt-4'>
          Try Pro free for 14 days! Cancel anytime.
        </p>
      </section>
      <footer className='bg-gray-800 text-white py-6'>
        <div className='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center'>
          <p>&copy; 2025 Asset Manager Pro. All rights reserved.</p>
          <div className='mt-2 space-x-4'>
            <a href='#' className='text-blue-400 hover:underline'>
              Privacy Policy
            </a>
            <a href='#' className='text-blue-400 hover:underline'>
              Terms of Service
            </a>
            <a href='#' className='text-blue-400 hover:underline'>
              Contact Us
            </a>
          </div>
        </div>
      </footer>
    </main>
  );
}
=== File End: app/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/payment/page.tsx ===
'use client';

import React, { useEffect, useRef, useState } from 'react';
import { useRouter } from 'next/navigation';
import Layout from '../../components/layout/Layout';
import { useAuth } from '../../contexts/AuthContext';

declare global {
  interface Window {
    paypal?: any;
  }
}

const STORAGE_KEY = 'assetmanagement-settings-preferences';

export default function PaymentPage() {
  const router = useRouter();
  const { currentUser, loading } = useAuth();
  const [errorMessage, setErrorMessage] = useState<string | null>(null);
  const [status, setStatus] = useState<'idle' | 'rendering' | 'success' | 'error'>('idle');
  const buttonsRef = useRef<HTMLDivElement | null>(null);
  const buttonsRenderedRef = useRef<boolean>(false);

  const paypalClientId = process.env.NEXT_PUBLIC_PAYPAL_CLIENT_ID || '';
  const paypalPlanId = process.env.NEXT_PUBLIC_PAYPAL_PLAN_ID || '';

  useEffect(() => {
    if (!loading && !currentUser) {
      router.replace('/login');
    }
  }, [loading, currentUser, router]);

  // Load PayPal SDK for Subscriptions (vault + intent=subscription)
  useEffect(() => {
    if (!currentUser || !paypalClientId || !buttonsRef.current) return;
    const url = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(
      paypalClientId
    )}&vault=true&intent=subscription`; // enables subscription buttons

    const ensureButtons = () => {
      if (!window.paypal || !buttonsRef.current) return;
      try {
        if (buttonsRenderedRef.current) return; // guard against duplicate renders
        setStatus('rendering');
        const Buttons = window.paypal.Buttons({
          style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'subscribe' },
          createSubscription: (_: any, actions: any) => {
            if (!paypalPlanId) {
              setErrorMessage('Missing PayPal plan id.');
              throw new Error('Missing PayPal plan id');
            }
            return actions.subscription.create({ plan_id: paypalPlanId });
          },
          onApprove: (data: any, _actions: any) => {
            try {
              // Persist subscription in local settings
              const saved = window.localStorage.getItem(STORAGE_KEY);
              const parsed = saved ? JSON.parse(saved) : {};
              const updated = {
                ...parsed,
                proPlanActive: true,
                proSubscriptionId: data?.subscriptionID || data?.subscriptionId || undefined,
                proPlanPrice: '2.99',
                proPlanInterval: 'MONTH',
              };
              window.localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
            } catch {}
            setStatus('success');
          },
          onError: (err: any) => {
            console.error('PayPal subscription error', err);
            setErrorMessage('Payment error. Please refresh and try again.');
            setStatus('error');
          },
          onCancel: () => setStatus('idle'),
        });
        if (Buttons.isEligible && !Buttons.isEligible()) return;
        // Clear container before rendering to avoid nested duplicates
        try { buttonsRef.current.innerHTML = ''; } catch {}
        buttonsRenderedRef.current = true;
        Buttons.render(buttonsRef.current).catch(() => {
          buttonsRenderedRef.current = false;
        });
      } catch (err) {
        console.error('Failed to render PayPal subscription buttons', err);
        setErrorMessage('Unable to initialize PayPal checkout.');
      }
    };

    const exists = document.querySelector<HTMLScriptElement>(
      'script[src^="https://www.paypal.com/sdk/js"]'
    );
    if (exists) {
      if (exists.getAttribute('src') !== url) {
        exists.remove();
        const script = document.createElement('script');
        script.src = url;
        script.async = true;
        script.onload = ensureButtons;
        document.body.appendChild(script);
      } else if (window.paypal) {
        ensureButtons();
      } else {
        exists.addEventListener('load', ensureButtons, { once: true });
      }
      return;
    }

    const script = document.createElement('script');
    script.src = url;
    script.async = true;
    script.onload = ensureButtons;
    document.body.appendChild(script);
    return () => {
      // Cleanup to avoid duplicate renders on remounts (e.g., StrictMode)
      if (buttonsRef.current) {
        try { buttonsRef.current.innerHTML = ''; } catch {}
      }
      buttonsRenderedRef.current = false;
    };
  }, [currentUser, paypalClientId, paypalPlanId]);

  return (
    <Layout>
      <div className='min-h-screen bg-gray-100 py-10'>
        <div className='mx-auto max-w-2xl px-4 sm:px-6 lg:px-8'>
          <div className='mb-6'>
            <h1 className='text-3xl font-bold text-gray-900'>Go Pro Subscription</h1>
            <p className='mt-2 text-sm text-gray-600'>
              Subscribe to unlock Pro features. Billed monthly at $2.99.
            </p>
          </div>

          {(!paypalClientId || !paypalPlanId) && (
            <div className='mb-4 rounded border border-yellow-300 bg-yellow-50 p-3 text-sm text-yellow-800'>
              Missing PayPal configuration. Ensure NEXT_PUBLIC_PAYPAL_CLIENT_ID and NEXT_PUBLIC_PAYPAL_PLAN_ID are set.
            </div>
          )}

          <div className='rounded-lg bg-white p-6 shadow'>
            <div className='mb-4'>
              <h2 className='text-lg font-semibold text-gray-900'>Asset Manager Pro</h2>
              <p className='text-sm text-gray-600'>$2.99 per month</p>
            </div>

            <div ref={buttonsRef} />

            {status === 'success' && (
              <div className='mt-4 rounded border border-green-300 bg-green-50 p-3 text-sm text-green-800'>
                Subscription started. Pro features are now enabled.
              </div>
            )}
            {errorMessage && (
              <div className='mt-4 rounded border border-red-300 bg-red-50 p-3 text-sm text-red-700'>
                {errorMessage}
              </div>
            )}

            <div className='mt-6 flex gap-3'>
              <button
                type='button'
                onClick={() => router.push('/settings')}
                className='rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100'
              >
                Back to Settings
              </button>
            </div>
          </div>
        </div>
      </div>
    </Layout>
  );
}
=== File End: app/payment/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/profile/page.tsx ===
'use client';

import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import Layout from '../../components/layout/Layout';
import { useAuth } from '../../contexts/AuthContext';

type StatusState =
  | { type: 'success'; message: string }
  | { type: 'error'; message: string }
  | null;

const ProfilePage: React.FC = () => {
  const router = useRouter();
  const { currentUser, loading, updateProfileDetails } = useAuth();

  const [formState, setFormState] = useState({
    displayName: '',
    email: '',
    phone: '',
    address: '',
    city: '',
    state: '',
    zip: '',
  });
  const [status, setStatus] = useState<StatusState>(null);
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    if (!loading && !currentUser) {
      router.replace('/login');
    }
  }, [loading, currentUser, router]);

  useEffect(() => {
    if (!currentUser) {
      return;
    }

    setFormState({
      displayName: currentUser.DisplayName ?? '',
      email: currentUser.Email ?? '',
      phone: currentUser.Phone ?? '',
      address: currentUser.Address ?? '',
      city: currentUser.City ?? '',
      state: currentUser.State ?? '',
      zip: currentUser.Zip ?? '',
    });
  }, [currentUser]);

  const handleChange = (
    event: React.ChangeEvent<HTMLInputElement>
  ): void => {
    const { name, value } = event.target;
    setFormState((prev) => ({
      ...prev,
      [name]: value,
    }));
  };

  const handleSubmit = async (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    if (!currentUser) {
      return;
    }
    setSaving(true);
    setStatus(null);

    try {
      await updateProfileDetails({
        DisplayName: formState.displayName,
        Phone: formState.phone,
        Address: formState.address,
        City: formState.city,
        State: formState.state,
        Zip: formState.zip,
      });
      setStatus({ type: 'success', message: 'Profile updated successfully.' });
    } catch (error: any) {
      setStatus({
        type: 'error',
        message: error?.message ?? 'Failed to update profile.',
      });
    } finally {
      setSaving(false);
    }
  };

  if (loading || !currentUser) {
    return (
      <Layout>
        <div className='flex min-h-screen items-center justify-center bg-gray-100'>
          <div className='text-center'>
            <div className='mx-auto h-12 w-12 animate-spin rounded-full border-b-2 border-blue-600' />
            <p className='mt-4 text-gray-600'>Loading your profile...</p>
          </div>
        </div>
      </Layout>
    );
  }

  return (
    <Layout>
      <div className='min-h-screen bg-gray-100 py-10'>
        <div className='mx-auto max-w-3xl px-6'>
          <div className='mb-8 text-center'>
            <h1 className='text-3xl font-bold text-gray-900'>Your Profile</h1>
            <p className='mt-2 text-sm text-gray-600'>
              Review and keep your contact details up to date.
            </p>
          </div>

          <form
            onSubmit={handleSubmit}
            className='space-y-6 rounded-lg bg-white p-6 shadow-sm'
          >
            {status && (
              <div
                className={`rounded-md border px-4 py-3 text-sm ${
                  status.type === 'success'
                    ? 'border-green-200 bg-green-50 text-green-700'
                    : 'border-red-200 bg-red-50 text-red-700'
                }`}
              >
                {status.message}
              </div>
            )}

            <div className='grid grid-cols-1 gap-6 md:grid-cols-2'>
              <div className='md:col-span-2'>
                <label
                  htmlFor='displayName'
                  className='block text-sm font-medium text-gray-700'
                >
                  Display name
                </label>
                <input
                  id='displayName'
                  name='displayName'
                  type='text'
                  value={formState.displayName}
                  onChange={handleChange}
                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500'
                  placeholder='What should we call you?'
                />
              </div>

              <div className='md:col-span-2'>
                <label
                  htmlFor='email'
                  className='block text-sm font-medium text-gray-700'
                >
                  Email address
                </label>
                <input
                  id='email'
                  name='email'
                  type='email'
                  value={formState.email}
                  disabled
                  className='mt-1 w-full rounded-md border border-gray-200 bg-gray-100 px-3 py-2 text-gray-600 shadow-sm'
                />
                <p className='mt-1 text-xs text-gray-500'>
                  Email changes require help from the support team.
                </p>
              </div>

              <div>
                <label
                  htmlFor='phone'
                  className='block text-sm font-medium text-gray-700'
                >
                  Phone
                </label>
                <input
                  id='phone'
                  name='phone'
                  type='tel'
                  value={formState.phone}
                  onChange={handleChange}
                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500'
                  placeholder='(555) 555-5555'
                />
              </div>

              <div className='md:col-span-2'>
                <label
                  htmlFor='address'
                  className='block text-sm font-medium text-gray-700'
                >
                  Address
                </label>
                <input
                  id='address'
                  name='address'
                  type='text'
                  value={formState.address}
                  onChange={handleChange}
                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500'
                  placeholder='Street address'
                />
              </div>

              <div>
                <label
                  htmlFor='city'
                  className='block text-sm font-medium text-gray-700'
                >
                  City
                </label>
                <input
                  id='city'
                  name='city'
                  type='text'
                  value={formState.city}
                  onChange={handleChange}
                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500'
                />
              </div>

              <div>
                <label
                  htmlFor='state'
                  className='block text-sm font-medium text-gray-700'
                >
                  State / Province
                </label>
                <input
                  id='state'
                  name='state'
                  type='text'
                  value={formState.state}
                  onChange={handleChange}
                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500'
                />
              </div>

              <div>
                <label
                  htmlFor='zip'
                  className='block text-sm font-medium text-gray-700'
                >
                  Zip / Postal code
                </label>
                <input
                  id='zip'
                  name='zip'
                  type='text'
                  value={formState.zip}
                  onChange={handleChange}
                  className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500'
                />
              </div>
            </div>

            <div className='flex items-center justify-end gap-3'>
              <button
                type='button'
                onClick={() => router.back()}
                className='rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100'
              >
                Cancel
              </button>
              <button
                type='submit'
                disabled={saving}
                className='inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:bg-blue-300'
              >
                {saving ? 'Saving...' : 'Save changes'}
              </button>
            </div>
          </form>
        </div>
      </div>
    </Layout>
  );
};

export default ProfilePage;
=== File End: app/profile/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: app/settings/page.tsx ===
'use client';

import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import Layout from '../../components/layout/Layout';
import { useAuth } from '../../contexts/AuthContext';

const STORAGE_KEY = 'assetmanagement-settings-preferences';

const SettingsPage: React.FC = () => {
  const router = useRouter();
  const { currentUser, loading } = useAuth();
  const [proAiEnabled, setProAiEnabled] = useState(false);
  const [cloudBackupEnabled, setCloudBackupEnabled] = useState(false);
  const [teamMembers, setTeamMembers] = useState<string[]>([]);
  const [inviteEmail, setInviteEmail] = useState('');
  const [inviteFeedback, setInviteFeedback] = useState<string | null>(null);
  const [inviteError, setInviteError] = useState<string | null>(null);
  const [preferencesLoaded, setPreferencesLoaded] = useState(false);
  const [isProModalOpen, setIsProModalOpen] = useState(false);
  const [odometerWarningDays, setOdometerWarningDays] = useState<number>(90);
  const [proModalSource, setProModalSource] = useState<'ai' | 'cloud' | 'cta' | null>(null);
  const [prevProState, setPrevProState] = useState<{ ai: boolean; cloud: boolean }>({ ai: false, cloud: false });
  const TEAM_LIMIT = 2;

  useEffect(() => {
    if (!loading && !currentUser) {
      router.replace('/login');
    }
  }, [loading, currentUser, router]);

  useEffect(() => {
    if (typeof window === 'undefined') {
      return;
    }

    try {
      const savedSettings = window.localStorage.getItem(STORAGE_KEY);
      if (savedSettings) {
        const parsed = JSON.parse(savedSettings);
        setProAiEnabled(Boolean(parsed.proAiEnabled));
        setCloudBackupEnabled(Boolean(parsed.cloudBackupEnabled));
        if (Array.isArray(parsed.teamMembers)) {
          setTeamMembers(parsed.teamMembers);
        }
        if (
          typeof parsed.odometerWarningDays === 'number' &&
          Number.isFinite(parsed.odometerWarningDays) &&
          parsed.odometerWarningDays > 0
        ) {
          setOdometerWarningDays(parsed.odometerWarningDays);
        }
      }
    } catch (error) {
      console.error('Unable to load settings from localStorage', error);
    } finally {
      setPreferencesLoaded(true);
    }
  }, []);

  useEffect(() => {
    if (!preferencesLoaded || typeof window === 'undefined') {
      return;
    }

    const settings = {
      proAiEnabled,
      cloudBackupEnabled,
      teamMembers,
      odometerWarningDays,
    };

    try {
      window.localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
    } catch (error) {
      console.error('Unable to save settings to localStorage', error);
    }
  }, [proAiEnabled, cloudBackupEnabled, odometerWarningDays, preferencesLoaded]);

  const isFreeTierLimitReached = teamMembers.length >= TEAM_LIMIT;

  const handleInviteSubmit = (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    setInviteFeedback(null);
    setInviteError(null);

    if (isFreeTierLimitReached) {
      setInviteError(
        'Free tier reaches its limit with 2 members. Go Pro to add more teammates.'
      );
      return;
    }

    const trimmedEmail = inviteEmail.trim().toLowerCase();
    if (!trimmedEmail) {
      setInviteError('Please enter an email to invite.');
      return;
    }

    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(trimmedEmail)) {
      setInviteError('Enter a valid email address.');
      return;
    }

    if (teamMembers.includes(trimmedEmail)) {
      setInviteError('This teammate has already been invited.');
      return;
    }

    const updatedMembers = [...teamMembers, trimmedEmail];
    setTeamMembers(updatedMembers);
    setInviteFeedback(
      `Invite sent to ${trimmedEmail}. Message: "Welcome to my Asset Management Group."`
    );
    setInviteEmail('');
  };

  const handleAiToggleClick = () => {
    setProAiEnabled((prev) => {
      const next = !prev;
      if (!prev && next) {
        setPrevProState({ ai: prev, cloud: cloudBackupEnabled });
        setProModalSource('ai');
        setIsProModalOpen(true);
      }
      return next;
    });
  };

  const handleCloudToggleClick = () => {
    setCloudBackupEnabled((prev) => {
      const next = !prev;
      if (!prev && next) {
        setPrevProState({ ai: proAiEnabled, cloud: prev });
        setProModalSource('cloud');
        setIsProModalOpen(true);
      }
      return next;
    });
  };

  if (loading || !currentUser) {
    return (
      <Layout>
        <div className='flex min-h-screen items-center justify-center bg-gray-100'>
          <div className='text-center'>
            <div className='mx-auto h-12 w-12 animate-spin rounded-full border-b-2 border-blue-600' />
            <p className='mt-4 text-gray-600'>Loading your settings...</p>
          </div>
        </div>
      </Layout>
    );
  }

  return (
    <Layout>
      <div className='min-h-screen bg-gray-100 py-12'>
        <div className='mx-auto max-w-3xl px-4 sm:px-6 lg:px-8'>
          <header className='mb-8'>
            <p className='text-sm font-semibold uppercase tracking-wide text-blue-600'>
              Preferences
            </p>
            <h1 className='mt-2 text-3xl font-bold text-gray-900'>Settings</h1>
            <p className='mt-2 text-sm text-gray-600'>
              Tailor how Asset Management works for you. Adjust the Pro
              benefits below to explore what&apos;s coming next.
            </p>
          </header>

          <section className='rounded-2xl bg-white shadow-sm ring-1 ring-gray-100'>
            <div className='border-b border-gray-100 px-6 py-5'>
              <h2 className='text-lg font-semibold text-gray-900'>
                Pro Experience
              </h2>
              <p className='mt-1 text-sm text-gray-500'>
                Unlock advanced AI workflows and secure backups when you Go
                Pro. Toggle the options below to see what you can expect.
              </p>
            </div>

            <div className='divide-y divide-gray-100'>
              <div className='flex flex-col gap-4 px-6 py-6 sm:flex-row sm:items-start sm:justify-between'>
                <div className='max-w-xl'>
                  <div className='flex items-center gap-2'>
                    <h3 className='text-base font-medium text-gray-900'>
                      AI Co-Pilot
                    </h3>
                    <span className='inline-flex items-center rounded-full bg-blue-50 px-2 py-0.5 text-xs font-semibold uppercase tracking-wide text-blue-600'>
                      Pro
                    </span>
                  </div>
                  <p className='mt-1 text-sm text-gray-500'>
                    Experience proactive maintenance suggestions, component
                    forecasts, and AI insights tailored to your garage.
                  </p>
                  <p className='mt-3 text-sm font-semibold text-gray-700'>
                    Ready to turn on Go Pro features that handle AI-driven
                    insights?
                  </p>
                </div>
                <button
                  type='button'
                  onClick={handleAiToggleClick}
                  className={`relative inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${
                    proAiEnabled ? 'bg-blue-600' : 'bg-gray-200'
                  }`}
                  role='switch'
                  aria-checked={proAiEnabled}
                  aria-label='Enable Go Pro AI features'
                >
                  <span
                    className={`pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${
                      proAiEnabled ? 'translate-x-5' : 'translate-x-0'
                    }`}
                  />
                </button>
              </div>

              <div className='flex flex-col gap-4 px-6 py-6 sm:flex-row sm:items-start sm:justify-between'>
                <div className='max-w-xl'>
                  <div className='flex items-center gap-2'>
                    <h3 className='text-base font-medium text-gray-900'>
                      Cloud Backup
                    </h3>
                    <span className='inline-flex items-center rounded-full bg-blue-50 px-2 py-0.5 text-xs font-semibold uppercase tracking-wide text-blue-600'>
                      Pro
                    </span>
                  </div>
                  <p className='mt-1 text-sm text-gray-500'>
                    Automatically protect your vehicle records and documents in
                    a secure cloud vault with version history.
                  </p>
                  <p className='mt-3 text-sm font-semibold text-gray-700'>
                    Want to keep a Pro-grade backup of your data in the cloud?
                  </p>
                </div>
                <button
                  type='button'
                  onClick={handleCloudToggleClick}
                  className={`relative inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${
                    cloudBackupEnabled ? 'bg-blue-600' : 'bg-gray-200'
                  }`}
                  role='switch'
                  aria-checked={cloudBackupEnabled}
                  aria-label='Enable Pro cloud backups'
                >
                  <span
                    className={`pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${
                      cloudBackupEnabled ? 'translate-x-5' : 'translate-x-0'
                    }`}
                  />
                </button>
              </div>
            </div>
          </section>

          <section className='mt-8 rounded-2xl bg-white shadow-sm ring-1 ring-gray-100'>
            <div className='border-b border-gray-100 px-6 py-5'>
              <h2 className='text-lg font-semibold text-gray-900'>
                Vehicle Preferences
              </h2>
              <p className='mt-1 text-sm text-gray-500'>
                Control thresholds used to remind you about odometer updates.
              </p>
            </div>

            <div className='px-6 py-6'>
              <label
                htmlFor='odo-warning-days'
                className='block text-sm font-medium text-gray-700'
              >
                Number of days before your last odometer reading
              </label>
              <div className='mt-1 flex items-center gap-3'>
                <input
                  id='odo-warning-days'
                  type='number'
                  inputMode='numeric'
                  min={1}
                  max={3650}
                  value={odometerWarningDays}
                  onChange={(e) => {
                    const n = Number(e.target.value);
                    if (!Number.isFinite(n)) return;
                    const clamped = Math.min(3650, Math.max(1, Math.trunc(n)));
                    setOdometerWarningDays(clamped);
                  }}
                  className='w-32 rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500'
                />
                <span className='text-sm text-gray-500'>
                  Default is 90 days
                </span>
              </div>
              <p className='mt-2 text-xs text-gray-500'>
                When the most recent odometer entry is older than this value, we will highlight it as stale.
              </p>
            </div>
          </section>

          <section className='mt-8 rounded-2xl bg-white shadow-sm ring-1 ring-gray-100'>
            <div className='border-b border-gray-100 px-6 py-5'>
              <h2 className='text-lg font-semibold text-gray-900'>
                Team Collaboration
              </h2>
              <p className='mt-1 text-sm text-gray-500'>
                Invite teammates to manage assets with you. Free tier supports up
                to {TEAM_LIMIT} members. Go Pro anytime to unlock more seats.
              </p>
            </div>

            <div className='px-6 py-6'>
              <div className='mb-6'>
                <h3 className='text-sm font-semibold uppercase tracking-wide text-gray-500'>
                  Current Members ({teamMembers.length}/{TEAM_LIMIT} Free)
                </h3>
                {teamMembers.length === 0 ? (
                  <p className='mt-2 text-sm text-gray-500'>
                    You haven&apos;t invited anyone yet. Add up to two teammates on
                    this plan.
                  </p>
                ) : (
                  <ul className='mt-3 space-y-2'>
                    {teamMembers.map((member) => (
                      <li
                        key={member}
                        className='rounded-md border border-gray-100 bg-gray-50 px-4 py-2 text-sm text-gray-700'
                      >
                        {member}
                      </li>
                    ))}
                  </ul>
                )}
              </div>

              <form onSubmit={handleInviteSubmit} className='space-y-4'>
                <div>
                  <label
                    htmlFor='invite-email'
                    className='block text-sm font-medium text-gray-700'
                  >
                    Invite by email
                  </label>
                  <input
                    id='invite-email'
                    type='email'
                    value={inviteEmail}
                    onChange={(event) => setInviteEmail(event.target.value)}
                    placeholder='teammate@email.com'
                    className='mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500'
                  />
                </div>

                {inviteError && (
                  <p className='text-sm text-red-600'>{inviteError}</p>
                )}
                {inviteFeedback && (
                  <p className='text-sm text-green-600'>{inviteFeedback}</p>
                )}

                <div className='flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between'>
                  <button
                    type='submit'
                    disabled={isFreeTierLimitReached}
                    className={`inline-flex items-center justify-center rounded-md px-4 py-2 text-sm font-semibold text-white shadow-sm transition ${
                      isFreeTierLimitReached
                        ? 'cursor-not-allowed bg-gray-300'
                        : 'bg-blue-600 hover:bg-blue-700'
                    }`}
                  >
                    Add User
                  </button>
                  <button
                    type='button'
                    onClick={() => { setPrevProState({ ai: proAiEnabled, cloud: cloudBackupEnabled }); setProModalSource('cta'); setIsProModalOpen(true); }}
                    className='inline-flex items-center justify-center rounded-md border border-blue-600 px-4 py-2 text-sm font-semibold text-blue-600 transition hover:bg-blue-50'
                  >
                    Go Pro
                  </button>
                </div>
              </form>
            </div>
          </section>

          <p className='mt-8 text-sm text-gray-500'>
            These previews help us tailor the Pro roadmap. We&apos;ll notify you
            the moment these upgrades go live in your workspace.
          </p>
        </div>
      </div>

      {isProModalOpen && (
        <div className='fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 px-4'>
          <div className='w-full max-w-lg rounded-lg bg-white p-8 shadow-xl'>
            <div className='mb-6 text-center'>
              <h2 className='text-2xl font-bold text-gray-900'>
                Unlock Pro Features
              </h2>
              <p className='mt-3 text-gray-600'>
                Go Pro to leverage the full power of AI for ultimate asset
                management efficiency.
              </p>
            </div>
            <ul className='space-y-3 text-gray-700'>
              <li>
                <strong>AI Auto-Tagging</strong> from images/receipts.
              </li>
              <li>
                <strong>Proactive Maintenance</strong> schedules.
              </li>
              <li>
                <strong>Financial Depreciation</strong> narrative reports.
              </li>
            </ul>
            <div className='mt-8 flex flex-col-reverse gap-3 sm:flex-row sm:justify-end'>
              <button
                type='button'
                onClick={() => {
                  // Revert any Pro toggles that were turned on when opening the modal
                  setProAiEnabled(prevProState.ai);
                  setCloudBackupEnabled(prevProState.cloud);
                  setIsProModalOpen(false);
                  setProModalSource(null);
                }}
                className='rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100'
              >
                Not Now
              </button>
              <button
                type='button'
                onClick={() => {
                  setIsProModalOpen(false);
                  router.push('/asset-manager-pro');
                }}
                className='rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-blue-700'
              >
                Upgrade to Pro Now!
              </button>
            </div>
          </div>
        </div>
      )}
    </Layout>
  );
};

export default SettingsPage;
=== File End: app/settings/page.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: components/ProtectedRoute.tsx ===

=== File End: components/ProtectedRoute.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: components/layout/Layout.tsx ===
// src/components/Layout/Layout.tsx
'use client'

import React from 'react'
import Navigation from './Navigation'

interface LayoutProps {
  children: React.ReactNode
}

const Layout: React.FC<LayoutProps> = ({ children }) => {
  return (
    <div className="min-h-screen bg-gray-100">
      <Navigation />
      <main>{children}</main>
    </div>
  )
}

export default Layout
=== File End: components/layout/Layout.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: components/layout/Navigation.tsx ===
// src/components/Layout/Navigation.tsx
'use client';

import React, { useEffect, useRef, useState } from 'react';
import Link from 'next/link';
import { useRouter, usePathname } from 'next/navigation';
import { useAuth } from '../../contexts/AuthContext';
import { useCart } from '../../contexts/CartContext';

const THEME_STORAGE_KEY = 'assetmanagement-theme';

const Navigation: React.FC = () => {
  const { currentUser, logout } = useAuth();
  const { cartTotal } = useCart();
  const router = useRouter();
  const pathname = usePathname();
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [isProfileMenuOpen, setIsProfileMenuOpen] = useState(false);
  const [isDarkMode, setIsDarkMode] = useState(false);
  const profileMenuRef = useRef<HTMLDivElement | null>(null);

  const applyTheme = (preferDark: boolean) => {
    if (typeof window === 'undefined') {
      return;
    }

    const root = window.document.documentElement;
    if (preferDark) {
      root.classList.add('dark');
      window.localStorage.setItem(THEME_STORAGE_KEY, 'dark');
    } else {
      root.classList.remove('dark');
      window.localStorage.setItem(THEME_STORAGE_KEY, 'light');
    }
    setIsDarkMode(preferDark);
  };

  useEffect(() => {
    if (typeof window === 'undefined') {
      return;
    }

    const storedTheme = window.localStorage.getItem(THEME_STORAGE_KEY);
    const prefersDark = storedTheme
      ? storedTheme === 'dark'
      : window.matchMedia('(prefers-color-scheme: dark)').matches;

    applyTheme(prefersDark);
  }, []);

  useEffect(() => {
    setIsMenuOpen(false);
    setIsProfileMenuOpen(false);
  }, [pathname]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        profileMenuRef.current &&
        !profileMenuRef.current.contains(event.target as Node)
      ) {
        setIsProfileMenuOpen(false);
      }
    };

    if (isProfileMenuOpen) {
      window.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      window.removeEventListener('mousedown', handleClickOutside);
    };
  }, [isProfileMenuOpen]);

  const handleLogout = async () => {
    try {
      await logout();
      router.push('/login');
    } catch (error) {
      console.error('Failed to log out:', error);
    }
  };

  const navigation = [
    { name: 'Dashboard', href: '/dashboard', current: pathname === '/dashboard' },
    { name: 'My Assets', href: '/home', current: pathname === '/home' },
    { name: 'Calendar', href: '/calender', current: pathname === '/calender' },
    { name: 'Blog', href: '/blog', current: pathname.startsWith('/blog') },
    {
      name: 'Asset Manager Pro',
      href: '/asset-manager-pro',
      current: pathname === '/asset-manager-pro',
    },
    { name: 'Cart', href: '/cart', current: pathname === '/cart' },
    { name: 'My Orders', href: '/myorders', current: pathname === '/myorders' },
    { name: 'Settings', href: '/settings', current: pathname === '/settings' },
  ];

  const handleThemeToggle = () => {
    applyTheme(!isDarkMode);
  };

  const userLabel =
    currentUser?.DisplayName?.trim() || currentUser?.Email || '';

  return (
    <nav className='bg-white shadow-lg dark:bg-gray-900'>
      <div className='mx-auto max-w-7xl px-4'>
        <div className='flex h-16 justify-between'>
          <div className='flex items-center'>
            <div className='flex flex-shrink-0 items-center'>
              <Link
                href='/'
                className='text-xl font-bold text-blue-600 transition hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300'
              >
                Asset Tracker
              </Link>
            </div>

            <div className='hidden md:ml-6 md:flex md:space-x-4'>
              {navigation.map((item) => (
                <button
                  key={item.name}
                  onClick={() => router.push(item.href)}
                  className={`inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium ${
                    item.current
                      ? 'border-blue-500 text-gray-900 dark:text-gray-100'
                      : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-100'
                  }`}
                >
                  {item.name}
                  {item.name === 'Cart' && cartTotal > 0 && (
                    <span className='ml-2 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-xs text-white'>
                      {cartTotal}
                    </span>
                  )}
                </button>
              ))}
            </div>
          </div>

          <div className='hidden items-center space-x-4 md:flex'>
            {/* Notifications */}
            <button
              type='button'
              onClick={() => router.push('/dashboard')}
              className='relative p-2 text-gray-600 hover:text-blue-600 dark:text-gray-300 dark:hover:text-blue-400'
              aria-label='Open notifications'
              title='Notifications'
            >
              <svg
                className='h-6 w-6'
                fill='none'
                stroke='currentColor'
                viewBox='0 0 24 24'
              >
                <path
                  strokeLinecap='round'
                  strokeLinejoin='round'
                  strokeWidth={2}
                  d='M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V4a2 2 0 10-4 0v1.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9'
                />
              </svg>
              <span className='absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-xs text-white'>
                3
              </span>
            </button>

            {/* Information */}
            <button
              type='button'
              className='p-2 text-gray-600 hover:text-blue-600 dark:text-gray-300 dark:hover:text-blue-400'
              aria-label='Information'
              title='Information'
            >
              <svg
                className='h-6 w-6'
                fill='none'
                stroke='currentColor'
                viewBox='0 0 24 24'
              >
                <path
                  strokeLinecap='round'
                  strokeLinejoin='round'
                  strokeWidth={2}
                  d='M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z'
                />
              </svg>
            </button>

            <button
              type='button'
              onClick={() => router.push('/cart')}
              className='relative p-2 text-gray-600 hover:text-blue-600 dark:text-gray-300 dark:hover:text-blue-400'
              aria-label='Open cart'
            >
              <svg
                className='h-6 w-6'
                fill='none'
                stroke='currentColor'
                viewBox='0 0 24 24'
              >
                <path
                  strokeLinecap='round'
                  strokeLinejoin='round'
                  strokeWidth={2}
                  d='M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5.5M7 13l2.5 5.5m0 0L17 21'
                />
              </svg>
              {cartTotal > 0 && (
                <span className='absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-xs text-white'>
                  {cartTotal}
                </span>
              )}
            </button>
            <span className='text-gray-700 dark:text-gray-200'>
              {userLabel}
            </span>
            <div className='relative' ref={profileMenuRef}>
              <button
                type='button'
                onClick={() => setIsProfileMenuOpen((value) => !value)}
                className='flex h-9 w-9 items-center justify-center rounded-full border border-gray-200 bg-white text-gray-600 shadow-sm transition hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700'
                aria-haspopup='menu'
                aria-expanded={isProfileMenuOpen}
                aria-label='Open profile menu'
              >
                <svg
                  xmlns='http://www.w3.org/2000/svg'
                  viewBox='0 0 24 24'
                  fill='none'
                  stroke='currentColor'
                  strokeWidth={1.5}
                  strokeLinecap='round'
                  strokeLinejoin='round'
                  className='h-5 w-5'
                >
                  <path d='M16.5 7a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z' />
                  <path d='M4.5 20.25a8.75 8.75 0 0115 0' />
                </svg>
              </button>

              {isProfileMenuOpen && (
                <div
                  role='menu'
                  className='absolute right-0 z-20 mt-2 w-48 rounded-lg border border-gray-100 bg-white py-2 shadow-lg ring-1 ring-black ring-opacity-5 dark:border-gray-700 dark:bg-gray-800'
                >
                  <button
                  onClick={() => {
                    setIsProfileMenuOpen(false);
                    router.push('/profile');
                  }}
                    className='flex w-full items-center px-4 py-2 text-sm text-gray-700 transition hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-700'
                    role='menuitem'
                  >
                    <span className='mr-3 inline-flex h-6 w-6 items-center justify-center rounded-full bg-blue-50 text-blue-600 dark:bg-blue-900 dark:text-blue-200'>
                      <svg
                        xmlns='http://www.w3.org/2000/svg'
                        viewBox='0 0 24 24'
                        fill='none'
                        stroke='currentColor'
                        strokeWidth={1.5}
                        strokeLinecap='round'
                        strokeLinejoin='round'
                        className='h-4 w-4'
                      >
                        <path d='M16 7a4 4 0 11-8 0 4 4 0 018 0z' />
                        <path d='M12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' />
                      </svg>
                    </span>
                    Profile
                  </button>
                  <button
                  onClick={() => {
                    setIsProfileMenuOpen(false);
                    router.push('/payment');
                  }}
                    className='flex w-full items-center px-4 py-2 text-sm text-gray-700 transition hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-700'
                    role='menuitem'
                  >
                    <span className='mr-3 inline-flex h-6 w-6 items-center justify-center rounded-full bg-green-50 text-green-600 dark:bg-green-900 dark:text-green-200'>
                      <svg
                        xmlns='http://www.w3.org/2000/svg'
                        viewBox='0 0 24 24'
                        fill='none'
                        stroke='currentColor'
                        strokeWidth={1.5}
                        strokeLinecap='round'
                        strokeLinejoin='round'
                        className='h-4 w-4'
                      >
                        <path d='M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4' />
                        <polyline points='7 10 12 15 17 10' />
                        <line x1='12' y1='15' x2='12' y2='3' />
                      </svg>
                    </span>
                    Payment
                  </button>
                  <button
                    onClick={() => {
                      handleThemeToggle();
                      setIsProfileMenuOpen(false);
                    }}
                    className='flex w-full items-center justify-between px-4 py-2 text-sm text-gray-700 transition hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-700'
                    role='menuitem'
                  >
                    <span className='flex items-center'>
                      <span className='mr-3 inline-flex h-6 w-6 items-center justify-center rounded-full bg-blue-50 text-blue-600 dark:bg-blue-900 dark:text-blue-200'>
                        <svg
                          xmlns='http://www.w3.org/2000/svg'
                          viewBox='0 0 24 24'
                          fill='none'
                          stroke='currentColor'
                          strokeWidth={1.5}
                          strokeLinecap='round'
                          strokeLinejoin='round'
                          className='h-4 w-4'
                        >
                          <path d='M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z' />
                        </svg>
                      </span>
                      {isDarkMode ? 'Light Mode' : 'Dark Mode'}
                    </span>
                  </button>
                  <button
                    onClick={handleLogout}
                    className='flex w-full items-center px-4 py-2 text-sm text-gray-700 transition hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-700'
                    role='menuitem'
                  >
                    <span className='mr-3 inline-flex h-6 w-6 items-center justify-center rounded-full bg-red-50 text-red-500 dark:bg-red-900 dark:text-red-200'>
                      <svg
                        xmlns='http://www.w3.org/2000/svg'
                        fill='none'
                        viewBox='0 0 24 24'
                        strokeWidth={1.5}
                        stroke='currentColor'
                        strokeLinecap='round'
                        strokeLinejoin='round'
                        className='h-4 w-4'
                      >
                        <path d='M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6A2.25 2.25 0 005.25 5.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15' />
                        <path d='M12 9l3 3m0 0l-3 3m3-3H3' />
                      </svg>
                    </span>
                    Logout
                  </button>
                </div>
              )}
            </div>
          </div>

          {/* Mobile menu button */}
          <div className='flex items-center md:hidden'>
            <button
              onClick={() => setIsMenuOpen(!isMenuOpen)}
              className='inline-flex items-center justify-center rounded-md p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 dark:text-gray-300 dark:hover:bg-gray-800 dark:hover:text-gray-100'
            >
              <svg
                className='h-6 w-6'
                stroke='currentColor'
                fill='none'
                viewBox='0 0 24 24'
              >
                <path
                  strokeLinecap='round'
                  strokeLinejoin='round'
                  strokeWidth='2'
                  d='M4 6h16M4 12h16M4 18h16'
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      {/* Mobile menu */}
      {isMenuOpen && (
        <div className='md:hidden'>
          <div className='space-y-1 px-2 pt-2 pb-3 sm:px-3'>
            {navigation.map((item) => (
              <button
                key={item.name}
                onClick={() => {
                  router.push(item.href);
                  setIsMenuOpen(false);
                }}
                className={`block w-full border-l-4 py-2 pl-3 pr-4 text-left text-base font-medium ${
                  item.current
                    ? 'border-blue-500 bg-blue-50 text-blue-700 dark:border-blue-400 dark:bg-gray-800 dark:text-blue-200'
                    : 'border-transparent text-gray-500 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-700 dark:text-gray-300 dark:hover:bg-gray-800 dark:hover:text-gray-100'
                }`}
              >
                {item.name}
                {item.name === 'Cart' && cartTotal > 0 && (
                  <span className='ml-2 inline-flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-xs text-white'>
                    {cartTotal}
                  </span>
                )}
              </button>
            ))}
            <div className='border-t border-gray-200 pt-4 pb-3 dark:border-gray-700'>
              <div className='px-4'>
                <div className='text-base font-medium text-gray-800 dark:text-gray-200'>
                  {userLabel}
                </div>
              </div>
              <div className='mt-3 space-y-1 px-2'>
              <button
                onClick={() => {
                  router.push('/profile');
                  setIsMenuOpen(false);
                }}
                  className='block w-full rounded-md px-3 py-2 text-left text-base text-gray-600 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-200 dark:hover:bg-gray-800 dark:hover:text-gray-100'
                >
                  Profile
                </button>
                <button
                  onClick={() => {
                    router.push('/payment');
                    setIsMenuOpen(false);
                  }}
                  className='block w-full rounded-md px-3 py-2 text-left text-base text-gray-600 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-200 dark:hover:bg-gray-800 dark:hover:text-gray-100'
                >
                  Payment
                </button>
                <button
                  onClick={() => {
                    handleThemeToggle();
                    setIsMenuOpen(false);
                  }}
                  className='block w-full rounded-md px-3 py-2 text-left text-base text-gray-600 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-200 dark:hover:bg-gray-800 dark:hover:text-gray-100'
                >
                  {isDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
                </button>
                <button
                  onClick={() => {
                    handleLogout();
                    setIsMenuOpen(false);
                  }}
                  className='block w-full rounded-md px-3 py-2 text-left text-base text-gray-600 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-200 dark:hover:bg-gray-800 dark:hover:text-gray-100'
                >
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </nav>
  );
};

export default Navigation;
=== File End: components/layout/Navigation.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: contexts/AuthContext.tsx ===
// src/contexts/AuthContext.tsx
'use client'

import React, { createContext, useContext, useState, useEffect } from 'react'
import { 
  signInWithEmailAndPassword, 
  createUserWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
  GoogleAuthProvider,
  signInWithPopup,
  updateProfile
} from 'firebase/auth'
import { auth, db } from '../lib/firebase'
import { ref, set, get, update } from 'firebase/database'
import { User } from '../models/User'

interface AuthContextType {
  currentUser: User | null
  login: (email: string, password: string) => Promise<any>
  signup: (email: string, password: string) => Promise<any>
  logout: () => Promise<void>
  googleSignIn: () => Promise<any>
  updateProfileDetails: (updates: Partial<User>) => Promise<void>
  loading: boolean
}

const AuthContext = createContext<AuthContextType | undefined>(undefined)

export const useAuth = () => {
  const context = useContext(AuthContext)
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider')
  }
  return context
}

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [currentUser, setCurrentUser] = useState<User | null>(null)
  const [loading, setLoading] = useState(true)

  const signup = async (email: string, password: string) => {
    const result = await createUserWithEmailAndPassword(auth, email, password)
    const user: User = {
      UserId: result.user.uid,
      Email: result.user.email!,
      DisplayName: result.user.displayName || '',
      PhotoURL: result.user.photoURL || ''
    }
    
    await set(ref(db, 'users/' + result.user.uid), user)
    return result
  }

  const login = (email: string, password: string) => {
    return signInWithEmailAndPassword(auth, email, password)
  }

  const googleSignIn = async () => {
    const provider = new GoogleAuthProvider()
    const result = await signInWithPopup(auth, provider)
    
    const user: User = {
      UserId: result.user.uid,
      Email: result.user.email!,
      DisplayName: result.user.displayName || '',
      PhotoURL: result.user.photoURL || ''
    }
    
    const userRef = ref(db, 'users/' + result.user.uid)
    const snapshot = await get(userRef)
    if (!snapshot.exists()) {
      await set(userRef, user)
    }
    
    return result
  }

  const logout = () => {
    return signOut(auth)
  }

  const updateProfileDetails = async (updates: Partial<User>) => {
    if (!auth.currentUser) {
      throw new Error('No authenticated user found')
    }

    const allowedKeys: (keyof User)[] = [
      'DisplayName',
      'PhotoURL',
      'Phone',
      'Address',
      'City',
      'State',
      'Zip',
    ]

    const payload: Partial<User> = {}
    for (const key of allowedKeys) {
      if (Object.prototype.hasOwnProperty.call(updates, key)) {
        const value = updates[key]
        if (value !== undefined) {
          payload[key] = value
        }
      }
    }

    if (Object.keys(payload).length === 0) {
      return
    }

    const userRef = ref(db, `users/${auth.currentUser.uid}`)
    await update(userRef, payload)

    const profileUpdates: { displayName?: string | null; photoURL?: string | null } = {}
    if (payload.DisplayName !== undefined) {
      profileUpdates.displayName = payload.DisplayName || null
    }
    if (payload.PhotoURL !== undefined) {
      profileUpdates.photoURL = payload.PhotoURL || null
    }
    if (Object.keys(profileUpdates).length > 0) {
      await updateProfile(auth.currentUser, profileUpdates)
    }

    setCurrentUser((prev) => (prev ? { ...prev, ...payload } : prev))
  }

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userRef = ref(db, 'users/' + user.uid)
        const snapshot = await get(userRef)
        if (snapshot.exists()) {
          setCurrentUser(snapshot.val())
        }
      } else {
        setCurrentUser(null)
      }
      setLoading(false)
    })

    return unsubscribe
  }, [])

  const value = {
    currentUser,
    login,
    signup,
    logout,
    googleSignIn,
    updateProfileDetails,
    loading
  }

  return (
    <AuthContext.Provider value={value}>
      {!loading && children}
    </AuthContext.Provider>
  )
}
=== File End: contexts/AuthContext.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: contexts/CartContext.tsx ===
// src/contexts/CartContext.tsx
'use client'

import React, { createContext, useContext, useState, useEffect } from 'react'
import { CartItem } from '../models/Cart'

interface CartContextType {
  cartItems: CartItem[]
  cartTotal: number
  addToCart: (item: CartItem) => void
  removeFromCart: (productId: string) => void
  updateCart: (item: CartItem) => void
  clearCart: () => void
}

const CartContext = createContext<CartContextType | undefined>(undefined)

export const useCart = () => {
  const context = useContext(CartContext)
  if (context === undefined) {
    throw new Error('useCart must be used within a CartProvider')
  }
  return context
}

export const CartProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [cartItems, setCartItems] = useState<CartItem[]>([])

  useEffect(() => {
    const savedCart = localStorage.getItem('cartItems')
    if (savedCart) {
      setCartItems(JSON.parse(savedCart))
    }
  }, [])

  useEffect(() => {
    localStorage.setItem('cartItems', JSON.stringify(cartItems))
  }, [cartItems])

  const addToCart = (item: CartItem) => {
    setCartItems(prev => {
      const existingItem = prev.find(i => i.Product_id === item.Product_id)
      if (existingItem) {
        return prev.map(i =>
          i.Product_id === item.Product_id
            ? { ...i, Count: i.Count + 1, TotalPrice: parseFloat(i.UnitPrice) * (i.Count + 1) }
            : i
        )
      }
      return [...prev, { ...item, TotalPrice: parseFloat(item.UnitPrice) * item.Count }]
    })
  }

  const removeFromCart = (productId: string) => {
    setCartItems(prev => prev.filter(item => item.Product_id !== productId))
  }

  const updateCart = (updatedItem: CartItem) => {
    setCartItems(prev =>
      prev.map(item =>
        item.Product_id === updatedItem.Product_id ? updatedItem : item
      )
    )
  }

  const clearCart = () => {
    setCartItems([])
  }

  const cartTotal = cartItems.reduce((total, item) => total + item.Count, 0)

  const value = {
    cartItems,
    cartTotal,
    addToCart,
    removeFromCart,
    updateCart,
    clearCart
  }

  return (
    <CartContext.Provider value={value}>
      {children}
    </CartContext.Provider>
  )
}
=== File End: contexts/CartContext.tsx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: hooks/useAuth.tx ===

=== File End: hooks/useAuth.tx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: hooks/useCart.tx ===

=== File End: hooks/useCart.tx ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: lib/duckdb.ts ===
'use client';

// DuckDB-WASM client service for browser usage in Next.js.
// Similar in spirit to src/lib/firebase.ts, this exposes
// a singleton initializer plus small helpers to connect and query.

import type * as DuckDBNS from '@duckdb/duckdb-wasm';

let duckdbModulePromise: Promise<typeof DuckDBNS> | null = null;
let duckdbInstancePromise: Promise<DuckDBNS.AsyncDuckDB> | null = null;
let duckdbConnectionPromise: Promise<DuckDBNS.AsyncDuckDBConnection> | null = null;

async function loadDuckDBModule() {
  if (duckdbModulePromise) return duckdbModulePromise;
  duckdbModulePromise = import('@duckdb/duckdb-wasm');
  return duckdbModulePromise;
}

export async function getDuckDB(): Promise<DuckDBNS.AsyncDuckDB> {
  if (typeof window === 'undefined') {
    throw new Error('DuckDB-WASM is only available in the browser');
  }
  if (duckdbInstancePromise) return duckdbInstancePromise;

  duckdbInstancePromise = (async () => {
    const duckdb = await loadDuckDBModule();

    // Prefer CDN bundles for simplicity and zero-config asset hosting.
    // You can switch to `duckdb.getBundledBundles()` if hosting assets locally.
    const bundles = duckdb.getJsDelivrBundles();
    const bundle = await duckdb.selectBundle(bundles);

    const worker = new Worker(bundle.mainWorker, { type: 'module' });
    const logger = new duckdb.ConsoleLogger();
    const db = new duckdb.AsyncDuckDB(logger, worker);
    await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
    return db;
  })();

  return duckdbInstancePromise;
}

export async function getConnection(): Promise<DuckDBNS.AsyncDuckDBConnection> {
  if (duckdbConnectionPromise) return duckdbConnectionPromise;
  duckdbConnectionPromise = (async () => {
    const db = await getDuckDB();
    return db.connect();
  })();
  return duckdbConnectionPromise;
}

// Simple helpers
export async function query(sql: string) {
  const conn = await getConnection();
  return conn.query(sql);
}

export async function queryObjects<T = Record<string, unknown>>(sql: string): Promise<T[]> {
  const table = await query(sql);
  // DuckDB-WASM returns an Arrow-style table with toArray() for row objects
  // in recent versions. If unavailable, consumers can work with the table API directly.
  // @ts-ignore - depending on version, toArray is available at runtime
  const rows = table?.toArray ? table.toArray() : [];
  return rows as T[];
}

// Register a CSV/Parquet/etc. file from a URL into the virtual FS, then query it.
export async function registerFileFromUrl(url: string, vfsPath?: string) {
  const db = await getDuckDB();
  const name = vfsPath || url.split('/').pop() || 'file.bin';
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Failed to fetch ${url}`);
  const buf = new Uint8Array(await res.arrayBuffer());
  await db.registerFileBuffer(name, buf);
  return name;
}

export async function importCsvFromUrl(url: string, tableName: string) {
  const vfsName = await registerFileFromUrl(url);
  const conn = await getConnection();
  // Use DuckDB's auto-detect CSV loader
  await conn.query(`CREATE OR REPLACE TABLE ${tableName} AS SELECT * FROM read_csv_auto('${vfsName}')`);
}

// Reset helpers (useful for development/testing)
export async function resetDuckDB() {
  if (duckdbConnectionPromise) {
    const conn = await duckdbConnectionPromise;
    try {
      await conn.close();
    } catch {}
  }
  duckdbConnectionPromise = null;
  duckdbInstancePromise = null;
}

// Example usage (client components only):
//   import { getConnection, queryObjects } from '@/lib/duckdb';
//   const rows = await queryObjects('SELECT 42 AS answer');
//   console.log(rows); // [{ answer: 42 }]
=== File End: lib/duckdb.ts ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: lib/firebase.ts ===
// src/lib/firebase.ts
import { initializeApp } from 'firebase/app'
import { getAuth } from 'firebase/auth'
import { getDatabase } from 'firebase/database'
import { getStorage } from 'firebase/storage'

const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  databaseURL: process.env.NEXT_PUBLIC_FIREBASE_DATABASE_URL,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
}

const app = initializeApp(firebaseConfig)
export const auth = getAuth(app)
export const db = getDatabase(app)
export const storage = getStorage(app)
export default app
=== File End: lib/firebase.ts ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: models/Cart.ts ===
// src/models/Cart.ts
export interface CartItem {
  Product_id: string
  Name: string
  Description: string
  Thumb: string
  Count: number
  UnitPrice: string
  TotalPrice: number
  key?: string
}
=== File End: models/Cart.ts ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: models/Group.ts ===
// src/models/Group.ts
export interface GroupAdmin {
  AdminId: string;
  Email: string;
  DisplayName?: string;
  PhotoURL?: string;
}

export interface GroupMember {
  UserId: string;
  Email: string;
  DisplayName?: string;
  JoinedAt?: string;
}

export interface Group {
  GroupId: string;
  Name?: string;
  Admin: GroupAdmin;
  Members: GroupMember[];
  CreatedAt?: string;
  UpdatedAt?: string;
}
=== File End: models/Group.ts ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: models/User.ts ===
// src/models/User.ts
export interface User {
  UserId: string
  Email: string
  DisplayName: string
  PhotoURL: string
  Phone?: string
  Address?: string
  City?: string
  State?: string
  Zip?: string
}
=== File End: models/User.ts ===
********************
********************
********************
********************
********************

********************
********************
********************
********************
********************
=== File Start: models/Vehicle.ts ===
// src/models/Vehicle.ts
export interface Vehicle {
  key?: string
  UserId?: string
  make?: string
  model?: string
  year?: number
  color?: string
  vin?: string
  plate?: string
  tires?: string
  tireSize?: string
  tirePressure?: string
  oilType?: string
  warranty?: boolean
  warrantyNumber?: string
  warrantyPhone?: string
  warrantyNotes?: string
  warrantyExpiry?: Date | string
  purchaseDate?: Date
  parcelNumber?: string
  category?: string
  description?: string
  notes?: string
  // Insurance details
  insurancePolicyNumber?: string
  insuranceCompany?: string
  insuranceExpirationDate?: Date | string
  videos?: Video[]
  odometer?: Odometer[]
  oilChange?: OilChange[]
  partNumber?: Part[]
  tools?: Tool[]
  maintenance?: Maintenance[]
}

export interface Video {
  name?: string
  url?: string
}

export interface Odometer {
  odometer?: number
  type?: string
  date?: Date
  reading?: Date
}

export interface OilChange {
  date?: Date | string
  odometer?: number
}

export interface Part {
  part?: string
  type?: string
  url?: string
  date?: Date | string
  description?: string
  note?: string
}

export interface Tool {
  name?: string
  description?: string
}

export interface Maintenance {
  maintenanceType?: string
  maintenanceEndDate?: Date | string
  maintenanceDesc?: string
}
=== File End: models/Vehicle.ts ===
********************
********************
********************
********************
********************

--- END OF FILES ---

````
